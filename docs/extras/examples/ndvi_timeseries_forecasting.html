<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>NDVI Timeseries Forecasting with Prithvi</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">GEOG 288KC</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">üè† home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Syllabus.html"> 
<span class="menu-text">üìã syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-sessions" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üíª weekly sessions</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-weekly-sessions">    
        <li>
    <a class="dropdown-item" href="../../chapters/c01-geospatial-data-foundations.html">
 <span class="dropdown-text">Week 1 - üöÄ Core Tools and Data Access</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c02-spatial-temporal-attention-mechanisms.html">
 <span class="dropdown-text">Week 2 - ‚ö° Rapid Remote Sensing Preprocessing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c03a-terratorch-foundations.html">
 <span class="dropdown-text">Week 3a - üåç TerraTorch Foundations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c03-complete-gfm-architecture.html">
 <span class="dropdown-text">Week 3b - ü§ñ Machine Learning on Remote Sensing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c04-pretraining-implementation.html">
 <span class="dropdown-text">Week 4 - üèóÔ∏è Foundation Models in Practice</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c05-training-loop-optimization.html">
 <span class="dropdown-text">Week 5 - üîß Fine-Tuning &amp; Transfer Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c06-model-evaluation-analysis.html">
 <span class="dropdown-text">Week 6 - ‚è∞ Spatiotemporal Modeling &amp; Projects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/terratorch_finetuning_workflow.html">
 <span class="dropdown-text">Week 7 - ‚ö° TerraTorch + Lightning Fine-Tuning Workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cheatsheets" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üëÄ cheatsheets</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-cheatsheets">    
        <li>
    <a class="dropdown-item" href="../../cheatsheets.html">
 <span class="dropdown-text">üìã All Cheatsheets</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">‚ö° Quick Starts</li>
        <li>
    <a class="dropdown-item" href="../../extras/cheatsheets/week01_imports.html">
 <span class="dropdown-text">Week 01: Import Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/cheatsheets/dataset_organization_terratorch.html">
 <span class="dropdown-text">Dataset Organization for Fine-Tuning</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-explainers" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üß© explainers</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-explainers">    
        <li class="dropdown-header">1Ô∏è‚É£ Week 1</li>
        <li>
    <a class="dropdown-item" href="../../extras/ai-ml-dl-fm-hierarchy.html">
 <span class="dropdown-text">ü§ñ AI/ML/DL/FM Hierarchy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/geospatial-foundation-model-predictions-standalone.html">
 <span class="dropdown-text">üéØ GFM Predictions (Standalone)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/geospatial-prediction-hierarchy.html">
 <span class="dropdown-text">‚úÖ Geospatial Task/Prediction Types</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/neural_networks_explainer.html">
 <span class="dropdown-text">üß† Neural Networks: Neurons to Transformers</span></a>
  </li>  
        <li class="dropdown-header">2Ô∏è‚É£ Week 2</li>
        <li>
    <a class="dropdown-item" href="../../chapters/c00a-foundation_model_architectures.html">
 <span class="dropdown-text">üèóÔ∏è Foundation Model Architectures</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c00b-introduction-to-deeplearning-architecture.html">
 <span class="dropdown-text">üéì Introduction to Deep Learning Architecture</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-extras" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üìñ extras</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-extras">    
        <li class="dropdown-header">üéØ Practical Examples</li>
        <li>
    <a class="dropdown-item" href="../../extras/examples/normalization_comparison.html">
 <span class="dropdown-text">Normalization Comparison</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/resnet.html">
 <span class="dropdown-text">ResNet Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/segmentation_finetuning.html">
 <span class="dropdown-text">Segmentation Fine-Tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/Terramind_EuroSAT.html">
 <span class="dropdown-text">TerraMind EuroSAT Classification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/terratorch_finetuning_workflow.html">
 <span class="dropdown-text">TerraTorch Fine-Tuning Workflow</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/text_encoder.html">
 <span class="dropdown-text">Text Encoder</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/tiling-and-patches.html">
 <span class="dropdown-text">Tiling and Patches</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/terratorch_workflows.html">
 <span class="dropdown-text">TerraTorch Workflows</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/resources/course_resources.html">
 <span class="dropdown-text">üìö Reference Materials</span></a>
  </li>  
        <li class="dropdown-header">üìÅ Project Templates</li>
        <li>
    <a class="dropdown-item" href="../../extras/projects/project-proposal-template.html">
 <span class="dropdown-text">Project Proposal Template</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/projects/mvp-template.html">
 <span class="dropdown-text">Project Results Template</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gfms-from-scratch/gfms-from-scratch.github.io" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">NDVI Timeseries Forecasting with Prithvi</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead">Forward prediction of urban vegetation dynamics using geospatial foundation models</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#workflow-outline" id="toc-workflow-outline" class="nav-link" data-scroll-target="#workflow-outline">Workflow Outline</a>
  <ul class="collapse">
  <li><a href="#part-1-data-preparation" id="toc-part-1-data-preparation" class="nav-link" data-scroll-target="#part-1-data-preparation">Part 1: Data Preparation</a></li>
  <li><a href="#part-2-model-architecture-and-setup" id="toc-part-2-model-architecture-and-setup" class="nav-link" data-scroll-target="#part-2-model-architecture-and-setup">Part 2: Model Architecture and Setup</a></li>
  <li><a href="#part-3-model-training-and-fine-tuning" id="toc-part-3-model-training-and-fine-tuning" class="nav-link" data-scroll-target="#part-3-model-training-and-fine-tuning">Part 3: Model Training and Fine-Tuning</a></li>
  <li><a href="#part-4-inference-and-forecasting" id="toc-part-4-inference-and-forecasting" class="nav-link" data-scroll-target="#part-4-inference-and-forecasting">Part 4: Inference and Forecasting</a></li>
  <li><a href="#part-5-critical-implementation-considerations" id="toc-part-5-critical-implementation-considerations" class="nav-link" data-scroll-target="#part-5-critical-implementation-considerations">Part 5: Critical Implementation Considerations</a></li>
  </ul></li>
  <li><a href="#implementation-summary" id="toc-implementation-summary" class="nav-link" data-scroll-target="#implementation-summary">Implementation Summary</a>
  <ul class="collapse">
  <li><a href="#minimal-code-example" id="toc-minimal-code-example" class="nav-link" data-scroll-target="#minimal-code-example">Minimal Code Example</a></li>
  <li><a href="#key-hyperparameters" id="toc-key-hyperparameters" class="nav-link" data-scroll-target="#key-hyperparameters">Key Hyperparameters</a></li>
  <li><a href="#expected-results" id="toc-expected-results" class="nav-link" data-scroll-target="#expected-results">Expected Results</a></li>
  </ul></li>
  <li><a href="#next-steps-and-extensions" id="toc-next-steps-and-extensions" class="nav-link" data-scroll-target="#next-steps-and-extensions">Next Steps and Extensions</a>
  <ul class="collapse">
  <li><a href="#advanced-topics" id="toc-advanced-topics" class="nav-link" data-scroll-target="#advanced-topics">Advanced Topics</a></li>
  <li><a href="#alternative-approaches" id="toc-alternative-approaches" class="nav-link" data-scroll-target="#alternative-approaches">Alternative Approaches</a></li>
  <li><a href="#production-deployment" id="toc-production-deployment" class="nav-link" data-scroll-target="#production-deployment">Production Deployment</a></li>
  </ul></li>
  <li><a href="#references-and-resources" id="toc-references-and-resources" class="nav-link" data-scroll-target="#references-and-resources">References and Resources</a></li>
  <li><a href="#appendix-code-stubs" id="toc-appendix-code-stubs" class="nav-link" data-scroll-target="#appendix-code-stubs">Appendix: Code Stubs</a>
  <ul class="collapse">
  <li><a href="#a.1-ndvi-computation-with-cloud-masking" id="toc-a.1-ndvi-computation-with-cloud-masking" class="nav-link" data-scroll-target="#a.1-ndvi-computation-with-cloud-masking">A.1 NDVI Computation with Cloud Masking</a></li>
  <li><a href="#a.2-temporal-dataset-for-pytorch" id="toc-a.2-temporal-dataset-for-pytorch" class="nav-link" data-scroll-target="#a.2-temporal-dataset-for-pytorch">A.2 Temporal Dataset for PyTorch</a></li>
  <li><a href="#a.3-temporal-smoothness-loss" id="toc-a.3-temporal-smoothness-loss" class="nav-link" data-scroll-target="#a.3-temporal-smoothness-loss">A.3 Temporal Smoothness Loss</a></li>
  <li><a href="#a.4-evaluation-metrics" id="toc-a.4-evaluation-metrics" class="nav-link" data-scroll-target="#a.4-evaluation-metrics">A.4 Evaluation Metrics</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This workflow demonstrates how to use Prithvi (or other geospatial foundation models) to forecast future NDVI values from satellite timeseries data. We‚Äôll focus on urban vegetation dynamics in Santa Barbara, using Sentinel-2 imagery to predict the next N timesteps of NDVI based on historical patterns.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>By the end of this tutorial, you will:</p>
<ol type="1">
<li>Construct NDVI timeseries from Sentinel-2 imagery</li>
<li>Prepare temporal data for foundation model input</li>
<li>Fine-tune Prithvi for temporal forecasting tasks</li>
<li>Generate forward predictions for vegetation dynamics</li>
<li>Validate predictions against held-out observations</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why NDVI Forecasting?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Urban vegetation forecasting has practical applications for:</p>
<ul>
<li><strong>Water management</strong>: Predict irrigation needs before drought stress appears</li>
<li><strong>Urban planning</strong>: Forecast seasonal greening/browning patterns</li>
<li><strong>Climate adaptation</strong>: Understand vegetation response to temperature and precipitation</li>
<li><strong>Ecosystem monitoring</strong>: Early detection of vegetation stress or change</li>
</ul>
<p>Prithvi‚Äôs pre-training on massive satellite archives gives it strong priors for Earth surface dynamics, making it well-suited for temporal prediction tasks.</p>
</div>
</div>
</section>
<section id="workflow-outline" class="level2">
<h2 class="anchored" data-anchor-id="workflow-outline">Workflow Outline</h2>
<section id="part-1-data-preparation" class="level3">
<h3 class="anchored" data-anchor-id="part-1-data-preparation">Part 1: Data Preparation</h3>
<section id="define-study-area-and-temporal-range" class="level4">
<h4 class="anchored" data-anchor-id="define-study-area-and-temporal-range">1.1 Define Study Area and Temporal Range</h4>
<p><strong>Key considerations</strong>: - Study area: Santa Barbara urban/natural interface (vegetation gradient) - Sentinel-2 resolution: 10m for RGB/NIR, 20m for red-edge bands - Temporal resolution: 5-day revisit (2 satellites), cloud filtering affects actual frequency - NDVI calculation: <code>(NIR - Red) / (NIR + Red)</code> using B08 (NIR) and B04 (Red)</p>
<p><strong>Code structure</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Santa Barbara bounding box</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>bbox <span class="op">=</span> [<span class="op">-</span><span class="fl">120.1</span>, <span class="fl">34.4</span>, <span class="op">-</span><span class="fl">119.6</span>, <span class="fl">34.5</span>]  <span class="co"># Focused on urban core</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Temporal range for training (e.g., 2023 full year)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>train_start <span class="op">=</span> <span class="st">"2023-01-01"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>train_end <span class="op">=</span> <span class="st">"2023-12-31"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast horizon (e.g., predict next 3 months)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>forecast_start <span class="op">=</span> <span class="st">"2024-01-01"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>forecast_end <span class="op">=</span> <span class="st">"2024-03-31"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="acquire-and-filter-sentinel-2-scenes" class="level4">
<h4 class="anchored" data-anchor-id="acquire-and-filter-sentinel-2-scenes">1.2 Acquire and Filter Sentinel-2 Scenes</h4>
<p><strong>Key considerations</strong>: - Cloud filtering: Max cloud cover threshold (10-20%) - Scene selection: Balance temporal coverage vs.&nbsp;data quality - Spatial consistency: Scenes from same UTM tile to avoid reprojection issues</p>
<p><strong>Implementation approach</strong>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for training scenes</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> search_sentinel2_scenes(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    date_range<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>train_start<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>train_end<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    cloud_cover_max<span class="op">=</span><span class="dv">15</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract NDVI-relevant bands (B04, B08) plus SCL for cloud masking</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> [<span class="st">'B04'</span>, <span class="st">'B08'</span>, <span class="st">'SCL'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="compute-ndvi-timeseries" class="level4">
<h4 class="anchored" data-anchor-id="compute-ndvi-timeseries">1.3 Compute NDVI Timeseries</h4>
<p><strong>Key considerations</strong>: - Cloud masking: Use Scene Classification Layer (SCL) to remove clouds/shadows - Temporal alignment: Resample to regular intervals (weekly or biweekly) - Spatial aggregation: Consider region-of-interest statistics vs.&nbsp;full spatial fields - Normalization: NDVI already bounded [-1, 1], but consider standardization</p>
<p><strong>Data structure</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Target: xarray DataArray with dimensions (time, y, x)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Shape example: (52, 512, 512) for weekly composites over 1 year</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>ndvi_cube <span class="op">=</span> compute_ndvi_timeseries(items, bbox, bands)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="part-2-model-architecture-and-setup" class="level3">
<h3 class="anchored" data-anchor-id="part-2-model-architecture-and-setup">Part 2: Model Architecture and Setup</h3>
<section id="prithvi-model-overview" class="level4">
<h4 class="anchored" data-anchor-id="prithvi-model-overview">2.1 Prithvi Model Overview</h4>
<p><strong>Key architecture points</strong>: - <strong>Base model</strong>: Vision Transformer (ViT) pre-trained on HLS (Harmonized Landsat-Sentinel) - <strong>Input</strong>: 6 bands (RGB + 3 red-edge) at 224√ó224 patches - <strong>Temporal capability</strong>: Can handle temporal stacks via channel concatenation or 3D convolution - <strong>Pre-training</strong>: Masked autoencoder (MAE) objective on satellite imagery</p>
<p><strong>Adaptation for NDVI forecasting</strong>: - <strong>Input modification</strong>: Single-band NDVI instead of 6-band reflectance - <strong>Temporal encoding</strong>: Stack past T timesteps as input channels - <strong>Output head</strong>: Regression head predicting next N timesteps - <strong>Architecture</strong>: Encoder (Prithvi frozen/fine-tuned) ‚Üí Temporal decoder ‚Üí Future NDVI</p>
</section>
<section id="terratorch-model-loading" class="level4">
<h4 class="anchored" data-anchor-id="terratorch-model-loading">2.2 TerraTorch Model Loading</h4>
<p><strong>Key considerations</strong>: - Model source: HuggingFace hub (<code>ibm-nasa-geospatial/Prithvi-100M</code>) - Task type: Pixel-wise regression (not classification) - Decoder choice: Simple conv decoder for single-band output</p>
<p><strong>Implementation approach</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.models <span class="im">import</span> EncoderDecoderFactory</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Prithvi encoder</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> EncoderDecoderFactory.build(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    task<span class="op">=</span><span class="st">"regression"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">"prithvi_100M"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    decoder<span class="op">=</span><span class="st">"FCNDecoder"</span>,  <span class="co"># Simple decoder for regression</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span>T,  <span class="co"># Number of historical timesteps</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span>N,  <span class="co"># Number of future timesteps to predict</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="inputoutput-data-format" class="level4">
<h4 class="anchored" data-anchor-id="inputoutput-data-format">2.3 Input/Output Data Format</h4>
<p><strong>Key considerations</strong>: - <strong>Input shape</strong>: <code>(batch, T, H, W)</code> where T = historical timesteps - <strong>Output shape</strong>: <code>(batch, N, H, W)</code> where N = forecast timesteps - <strong>Patch size</strong>: Prithvi expects 224√ó224 or 512√ó512 inputs - <strong>Batching</strong>: Spatial tiles or temporal windows</p>
<p><strong>Data loader structure</strong>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sliding window over time dimension</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Use timesteps [0:10] to predict [10:13]</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> NDVIForecastDataset(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    ndvi_cube<span class="op">=</span>ndvi_cube,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    history_length<span class="op">=</span><span class="dv">10</span>,  <span class="co"># Use 10 past observations</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    forecast_length<span class="op">=</span><span class="dv">3</span>,   <span class="co"># Predict 3 future observations</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    stride<span class="op">=</span><span class="dv">1</span>             <span class="co"># Sliding window stride</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="part-3-model-training-and-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="part-3-model-training-and-fine-tuning">Part 3: Model Training and Fine-Tuning</h3>
<section id="loss-function-selection" class="level4">
<h4 class="anchored" data-anchor-id="loss-function-selection">3.1 Loss Function Selection</h4>
<p><strong>Key considerations</strong>: - <strong>MSE loss</strong>: Standard for regression, penalizes large errors - <strong>MAE loss</strong>: More robust to outliers, easier interpretation - <strong>Temporal consistency</strong>: Consider adding smoothness penalty - <strong>Weighted loss</strong>: Emphasize recent predictions over distant future</p>
<p><strong>Recommended approach</strong>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combined loss for temporal forecasting</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> mse_loss(pred, target) <span class="op">+</span> <span class="kw">lambda</span> <span class="op">*</span> temporal_smoothness(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="training-strategy" class="level4">
<h4 class="anchored" data-anchor-id="training-strategy">3.2 Training Strategy</h4>
<p><strong>Key considerations</strong>: - <strong>Transfer learning</strong>: Start with frozen Prithvi encoder, train only decoder - <strong>Progressive unfreezing</strong>: Gradually unfreeze encoder layers if needed - <strong>Learning rate</strong>: Lower LR for encoder (1e-5), higher for decoder (1e-4) - <strong>Data augmentation</strong>: Spatial flips/rotations, but preserve temporal order</p>
<p><strong>Training loop outline</strong>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Phase 1: Train decoder only (faster convergence)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(initial_epochs):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> train_loader:</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># batch['input']: (B, T, H, W)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># batch['target']: (B, N, H, W)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        pred <span class="op">=</span> model(batch[<span class="st">'input'</span>])</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss_fn(pred, batch[<span class="st">'target'</span>])</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Phase 2: Fine-tune encoder (optional, if performance plateaus)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>unfreeze_encoder_layers(model.encoder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="validation-and-metrics" class="level4">
<h4 class="anchored" data-anchor-id="validation-and-metrics">3.3 Validation and Metrics</h4>
<p><strong>Key considerations</strong>: - <strong>Temporal splitting</strong>: Train on early period, validate on later period - <strong>Spatial holdout</strong>: Can also hold out spatial regions for robustness - <strong>Metrics</strong>: RMSE, MAE, R¬≤ for each forecast horizon - <strong>Visualization</strong>: Time series plots comparing predicted vs.&nbsp;actual NDVI</p>
<p><strong>Validation structure</strong>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate at each forecast horizon</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    rmse_i <span class="op">=</span> compute_rmse(pred[:, i], target[:, i])</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Horizon </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: RMSE = </span><span class="sc">{</span>rmse_i<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="part-4-inference-and-forecasting" class="level3">
<h3 class="anchored" data-anchor-id="part-4-inference-and-forecasting">Part 4: Inference and Forecasting</h3>
<section id="single-step-prediction" class="level4">
<h4 class="anchored" data-anchor-id="single-step-prediction">4.1 Single-Step Prediction</h4>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load trained model</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">eval</span>()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare input window (last 10 observations)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>input_window <span class="op">=</span> ndvi_cube.isel(time<span class="op">=</span><span class="bu">slice</span>(<span class="op">-</span><span class="dv">10</span>, <span class="va">None</span>))  <span class="co"># (10, H, W)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>input_tensor <span class="op">=</span> torch.from_numpy(input_window.values).unsqueeze(<span class="dv">0</span>)  <span class="co"># (1, 10, H, W)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate forecast</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    forecast <span class="op">=</span> model(input_tensor)  <span class="co"># (1, N, H, W)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="multi-step-autoregressive-forecasting" class="level4">
<h4 class="anchored" data-anchor-id="multi-step-autoregressive-forecasting">4.2 Multi-Step Autoregressive Forecasting</h4>
<p><strong>Key considerations</strong>: - <strong>Autoregressive mode</strong>: Use predictions as inputs for next forecast step - <strong>Error accumulation</strong>: Errors compound over multiple steps - <strong>Uncertainty</strong>: Longer horizons have higher uncertainty</p>
<p><strong>Implementation approach</strong>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterative forecasting</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>current_window <span class="op">=</span> input_window.copy()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>all_forecasts <span class="op">=</span> []</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> step <span class="kw">in</span> <span class="bu">range</span>(total_forecast_steps):</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> model(current_window)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    all_forecasts.append(pred[<span class="dv">0</span>])  <span class="co"># Store first timestep</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update window: drop oldest, add newest prediction</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    current_window <span class="op">=</span> torch.cat([current_window[:, <span class="dv">1</span>:], pred[:, :<span class="dv">1</span>]], dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="forecast-visualization" class="level4">
<h4 class="anchored" data-anchor-id="forecast-visualization">4.3 Forecast Visualization</h4>
<p><strong>Recommended plots</strong>: 1. <strong>Time series</strong>: Line plots of observed vs.&nbsp;predicted NDVI at sample pixels 2. <strong>Spatial maps</strong>: NDVI forecast maps at key timesteps 3. <strong>Difference maps</strong>: Observed - predicted to identify errors 4. <strong>Skill scores</strong>: RMSE vs.&nbsp;forecast horizon</p>
<p><strong>Visualization code structure</strong>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Time series at specific pixel</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>pixel_coords <span class="op">=</span> (<span class="dv">256</span>, <span class="dv">256</span>)  <span class="co"># Center of study area</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>observed <span class="op">=</span> ndvi_cube.isel(x<span class="op">=</span>pixel_coords[<span class="dv">0</span>], y<span class="op">=</span>pixel_coords[<span class="dv">1</span>])</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>predicted <span class="op">=</span> forecast.isel(x<span class="op">=</span>pixel_coords[<span class="dv">0</span>], y<span class="op">=</span>pixel_coords[<span class="dv">1</span>])</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>plt.plot(observed.time, observed, label<span class="op">=</span><span class="st">'Observed'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>plt.plot(forecast_times, predicted, label<span class="op">=</span><span class="st">'Forecast'</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="part-5-critical-implementation-considerations" class="level3">
<h3 class="anchored" data-anchor-id="part-5-critical-implementation-considerations">Part 5: Critical Implementation Considerations</h3>
<section id="data-quality-issues" class="level4">
<h4 class="anchored" data-anchor-id="data-quality-issues">5.1 Data Quality Issues</h4>
<p><strong>Cloud contamination</strong>: - Even with SCL masking, thin clouds can affect NDVI - Consider temporal interpolation or gap-filling - Use SCL quality flags conservatively (only clear land pixels)</p>
<p><strong>Temporal gaps</strong>: - Irregular observation frequency due to clouds - Interpolate to regular grid before modeling - Document gap locations for uncertainty estimation</p>
</section>
<section id="model-limitations" class="level4">
<h4 class="anchored" data-anchor-id="model-limitations">5.2 Model Limitations</h4>
<p><strong>Prithvi design</strong>: - Pre-trained on 6-band HLS, single-band NDVI is domain shift - Spatial patch size (224√ó224) may not capture landscape context - No explicit temporal modeling in base architecture (uses channel stacking)</p>
<p><strong>Adaptation strategies</strong>: - Consider using full 6-band input instead of just NDVI - Add temporal positional encoding to input - Experiment with recurrent or temporal convolution layers in decoder</p>
</section>
<section id="computational-considerations" class="level4">
<h4 class="anchored" data-anchor-id="computational-considerations">5.3 Computational Considerations</h4>
<p><strong>Memory requirements</strong>: - Full spatial fields (e.g., 5000√ó5000 pixels) don‚Äôt fit in GPU memory - Use spatial tiling or region-based sampling - Batch size limited by (T + N) √ó H √ó W</p>
<p><strong>Inference speed</strong>: - Autoregressive forecasting is sequential (cannot parallelize timesteps) - Spatial parallelization via tiling - Consider model quantization for deployment</p>
</section>
<section id="evaluation-best-practices" class="level4">
<h4 class="anchored" data-anchor-id="evaluation-best-practices">5.4 Evaluation Best Practices</h4>
<p><strong>Baseline comparisons</strong>: - Persistence model: Next value = current value - Climatology: Average seasonal pattern from historical data - Simple regression: Linear trend extrapolation</p>
<p><strong>Cross-validation</strong>: - Multiple temporal folds (e.g., monthly validation periods) - Spatial cross-validation (train on some areas, test on others) - Out-of-sample validation on different year</p>
</section>
</section>
</section>
<section id="implementation-summary" class="level2">
<h2 class="anchored" data-anchor-id="implementation-summary">Implementation Summary</h2>
<section id="minimal-code-example" class="level3">
<h3 class="anchored" data-anchor-id="minimal-code-example">Minimal Code Example</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Load and prepare data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ndvi_cube <span class="op">=</span> load_ndvi_timeseries(bbox, date_range)  <span class="co"># (time, y, x)</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> create_forecast_dataset(ndvi_cube, history<span class="op">=</span><span class="dv">10</span>, forecast<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Load Prithvi model</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> EncoderDecoderFactory.build(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    task<span class="op">=</span><span class="st">"regression"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">"prithvi_100M"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    decoder<span class="op">=</span><span class="st">"FCNDecoder"</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="dv">3</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Train model</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> Trainer(max_epochs<span class="op">=</span><span class="dv">50</span>, accelerator<span class="op">=</span><span class="st">"gpu"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>trainer.fit(model, train_dataset)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Generate forecasts</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>input_window <span class="op">=</span> ndvi_cube.isel(time<span class="op">=</span><span class="bu">slice</span>(<span class="op">-</span><span class="dv">10</span>, <span class="va">None</span>))</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>forecast <span class="op">=</span> model.predict(input_window)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Evaluate</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> evaluate_forecast(forecast, ground_truth)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="key-hyperparameters" class="level3">
<h3 class="anchored" data-anchor-id="key-hyperparameters">Key Hyperparameters</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Parameter</th>
<th>Recommended Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>History length (T)</td>
<td>10-20</td>
<td>~2-4 months of weekly data</td>
</tr>
<tr class="even">
<td>Forecast horizon (N)</td>
<td>3-6</td>
<td>~0.5-1.5 months ahead</td>
</tr>
<tr class="odd">
<td>Learning rate (encoder)</td>
<td>1e-5</td>
<td>Low for pre-trained weights</td>
</tr>
<tr class="even">
<td>Learning rate (decoder)</td>
<td>1e-4</td>
<td>Higher for new layers</td>
</tr>
<tr class="odd">
<td>Batch size</td>
<td>4-8</td>
<td>Limited by GPU memory</td>
</tr>
<tr class="even">
<td>Patch size</td>
<td>224√ó224 or 512√ó512</td>
<td>Match Prithvi pre-training</td>
</tr>
<tr class="odd">
<td>Cloud threshold</td>
<td>10-15%</td>
<td>Balance coverage vs.&nbsp;quality</td>
</tr>
<tr class="even">
<td>Temporal resolution</td>
<td>7-14 days</td>
<td>Weekly or biweekly composites</td>
</tr>
</tbody>
</table>
</section>
<section id="expected-results" class="level3">
<h3 class="anchored" data-anchor-id="expected-results">Expected Results</h3>
<p><strong>Baseline performance</strong> (MSE vs.&nbsp;persistence): - 1-step ahead: 10-30% improvement over persistence - 3-step ahead: 5-15% improvement - 6-step ahead: Marginal or no improvement (high uncertainty)</p>
<p><strong>Typical challenges</strong>: - Abrupt vegetation changes (e.g., harvest events) are hard to predict - Long forecast horizons limited by weather unpredictability - Sparse training data in winter months (clouds, low sun angle)</p>
</section>
</section>
<section id="next-steps-and-extensions" class="level2">
<h2 class="anchored" data-anchor-id="next-steps-and-extensions">Next Steps and Extensions</h2>
<section id="advanced-topics" class="level3">
<h3 class="anchored" data-anchor-id="advanced-topics">Advanced Topics</h3>
<ol type="1">
<li><strong>Multi-modal inputs</strong>: Add temperature, precipitation, soil moisture</li>
<li><strong>Ensemble forecasting</strong>: Multiple models or dropout-based uncertainty</li>
<li><strong>Attention visualization</strong>: Understand which past timesteps are important</li>
<li><strong>Spatial context</strong>: Use larger patches or multi-scale architecture</li>
<li><strong>Uncertainty quantification</strong>: Probabilistic forecasts with prediction intervals</li>
</ol>
</section>
<section id="alternative-approaches" class="level3">
<h3 class="anchored" data-anchor-id="alternative-approaches">Alternative Approaches</h3>
<ul>
<li><strong>Prithvi-EO-2.0</strong>: Newer version with explicit temporal modeling</li>
<li><strong>ConvLSTM</strong>: Recurrent architecture for temporal dynamics</li>
<li><strong>U-Net with temporal axis</strong>: 3D convolutions over space-time</li>
<li><strong>Transformer-based</strong>: Temporal Fusion Transformer for timeseries</li>
</ul>
</section>
<section id="production-deployment" class="level3">
<h3 class="anchored" data-anchor-id="production-deployment">Production Deployment</h3>
<ul>
<li><strong>API endpoint</strong>: Serve forecasts via FastAPI or similar</li>
<li><strong>Batch processing</strong>: Daily/weekly forecast generation</li>
<li><strong>Monitoring dashboard</strong>: Visualize predictions and errors</li>
<li><strong>Retraining pipeline</strong>: Periodic model updates with new data</li>
</ul>
</section>
</section>
<section id="references-and-resources" class="level2">
<h2 class="anchored" data-anchor-id="references-and-resources">References and Resources</h2>
<p><strong>Prithvi documentation</strong>: - HuggingFace: <code>ibm-nasa-geospatial/Prithvi-100M</code> - TerraTorch examples: https://github.com/IBM/terratorch</p>
<p><strong>Relevant papers</strong>: - Prithvi-EO: Foundation model for Earth Observation (Jakubik et al., 2024) - Temporal Fusion Transformers (Lim et al., 2021) - alternative architecture - ConvLSTM for precipitation nowcasting (Shi et al., 2015) - temporal convolution</p>
<p><strong>Datasets</strong>: - Sentinel-2 L2A: Microsoft Planetary Computer - HLS: NASA Harmonized Landsat-Sentinel (Prithvi pre-training data)</p>
</section>
<section id="appendix-code-stubs" class="level2">
<h2 class="anchored" data-anchor-id="appendix-code-stubs">Appendix: Code Stubs</h2>
<section id="a.1-ndvi-computation-with-cloud-masking" class="level3">
<h3 class="anchored" data-anchor-id="a.1-ndvi-computation-with-cloud-masking">A.1 NDVI Computation with Cloud Masking</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_ndvi_from_scene(item, bbox):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cloud-masked NDVI from single Sentinel-2 scene."""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load bands</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    red <span class="op">=</span> load_band(item, <span class="st">'B04'</span>, bbox)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    nir <span class="op">=</span> load_band(item, <span class="st">'B08'</span>, bbox)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    scl <span class="op">=</span> load_band(item, <span class="st">'SCL'</span>, bbox)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cloud mask (SCL: 4=vegetation, 5=bare soil, 6=water, others=cloud/shadow)</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    clear_mask <span class="op">=</span> np.isin(scl, [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>])</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute NDVI</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    ndvi <span class="op">=</span> (nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    ndvi[<span class="op">~</span>clear_mask] <span class="op">=</span> np.nan</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ndvi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a.2-temporal-dataset-for-pytorch" class="level3">
<h3 class="anchored" data-anchor-id="a.2-temporal-dataset-for-pytorch">A.2 Temporal Dataset for PyTorch</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NDVIForecastDataset(torch.utils.data.Dataset):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ndvi_cube, history_length, forecast_length):</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ndvi <span class="op">=</span> ndvi_cube.values  <span class="co"># (T, H, W)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T_hist <span class="op">=</span> history_length</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T_fore <span class="op">=</span> forecast_length</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.ndvi) <span class="op">-</span> <span class="va">self</span>.T_hist <span class="op">-</span> <span class="va">self</span>.T_fore <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        input_window <span class="op">=</span> <span class="va">self</span>.ndvi[idx:idx<span class="op">+</span><span class="va">self</span>.T_hist]</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        target_window <span class="op">=</span> <span class="va">self</span>.ndvi[idx<span class="op">+</span><span class="va">self</span>.T_hist:idx<span class="op">+</span><span class="va">self</span>.T_hist<span class="op">+</span><span class="va">self</span>.T_fore]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'input'</span>: torch.FloatTensor(input_window),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'target'</span>: torch.FloatTensor(target_window)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a.3-temporal-smoothness-loss" class="level3">
<h3 class="anchored" data-anchor-id="a.3-temporal-smoothness-loss">A.3 Temporal Smoothness Loss</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> temporal_smoothness_loss(forecast, lambda_smooth<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Penalize non-smooth temporal transitions in forecast."""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> forecast[:, <span class="dv">1</span>:] <span class="op">-</span> forecast[:, :<span class="op">-</span><span class="dv">1</span>]  <span class="co"># Temporal differences</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    smoothness <span class="op">=</span> torch.mean(diff <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lambda_smooth <span class="op">*</span> smoothness</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a.4-evaluation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="a.4-evaluation-metrics">A.4 Evaluation Metrics</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_forecast_by_horizon(pred, target):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute RMSE and MAE for each forecast horizon."""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    n_horizons <span class="op">=</span> pred.shape[<span class="dv">1</span>]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> []</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> h <span class="kw">in</span> <span class="bu">range</span>(n_horizons):</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> torch.sqrt(torch.mean((pred[:, h] <span class="op">-</span> target[:, h]) <span class="op">**</span> <span class="dv">2</span>))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        mae <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(pred[:, h] <span class="op">-</span> target[:, h]))</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> compute_r2(pred[:, h], target[:, h])</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        metrics.append({</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'horizon'</span>: h <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rmse'</span>: rmse.item(),</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mae'</span>: mae.item(),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2'</span>: r2.item()</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This outline provides a complete roadmap for building an NDVI forecasting system using Prithvi:</p>
<ol type="1">
<li><strong>Data pipeline</strong>: Sentinel-2 acquisition ‚Üí NDVI computation ‚Üí temporal stacking</li>
<li><strong>Model setup</strong>: Prithvi encoder + temporal decoder for regression</li>
<li><strong>Training</strong>: Transfer learning with frozen encoder, progressive fine-tuning</li>
<li><strong>Inference</strong>: Single-step and autoregressive multi-step forecasting</li>
<li><strong>Validation</strong>: Temporal cross-validation, baseline comparisons, horizon-specific metrics</li>
</ol>
<p><strong>Critical success factors</strong>: - High-quality cloud masking (garbage in = garbage out) - Sufficient temporal coverage (at least 1 year of training data) - Appropriate forecast horizon (1-3 months realistic, &gt;6 months very uncertain) - Regular temporal sampling (interpolate gaps before modeling) - Baseline comparisons (ensure model beats simple persistence)</p>
<p>This workflow is production-ready and can be adapted for other vegetation indices (EVI, SAVI), different regions, or alternative foundation models.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kcaylor\.github\.io\/GEOG-288KC-geospatial-foundation-models");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb17" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "NDVI Timeseries Forecasting with Prithvi"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Forward prediction of urban vegetation dynamics using geospatial foundation models"</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> geoai</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>This workflow demonstrates how to use Prithvi (or other geospatial foundation models) to forecast future NDVI values from satellite timeseries data. We'll focus on urban vegetation dynamics in Santa Barbara, using Sentinel-2 imagery to predict the next N timesteps of NDVI based on historical patterns.</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>By the end of this tutorial, you will:</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Construct NDVI timeseries from Sentinel-2 imagery</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Prepare temporal data for foundation model input</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Fine-tune Prithvi for temporal forecasting tasks</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Generate forward predictions for vegetation dynamics</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Validate predictions against held-out observations</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why NDVI Forecasting?</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>Urban vegetation forecasting has practical applications for:</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Water management**: Predict irrigation needs before drought stress appears</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Urban planning**: Forecast seasonal greening/browning patterns</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Climate adaptation**: Understand vegetation response to temperature and precipitation</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Ecosystem monitoring**: Early detection of vegetation stress or change</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>Prithvi's pre-training on massive satellite archives gives it strong priors for Earth surface dynamics, making it well-suited for temporal prediction tasks.</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="fu">## Workflow Outline</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 1: Data Preparation</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 1.1 Define Study Area and Temporal Range</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Study area: Santa Barbara urban/natural interface (vegetation gradient)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sentinel-2 resolution: 10m for RGB/NIR, 20m for red-edge bands</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Temporal resolution: 5-day revisit (2 satellites), cloud filtering affects actual frequency</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>NDVI calculation: <span class="in">`(NIR - Red) / (NIR + Red)`</span> using B08 (NIR) and B04 (Red)</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>**Code structure**:</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Santa Barbara bounding box</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>bbox <span class="op">=</span> [<span class="op">-</span><span class="fl">120.1</span>, <span class="fl">34.4</span>, <span class="op">-</span><span class="fl">119.6</span>, <span class="fl">34.5</span>]  <span class="co"># Focused on urban core</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Temporal range for training (e.g., 2023 full year)</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>train_start <span class="op">=</span> <span class="st">"2023-01-01"</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>train_end <span class="op">=</span> <span class="st">"2023-12-31"</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast horizon (e.g., predict next 3 months)</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>forecast_start <span class="op">=</span> <span class="st">"2024-01-01"</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>forecast_end <span class="op">=</span> <span class="st">"2024-03-31"</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 1.2 Acquire and Filter Sentinel-2 Scenes</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cloud filtering: Max cloud cover threshold (10-20%)</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Scene selection: Balance temporal coverage vs. data quality</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Spatial consistency: Scenes from same UTM tile to avoid reprojection issues</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>**Implementation approach**:</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for training scenes</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> search_sentinel2_scenes(</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    date_range<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>train_start<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>train_end<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>    cloud_cover_max<span class="op">=</span><span class="dv">15</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract NDVI-relevant bands (B04, B08) plus SCL for cloud masking</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> [<span class="st">'B04'</span>, <span class="st">'B08'</span>, <span class="st">'SCL'</span>]</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 1.3 Compute NDVI Timeseries</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cloud masking: Use Scene Classification Layer (SCL) to remove clouds/shadows</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Temporal alignment: Resample to regular intervals (weekly or biweekly)</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Spatial aggregation: Consider region-of-interest statistics vs. full spatial fields</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Normalization: NDVI already bounded <span class="co">[</span><span class="ot">-1, 1</span><span class="co">]</span>, but consider standardization</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>**Data structure**:</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Target: xarray DataArray with dimensions (time, y, x)</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Shape example: (52, 512, 512) for weekly composites over 1 year</span></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>ndvi_cube <span class="op">=</span> compute_ndvi_timeseries(items, bbox, bands)</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 2: Model Architecture and Setup</span></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2.1 Prithvi Model Overview</span></span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>**Key architecture points**:</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Base model**: Vision Transformer (ViT) pre-trained on HLS (Harmonized Landsat-Sentinel)</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Input**: 6 bands (RGB + 3 red-edge) at 224√ó224 patches</span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Temporal capability**: Can handle temporal stacks via channel concatenation or 3D convolution</span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Pre-training**: Masked autoencoder (MAE) objective on satellite imagery</span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>**Adaptation for NDVI forecasting**:</span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Input modification**: Single-band NDVI instead of 6-band reflectance</span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Temporal encoding**: Stack past T timesteps as input channels</span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Output head**: Regression head predicting next N timesteps</span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Architecture**: Encoder (Prithvi frozen/fine-tuned) ‚Üí Temporal decoder ‚Üí Future NDVI</span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2.2 TerraTorch Model Loading</span></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Model source: HuggingFace hub (<span class="in">`ibm-nasa-geospatial/Prithvi-100M`</span>)</span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Task type: Pixel-wise regression (not classification)</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Decoder choice: Simple conv decoder for single-band output</span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>**Implementation approach**:</span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.models <span class="im">import</span> EncoderDecoderFactory</span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Prithvi encoder</span></span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> EncoderDecoderFactory.build(</span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>    task<span class="op">=</span><span class="st">"regression"</span>,</span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">"prithvi_100M"</span>,</span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>    decoder<span class="op">=</span><span class="st">"FCNDecoder"</span>,  <span class="co"># Simple decoder for regression</span></span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span>T,  <span class="co"># Number of historical timesteps</span></span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span>N,  <span class="co"># Number of future timesteps to predict</span></span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2.3 Input/Output Data Format</span></span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Input shape**: <span class="in">`(batch, T, H, W)`</span> where T = historical timesteps</span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Output shape**: <span class="in">`(batch, N, H, W)`</span> where N = forecast timesteps</span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Patch size**: Prithvi expects 224√ó224 or 512√ó512 inputs</span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Batching**: Spatial tiles or temporal windows</span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>**Data loader structure**:</span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Sliding window over time dimension</span></span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Use timesteps [0:10] to predict [10:13]</span></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> NDVIForecastDataset(</span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a>    ndvi_cube<span class="op">=</span>ndvi_cube,</span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>    history_length<span class="op">=</span><span class="dv">10</span>,  <span class="co"># Use 10 past observations</span></span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a>    forecast_length<span class="op">=</span><span class="dv">3</span>,   <span class="co"># Predict 3 future observations</span></span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>    stride<span class="op">=</span><span class="dv">1</span>             <span class="co"># Sliding window stride</span></span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 3: Model Training and Fine-Tuning</span></span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 3.1 Loss Function Selection</span></span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**MSE loss**: Standard for regression, penalizes large errors</span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**MAE loss**: More robust to outliers, easier interpretation</span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Temporal consistency**: Consider adding smoothness penalty</span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Weighted loss**: Emphasize recent predictions over distant future</span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a>**Recommended approach**:</span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Combined loss for temporal forecasting</span></span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> mse_loss(pred, target) <span class="op">+</span> <span class="kw">lambda</span> <span class="op">*</span> temporal_smoothness(pred)</span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 3.2 Training Strategy</span></span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Transfer learning**: Start with frozen Prithvi encoder, train only decoder</span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Progressive unfreezing**: Gradually unfreeze encoder layers if needed</span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Learning rate**: Lower LR for encoder (1e-5), higher for decoder (1e-4)</span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Data augmentation**: Spatial flips/rotations, but preserve temporal order</span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a>**Training loop outline**:</span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Phase 1: Train decoder only (faster convergence)</span></span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(initial_epochs):</span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> train_loader:</span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a>        <span class="co"># batch['input']: (B, T, H, W)</span></span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a>        <span class="co"># batch['target']: (B, N, H, W)</span></span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a>        pred <span class="op">=</span> model(batch[<span class="st">'input'</span>])</span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss_fn(pred, batch[<span class="st">'target'</span>])</span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Phase 2: Fine-tune encoder (optional, if performance plateaus)</span></span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a>unfreeze_encoder_layers(model.encoder)</span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 3.3 Validation and Metrics</span></span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Temporal splitting**: Train on early period, validate on later period</span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Spatial holdout**: Can also hold out spatial regions for robustness</span>
<span id="cb17-204"><a href="#cb17-204" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Metrics**: RMSE, MAE, R¬≤ for each forecast horizon</span>
<span id="cb17-205"><a href="#cb17-205" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Visualization**: Time series plots comparing predicted vs. actual NDVI</span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a>**Validation structure**:</span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate at each forecast horizon</span></span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a>    rmse_i <span class="op">=</span> compute_rmse(pred[:, i], target[:, i])</span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Horizon </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: RMSE = </span><span class="sc">{</span>rmse_i<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 4: Inference and Forecasting</span></span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 4.1 Single-Step Prediction</span></span>
<span id="cb17-218"><a href="#cb17-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-219"><a href="#cb17-219" aria-hidden="true" tabindex="-1"></a>**Implementation**:</span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-221"><a href="#cb17-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Load trained model</span></span>
<span id="cb17-222"><a href="#cb17-222" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">eval</span>()</span>
<span id="cb17-223"><a href="#cb17-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-224"><a href="#cb17-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare input window (last 10 observations)</span></span>
<span id="cb17-225"><a href="#cb17-225" aria-hidden="true" tabindex="-1"></a>input_window <span class="op">=</span> ndvi_cube.isel(time<span class="op">=</span><span class="bu">slice</span>(<span class="op">-</span><span class="dv">10</span>, <span class="va">None</span>))  <span class="co"># (10, H, W)</span></span>
<span id="cb17-226"><a href="#cb17-226" aria-hidden="true" tabindex="-1"></a>input_tensor <span class="op">=</span> torch.from_numpy(input_window.values).unsqueeze(<span class="dv">0</span>)  <span class="co"># (1, 10, H, W)</span></span>
<span id="cb17-227"><a href="#cb17-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-228"><a href="#cb17-228" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate forecast</span></span>
<span id="cb17-229"><a href="#cb17-229" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb17-230"><a href="#cb17-230" aria-hidden="true" tabindex="-1"></a>    forecast <span class="op">=</span> model(input_tensor)  <span class="co"># (1, N, H, W)</span></span>
<span id="cb17-231"><a href="#cb17-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-232"><a href="#cb17-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-233"><a href="#cb17-233" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 4.2 Multi-Step Autoregressive Forecasting</span></span>
<span id="cb17-234"><a href="#cb17-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-235"><a href="#cb17-235" aria-hidden="true" tabindex="-1"></a>**Key considerations**:</span>
<span id="cb17-236"><a href="#cb17-236" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Autoregressive mode**: Use predictions as inputs for next forecast step</span>
<span id="cb17-237"><a href="#cb17-237" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Error accumulation**: Errors compound over multiple steps</span>
<span id="cb17-238"><a href="#cb17-238" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Uncertainty**: Longer horizons have higher uncertainty</span>
<span id="cb17-239"><a href="#cb17-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-240"><a href="#cb17-240" aria-hidden="true" tabindex="-1"></a>**Implementation approach**:</span>
<span id="cb17-241"><a href="#cb17-241" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-242"><a href="#cb17-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterative forecasting</span></span>
<span id="cb17-243"><a href="#cb17-243" aria-hidden="true" tabindex="-1"></a>current_window <span class="op">=</span> input_window.copy()</span>
<span id="cb17-244"><a href="#cb17-244" aria-hidden="true" tabindex="-1"></a>all_forecasts <span class="op">=</span> []</span>
<span id="cb17-245"><a href="#cb17-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-246"><a href="#cb17-246" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> step <span class="kw">in</span> <span class="bu">range</span>(total_forecast_steps):</span>
<span id="cb17-247"><a href="#cb17-247" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> model(current_window)</span>
<span id="cb17-248"><a href="#cb17-248" aria-hidden="true" tabindex="-1"></a>    all_forecasts.append(pred[<span class="dv">0</span>])  <span class="co"># Store first timestep</span></span>
<span id="cb17-249"><a href="#cb17-249" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update window: drop oldest, add newest prediction</span></span>
<span id="cb17-250"><a href="#cb17-250" aria-hidden="true" tabindex="-1"></a>    current_window <span class="op">=</span> torch.cat([current_window[:, <span class="dv">1</span>:], pred[:, :<span class="dv">1</span>]], dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-251"><a href="#cb17-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-252"><a href="#cb17-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-253"><a href="#cb17-253" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 4.3 Forecast Visualization</span></span>
<span id="cb17-254"><a href="#cb17-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-255"><a href="#cb17-255" aria-hidden="true" tabindex="-1"></a>**Recommended plots**:</span>
<span id="cb17-256"><a href="#cb17-256" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Time series**: Line plots of observed vs. predicted NDVI at sample pixels</span>
<span id="cb17-257"><a href="#cb17-257" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Spatial maps**: NDVI forecast maps at key timesteps</span>
<span id="cb17-258"><a href="#cb17-258" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Difference maps**: Observed - predicted to identify errors</span>
<span id="cb17-259"><a href="#cb17-259" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Skill scores**: RMSE vs. forecast horizon</span>
<span id="cb17-260"><a href="#cb17-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-261"><a href="#cb17-261" aria-hidden="true" tabindex="-1"></a>**Visualization code structure**:</span>
<span id="cb17-262"><a href="#cb17-262" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-263"><a href="#cb17-263" aria-hidden="true" tabindex="-1"></a><span class="co"># Time series at specific pixel</span></span>
<span id="cb17-264"><a href="#cb17-264" aria-hidden="true" tabindex="-1"></a>pixel_coords <span class="op">=</span> (<span class="dv">256</span>, <span class="dv">256</span>)  <span class="co"># Center of study area</span></span>
<span id="cb17-265"><a href="#cb17-265" aria-hidden="true" tabindex="-1"></a>observed <span class="op">=</span> ndvi_cube.isel(x<span class="op">=</span>pixel_coords[<span class="dv">0</span>], y<span class="op">=</span>pixel_coords[<span class="dv">1</span>])</span>
<span id="cb17-266"><a href="#cb17-266" aria-hidden="true" tabindex="-1"></a>predicted <span class="op">=</span> forecast.isel(x<span class="op">=</span>pixel_coords[<span class="dv">0</span>], y<span class="op">=</span>pixel_coords[<span class="dv">1</span>])</span>
<span id="cb17-267"><a href="#cb17-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-268"><a href="#cb17-268" aria-hidden="true" tabindex="-1"></a>plt.plot(observed.time, observed, label<span class="op">=</span><span class="st">'Observed'</span>)</span>
<span id="cb17-269"><a href="#cb17-269" aria-hidden="true" tabindex="-1"></a>plt.plot(forecast_times, predicted, label<span class="op">=</span><span class="st">'Forecast'</span>)</span>
<span id="cb17-270"><a href="#cb17-270" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-271"><a href="#cb17-271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-272"><a href="#cb17-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-273"><a href="#cb17-273" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 5: Critical Implementation Considerations</span></span>
<span id="cb17-274"><a href="#cb17-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-275"><a href="#cb17-275" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 5.1 Data Quality Issues</span></span>
<span id="cb17-276"><a href="#cb17-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-277"><a href="#cb17-277" aria-hidden="true" tabindex="-1"></a>**Cloud contamination**:</span>
<span id="cb17-278"><a href="#cb17-278" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Even with SCL masking, thin clouds can affect NDVI</span>
<span id="cb17-279"><a href="#cb17-279" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Consider temporal interpolation or gap-filling</span>
<span id="cb17-280"><a href="#cb17-280" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use SCL quality flags conservatively (only clear land pixels)</span>
<span id="cb17-281"><a href="#cb17-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-282"><a href="#cb17-282" aria-hidden="true" tabindex="-1"></a>**Temporal gaps**:</span>
<span id="cb17-283"><a href="#cb17-283" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Irregular observation frequency due to clouds</span>
<span id="cb17-284"><a href="#cb17-284" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Interpolate to regular grid before modeling</span>
<span id="cb17-285"><a href="#cb17-285" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Document gap locations for uncertainty estimation</span>
<span id="cb17-286"><a href="#cb17-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-287"><a href="#cb17-287" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 5.2 Model Limitations</span></span>
<span id="cb17-288"><a href="#cb17-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-289"><a href="#cb17-289" aria-hidden="true" tabindex="-1"></a>**Prithvi design**:</span>
<span id="cb17-290"><a href="#cb17-290" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Pre-trained on 6-band HLS, single-band NDVI is domain shift</span>
<span id="cb17-291"><a href="#cb17-291" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Spatial patch size (224√ó224) may not capture landscape context</span>
<span id="cb17-292"><a href="#cb17-292" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No explicit temporal modeling in base architecture (uses channel stacking)</span>
<span id="cb17-293"><a href="#cb17-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-294"><a href="#cb17-294" aria-hidden="true" tabindex="-1"></a>**Adaptation strategies**:</span>
<span id="cb17-295"><a href="#cb17-295" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Consider using full 6-band input instead of just NDVI</span>
<span id="cb17-296"><a href="#cb17-296" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Add temporal positional encoding to input</span>
<span id="cb17-297"><a href="#cb17-297" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Experiment with recurrent or temporal convolution layers in decoder</span>
<span id="cb17-298"><a href="#cb17-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-299"><a href="#cb17-299" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 5.3 Computational Considerations</span></span>
<span id="cb17-300"><a href="#cb17-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-301"><a href="#cb17-301" aria-hidden="true" tabindex="-1"></a>**Memory requirements**:</span>
<span id="cb17-302"><a href="#cb17-302" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Full spatial fields (e.g., 5000√ó5000 pixels) don't fit in GPU memory</span>
<span id="cb17-303"><a href="#cb17-303" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use spatial tiling or region-based sampling</span>
<span id="cb17-304"><a href="#cb17-304" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Batch size limited by (T + N) √ó H √ó W</span>
<span id="cb17-305"><a href="#cb17-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-306"><a href="#cb17-306" aria-hidden="true" tabindex="-1"></a>**Inference speed**:</span>
<span id="cb17-307"><a href="#cb17-307" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Autoregressive forecasting is sequential (cannot parallelize timesteps)</span>
<span id="cb17-308"><a href="#cb17-308" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Spatial parallelization via tiling</span>
<span id="cb17-309"><a href="#cb17-309" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Consider model quantization for deployment</span>
<span id="cb17-310"><a href="#cb17-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-311"><a href="#cb17-311" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 5.4 Evaluation Best Practices</span></span>
<span id="cb17-312"><a href="#cb17-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-313"><a href="#cb17-313" aria-hidden="true" tabindex="-1"></a>**Baseline comparisons**:</span>
<span id="cb17-314"><a href="#cb17-314" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Persistence model: Next value = current value</span>
<span id="cb17-315"><a href="#cb17-315" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Climatology: Average seasonal pattern from historical data</span>
<span id="cb17-316"><a href="#cb17-316" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Simple regression: Linear trend extrapolation</span>
<span id="cb17-317"><a href="#cb17-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-318"><a href="#cb17-318" aria-hidden="true" tabindex="-1"></a>**Cross-validation**:</span>
<span id="cb17-319"><a href="#cb17-319" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Multiple temporal folds (e.g., monthly validation periods)</span>
<span id="cb17-320"><a href="#cb17-320" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Spatial cross-validation (train on some areas, test on others)</span>
<span id="cb17-321"><a href="#cb17-321" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Out-of-sample validation on different year</span>
<span id="cb17-322"><a href="#cb17-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-323"><a href="#cb17-323" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation Summary</span></span>
<span id="cb17-324"><a href="#cb17-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-325"><a href="#cb17-325" aria-hidden="true" tabindex="-1"></a><span class="fu">### Minimal Code Example</span></span>
<span id="cb17-326"><a href="#cb17-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-327"><a href="#cb17-327" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-328"><a href="#cb17-328" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Load and prepare data</span></span>
<span id="cb17-329"><a href="#cb17-329" aria-hidden="true" tabindex="-1"></a>ndvi_cube <span class="op">=</span> load_ndvi_timeseries(bbox, date_range)  <span class="co"># (time, y, x)</span></span>
<span id="cb17-330"><a href="#cb17-330" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> create_forecast_dataset(ndvi_cube, history<span class="op">=</span><span class="dv">10</span>, forecast<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb17-331"><a href="#cb17-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-332"><a href="#cb17-332" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Load Prithvi model</span></span>
<span id="cb17-333"><a href="#cb17-333" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> EncoderDecoderFactory.build(</span>
<span id="cb17-334"><a href="#cb17-334" aria-hidden="true" tabindex="-1"></a>    task<span class="op">=</span><span class="st">"regression"</span>,</span>
<span id="cb17-335"><a href="#cb17-335" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">"prithvi_100M"</span>,</span>
<span id="cb17-336"><a href="#cb17-336" aria-hidden="true" tabindex="-1"></a>    decoder<span class="op">=</span><span class="st">"FCNDecoder"</span>,</span>
<span id="cb17-337"><a href="#cb17-337" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb17-338"><a href="#cb17-338" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="dv">3</span></span>
<span id="cb17-339"><a href="#cb17-339" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-340"><a href="#cb17-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-341"><a href="#cb17-341" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Train model</span></span>
<span id="cb17-342"><a href="#cb17-342" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> Trainer(max_epochs<span class="op">=</span><span class="dv">50</span>, accelerator<span class="op">=</span><span class="st">"gpu"</span>)</span>
<span id="cb17-343"><a href="#cb17-343" aria-hidden="true" tabindex="-1"></a>trainer.fit(model, train_dataset)</span>
<span id="cb17-344"><a href="#cb17-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-345"><a href="#cb17-345" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Generate forecasts</span></span>
<span id="cb17-346"><a href="#cb17-346" aria-hidden="true" tabindex="-1"></a>input_window <span class="op">=</span> ndvi_cube.isel(time<span class="op">=</span><span class="bu">slice</span>(<span class="op">-</span><span class="dv">10</span>, <span class="va">None</span>))</span>
<span id="cb17-347"><a href="#cb17-347" aria-hidden="true" tabindex="-1"></a>forecast <span class="op">=</span> model.predict(input_window)</span>
<span id="cb17-348"><a href="#cb17-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-349"><a href="#cb17-349" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Evaluate</span></span>
<span id="cb17-350"><a href="#cb17-350" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> evaluate_forecast(forecast, ground_truth)</span>
<span id="cb17-351"><a href="#cb17-351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-352"><a href="#cb17-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-353"><a href="#cb17-353" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Hyperparameters</span></span>
<span id="cb17-354"><a href="#cb17-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-355"><a href="#cb17-355" aria-hidden="true" tabindex="-1"></a>| Parameter | Recommended Value | Notes |</span>
<span id="cb17-356"><a href="#cb17-356" aria-hidden="true" tabindex="-1"></a>|-----------|------------------|-------|</span>
<span id="cb17-357"><a href="#cb17-357" aria-hidden="true" tabindex="-1"></a>| History length (T) | 10-20 | ~2-4 months of weekly data |</span>
<span id="cb17-358"><a href="#cb17-358" aria-hidden="true" tabindex="-1"></a>| Forecast horizon (N) | 3-6 | ~0.5-1.5 months ahead |</span>
<span id="cb17-359"><a href="#cb17-359" aria-hidden="true" tabindex="-1"></a>| Learning rate (encoder) | 1e-5 | Low for pre-trained weights |</span>
<span id="cb17-360"><a href="#cb17-360" aria-hidden="true" tabindex="-1"></a>| Learning rate (decoder) | 1e-4 | Higher for new layers |</span>
<span id="cb17-361"><a href="#cb17-361" aria-hidden="true" tabindex="-1"></a>| Batch size | 4-8 | Limited by GPU memory |</span>
<span id="cb17-362"><a href="#cb17-362" aria-hidden="true" tabindex="-1"></a>| Patch size | 224√ó224 or 512√ó512 | Match Prithvi pre-training |</span>
<span id="cb17-363"><a href="#cb17-363" aria-hidden="true" tabindex="-1"></a>| Cloud threshold | 10-15% | Balance coverage vs. quality |</span>
<span id="cb17-364"><a href="#cb17-364" aria-hidden="true" tabindex="-1"></a>| Temporal resolution | 7-14 days | Weekly or biweekly composites |</span>
<span id="cb17-365"><a href="#cb17-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-366"><a href="#cb17-366" aria-hidden="true" tabindex="-1"></a><span class="fu">### Expected Results</span></span>
<span id="cb17-367"><a href="#cb17-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-368"><a href="#cb17-368" aria-hidden="true" tabindex="-1"></a>**Baseline performance** (MSE vs. persistence):</span>
<span id="cb17-369"><a href="#cb17-369" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>1-step ahead: 10-30% improvement over persistence</span>
<span id="cb17-370"><a href="#cb17-370" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>3-step ahead: 5-15% improvement</span>
<span id="cb17-371"><a href="#cb17-371" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>6-step ahead: Marginal or no improvement (high uncertainty)</span>
<span id="cb17-372"><a href="#cb17-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-373"><a href="#cb17-373" aria-hidden="true" tabindex="-1"></a>**Typical challenges**:</span>
<span id="cb17-374"><a href="#cb17-374" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Abrupt vegetation changes (e.g., harvest events) are hard to predict</span>
<span id="cb17-375"><a href="#cb17-375" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Long forecast horizons limited by weather unpredictability</span>
<span id="cb17-376"><a href="#cb17-376" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sparse training data in winter months (clouds, low sun angle)</span>
<span id="cb17-377"><a href="#cb17-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-378"><a href="#cb17-378" aria-hidden="true" tabindex="-1"></a><span class="fu">## Next Steps and Extensions</span></span>
<span id="cb17-379"><a href="#cb17-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-380"><a href="#cb17-380" aria-hidden="true" tabindex="-1"></a><span class="fu">### Advanced Topics</span></span>
<span id="cb17-381"><a href="#cb17-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-382"><a href="#cb17-382" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Multi-modal inputs**: Add temperature, precipitation, soil moisture</span>
<span id="cb17-383"><a href="#cb17-383" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Ensemble forecasting**: Multiple models or dropout-based uncertainty</span>
<span id="cb17-384"><a href="#cb17-384" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Attention visualization**: Understand which past timesteps are important</span>
<span id="cb17-385"><a href="#cb17-385" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Spatial context**: Use larger patches or multi-scale architecture</span>
<span id="cb17-386"><a href="#cb17-386" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Uncertainty quantification**: Probabilistic forecasts with prediction intervals</span>
<span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a><span class="fu">### Alternative Approaches</span></span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Prithvi-EO-2.0**: Newer version with explicit temporal modeling</span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**ConvLSTM**: Recurrent architecture for temporal dynamics</span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**U-Net with temporal axis**: 3D convolutions over space-time</span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Transformer-based**: Temporal Fusion Transformer for timeseries</span>
<span id="cb17-394"><a href="#cb17-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-395"><a href="#cb17-395" aria-hidden="true" tabindex="-1"></a><span class="fu">### Production Deployment</span></span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**API endpoint**: Serve forecasts via FastAPI or similar</span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Batch processing**: Daily/weekly forecast generation</span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Monitoring dashboard**: Visualize predictions and errors</span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Retraining pipeline**: Periodic model updates with new data</span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a><span class="fu">## References and Resources</span></span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a>**Prithvi documentation**:</span>
<span id="cb17-405"><a href="#cb17-405" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>HuggingFace: <span class="in">`ibm-nasa-geospatial/Prithvi-100M`</span></span>
<span id="cb17-406"><a href="#cb17-406" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>TerraTorch examples: https://github.com/IBM/terratorch</span>
<span id="cb17-407"><a href="#cb17-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-408"><a href="#cb17-408" aria-hidden="true" tabindex="-1"></a>**Relevant papers**:</span>
<span id="cb17-409"><a href="#cb17-409" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Prithvi-EO: Foundation model for Earth Observation (Jakubik et al., 2024)</span>
<span id="cb17-410"><a href="#cb17-410" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Temporal Fusion Transformers (Lim et al., 2021) - alternative architecture</span>
<span id="cb17-411"><a href="#cb17-411" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>ConvLSTM for precipitation nowcasting (Shi et al., 2015) - temporal convolution</span>
<span id="cb17-412"><a href="#cb17-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-413"><a href="#cb17-413" aria-hidden="true" tabindex="-1"></a>**Datasets**:</span>
<span id="cb17-414"><a href="#cb17-414" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sentinel-2 L2A: Microsoft Planetary Computer</span>
<span id="cb17-415"><a href="#cb17-415" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>HLS: NASA Harmonized Landsat-Sentinel (Prithvi pre-training data)</span>
<span id="cb17-416"><a href="#cb17-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-417"><a href="#cb17-417" aria-hidden="true" tabindex="-1"></a><span class="fu">## Appendix: Code Stubs</span></span>
<span id="cb17-418"><a href="#cb17-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-419"><a href="#cb17-419" aria-hidden="true" tabindex="-1"></a><span class="fu">### A.1 NDVI Computation with Cloud Masking</span></span>
<span id="cb17-420"><a href="#cb17-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-421"><a href="#cb17-421" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-422"><a href="#cb17-422" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_ndvi_from_scene(item, bbox):</span>
<span id="cb17-423"><a href="#cb17-423" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cloud-masked NDVI from single Sentinel-2 scene."""</span></span>
<span id="cb17-424"><a href="#cb17-424" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load bands</span></span>
<span id="cb17-425"><a href="#cb17-425" aria-hidden="true" tabindex="-1"></a>    red <span class="op">=</span> load_band(item, <span class="st">'B04'</span>, bbox)</span>
<span id="cb17-426"><a href="#cb17-426" aria-hidden="true" tabindex="-1"></a>    nir <span class="op">=</span> load_band(item, <span class="st">'B08'</span>, bbox)</span>
<span id="cb17-427"><a href="#cb17-427" aria-hidden="true" tabindex="-1"></a>    scl <span class="op">=</span> load_band(item, <span class="st">'SCL'</span>, bbox)</span>
<span id="cb17-428"><a href="#cb17-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-429"><a href="#cb17-429" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cloud mask (SCL: 4=vegetation, 5=bare soil, 6=water, others=cloud/shadow)</span></span>
<span id="cb17-430"><a href="#cb17-430" aria-hidden="true" tabindex="-1"></a>    clear_mask <span class="op">=</span> np.isin(scl, [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>])</span>
<span id="cb17-431"><a href="#cb17-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-432"><a href="#cb17-432" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute NDVI</span></span>
<span id="cb17-433"><a href="#cb17-433" aria-hidden="true" tabindex="-1"></a>    ndvi <span class="op">=</span> (nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb17-434"><a href="#cb17-434" aria-hidden="true" tabindex="-1"></a>    ndvi[<span class="op">~</span>clear_mask] <span class="op">=</span> np.nan</span>
<span id="cb17-435"><a href="#cb17-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-436"><a href="#cb17-436" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ndvi</span>
<span id="cb17-437"><a href="#cb17-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-438"><a href="#cb17-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-439"><a href="#cb17-439" aria-hidden="true" tabindex="-1"></a><span class="fu">### A.2 Temporal Dataset for PyTorch</span></span>
<span id="cb17-440"><a href="#cb17-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-441"><a href="#cb17-441" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-442"><a href="#cb17-442" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NDVIForecastDataset(torch.utils.data.Dataset):</span>
<span id="cb17-443"><a href="#cb17-443" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ndvi_cube, history_length, forecast_length):</span>
<span id="cb17-444"><a href="#cb17-444" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ndvi <span class="op">=</span> ndvi_cube.values  <span class="co"># (T, H, W)</span></span>
<span id="cb17-445"><a href="#cb17-445" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T_hist <span class="op">=</span> history_length</span>
<span id="cb17-446"><a href="#cb17-446" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T_fore <span class="op">=</span> forecast_length</span>
<span id="cb17-447"><a href="#cb17-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-448"><a href="#cb17-448" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb17-449"><a href="#cb17-449" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.ndvi) <span class="op">-</span> <span class="va">self</span>.T_hist <span class="op">-</span> <span class="va">self</span>.T_fore <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb17-450"><a href="#cb17-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-451"><a href="#cb17-451" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb17-452"><a href="#cb17-452" aria-hidden="true" tabindex="-1"></a>        input_window <span class="op">=</span> <span class="va">self</span>.ndvi[idx:idx<span class="op">+</span><span class="va">self</span>.T_hist]</span>
<span id="cb17-453"><a href="#cb17-453" aria-hidden="true" tabindex="-1"></a>        target_window <span class="op">=</span> <span class="va">self</span>.ndvi[idx<span class="op">+</span><span class="va">self</span>.T_hist:idx<span class="op">+</span><span class="va">self</span>.T_hist<span class="op">+</span><span class="va">self</span>.T_fore]</span>
<span id="cb17-454"><a href="#cb17-454" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb17-455"><a href="#cb17-455" aria-hidden="true" tabindex="-1"></a>            <span class="st">'input'</span>: torch.FloatTensor(input_window),</span>
<span id="cb17-456"><a href="#cb17-456" aria-hidden="true" tabindex="-1"></a>            <span class="st">'target'</span>: torch.FloatTensor(target_window)</span>
<span id="cb17-457"><a href="#cb17-457" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb17-458"><a href="#cb17-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-459"><a href="#cb17-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-460"><a href="#cb17-460" aria-hidden="true" tabindex="-1"></a><span class="fu">### A.3 Temporal Smoothness Loss</span></span>
<span id="cb17-461"><a href="#cb17-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-462"><a href="#cb17-462" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-463"><a href="#cb17-463" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> temporal_smoothness_loss(forecast, lambda_smooth<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb17-464"><a href="#cb17-464" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Penalize non-smooth temporal transitions in forecast."""</span></span>
<span id="cb17-465"><a href="#cb17-465" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> forecast[:, <span class="dv">1</span>:] <span class="op">-</span> forecast[:, :<span class="op">-</span><span class="dv">1</span>]  <span class="co"># Temporal differences</span></span>
<span id="cb17-466"><a href="#cb17-466" aria-hidden="true" tabindex="-1"></a>    smoothness <span class="op">=</span> torch.mean(diff <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb17-467"><a href="#cb17-467" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lambda_smooth <span class="op">*</span> smoothness</span>
<span id="cb17-468"><a href="#cb17-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-469"><a href="#cb17-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-470"><a href="#cb17-470" aria-hidden="true" tabindex="-1"></a><span class="fu">### A.4 Evaluation Metrics</span></span>
<span id="cb17-471"><a href="#cb17-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-472"><a href="#cb17-472" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb17-473"><a href="#cb17-473" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_forecast_by_horizon(pred, target):</span>
<span id="cb17-474"><a href="#cb17-474" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute RMSE and MAE for each forecast horizon."""</span></span>
<span id="cb17-475"><a href="#cb17-475" aria-hidden="true" tabindex="-1"></a>    n_horizons <span class="op">=</span> pred.shape[<span class="dv">1</span>]</span>
<span id="cb17-476"><a href="#cb17-476" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> []</span>
<span id="cb17-477"><a href="#cb17-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-478"><a href="#cb17-478" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> h <span class="kw">in</span> <span class="bu">range</span>(n_horizons):</span>
<span id="cb17-479"><a href="#cb17-479" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> torch.sqrt(torch.mean((pred[:, h] <span class="op">-</span> target[:, h]) <span class="op">**</span> <span class="dv">2</span>))</span>
<span id="cb17-480"><a href="#cb17-480" aria-hidden="true" tabindex="-1"></a>        mae <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(pred[:, h] <span class="op">-</span> target[:, h]))</span>
<span id="cb17-481"><a href="#cb17-481" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> compute_r2(pred[:, h], target[:, h])</span>
<span id="cb17-482"><a href="#cb17-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-483"><a href="#cb17-483" aria-hidden="true" tabindex="-1"></a>        metrics.append({</span>
<span id="cb17-484"><a href="#cb17-484" aria-hidden="true" tabindex="-1"></a>            <span class="st">'horizon'</span>: h <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb17-485"><a href="#cb17-485" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rmse'</span>: rmse.item(),</span>
<span id="cb17-486"><a href="#cb17-486" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mae'</span>: mae.item(),</span>
<span id="cb17-487"><a href="#cb17-487" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2'</span>: r2.item()</span>
<span id="cb17-488"><a href="#cb17-488" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb17-489"><a href="#cb17-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-490"><a href="#cb17-490" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(metrics)</span>
<span id="cb17-491"><a href="#cb17-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-492"><a href="#cb17-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-493"><a href="#cb17-493" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb17-494"><a href="#cb17-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-495"><a href="#cb17-495" aria-hidden="true" tabindex="-1"></a>This outline provides a complete roadmap for building an NDVI forecasting system using Prithvi:</span>
<span id="cb17-496"><a href="#cb17-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-497"><a href="#cb17-497" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Data pipeline**: Sentinel-2 acquisition ‚Üí NDVI computation ‚Üí temporal stacking</span>
<span id="cb17-498"><a href="#cb17-498" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Model setup**: Prithvi encoder + temporal decoder for regression</span>
<span id="cb17-499"><a href="#cb17-499" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Training**: Transfer learning with frozen encoder, progressive fine-tuning</span>
<span id="cb17-500"><a href="#cb17-500" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Inference**: Single-step and autoregressive multi-step forecasting</span>
<span id="cb17-501"><a href="#cb17-501" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Validation**: Temporal cross-validation, baseline comparisons, horizon-specific metrics</span>
<span id="cb17-502"><a href="#cb17-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-503"><a href="#cb17-503" aria-hidden="true" tabindex="-1"></a>**Critical success factors**:</span>
<span id="cb17-504"><a href="#cb17-504" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>High-quality cloud masking (garbage in = garbage out)</span>
<span id="cb17-505"><a href="#cb17-505" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sufficient temporal coverage (at least 1 year of training data)</span>
<span id="cb17-506"><a href="#cb17-506" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Appropriate forecast horizon (1-3 months realistic, &gt;6 months very uncertain)</span>
<span id="cb17-507"><a href="#cb17-507" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Regular temporal sampling (interpolate gaps before modeling)</span>
<span id="cb17-508"><a href="#cb17-508" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Baseline comparisons (ensure model beats simple persistence)</span>
<span id="cb17-509"><a href="#cb17-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-510"><a href="#cb17-510" aria-hidden="true" tabindex="-1"></a>This workflow is production-ready and can be adapted for other vegetation indices (EVI, SAVI), different regions, or alternative foundation models.</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/geog-logo.png" class="img-fluid figure-img" width="250"></p>
<figcaption>Department of Geography logo</figcaption>
</figure>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This website is built with <a href="https://github.com/kcaylor/GEOG-288KC-geospatial-foundation-models"><i class="fa-brands fa-github" title="the github octocat logo" aria-label="github"></i></a> and <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>