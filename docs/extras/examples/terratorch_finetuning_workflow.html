<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Getting started with fine tuning with TerraTorch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">GEOG 288KC</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">üè† home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Syllabus.html"> 
<span class="menu-text">üìã syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-sessions" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üíª weekly sessions</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-weekly-sessions">    
        <li>
    <a class="dropdown-item" href="../../chapters/c01-geospatial-data-foundations.html">
 <span class="dropdown-text">Week 1 - üöÄ Core Tools and Data Access</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c02-spatial-temporal-attention-mechanisms.html">
 <span class="dropdown-text">Week 2 - ‚ö° Rapid Remote Sensing Preprocessing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c03a-terratorch-foundations.html">
 <span class="dropdown-text">Week 3a - üåç TerraTorch Foundations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c03-complete-gfm-architecture.html">
 <span class="dropdown-text">Week 3b - ü§ñ Machine Learning on Remote Sensing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c04-pretraining-implementation.html">
 <span class="dropdown-text">Week 4 - üèóÔ∏è Foundation Models in Practice</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c05-training-loop-optimization.html">
 <span class="dropdown-text">Week 5 - üîß Fine-Tuning &amp; Transfer Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c06-model-evaluation-analysis.html">
 <span class="dropdown-text">Week 6 - ‚è∞ Spatiotemporal Modeling &amp; Projects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/terratorch_finetuning_workflow.html">
 <span class="dropdown-text">Week 7 - ‚ö° TerraTorch + Lightning Fine-Tuning Workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cheatsheets" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üëÄ cheatsheets</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-cheatsheets">    
        <li>
    <a class="dropdown-item" href="../../cheatsheets.html">
 <span class="dropdown-text">üìã All Cheatsheets</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">‚ö° Quick Starts</li>
        <li>
    <a class="dropdown-item" href="../../extras/cheatsheets/week01_imports.html">
 <span class="dropdown-text">Week 01: Import Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/cheatsheets/dataset_organization_terratorch.html">
 <span class="dropdown-text">Dataset Organization for Fine-Tuning</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-explainers" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üß© explainers</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-explainers">    
        <li class="dropdown-header">1Ô∏è‚É£ Week 1</li>
        <li>
    <a class="dropdown-item" href="../../extras/ai-ml-dl-fm-hierarchy.html">
 <span class="dropdown-text">ü§ñ AI/ML/DL/FM Hierarchy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/geospatial-foundation-model-predictions-standalone.html">
 <span class="dropdown-text">üéØ GFM Predictions (Standalone)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/geospatial-prediction-hierarchy.html">
 <span class="dropdown-text">‚úÖ Geospatial Task/Prediction Types</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/neural_networks_explainer.html">
 <span class="dropdown-text">üß† Neural Networks: Neurons to Transformers</span></a>
  </li>  
        <li class="dropdown-header">2Ô∏è‚É£ Week 2</li>
        <li>
    <a class="dropdown-item" href="../../chapters/c00a-foundation_model_architectures.html">
 <span class="dropdown-text">üèóÔ∏è Foundation Model Architectures</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c00b-introduction-to-deeplearning-architecture.html">
 <span class="dropdown-text">üéì Introduction to Deep Learning Architecture</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-extras" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üìñ extras</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-extras">    
        <li class="dropdown-header">üéØ Practical Examples</li>
        <li>
    <a class="dropdown-item" href="../../extras/examples/normalization_comparison.html">
 <span class="dropdown-text">Normalization Comparison</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/resnet.html">
 <span class="dropdown-text">ResNet Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/segmentation_finetuning.html">
 <span class="dropdown-text">Segmentation Fine-Tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/Terramind_EuroSAT.html">
 <span class="dropdown-text">TerraMind EuroSAT Classification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/terratorch_finetuning_workflow.html">
 <span class="dropdown-text">TerraTorch Fine-Tuning Workflow</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/text_encoder.html">
 <span class="dropdown-text">Text Encoder</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/tiling-and-patches.html">
 <span class="dropdown-text">Tiling and Patches</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/terratorch_workflows.html">
 <span class="dropdown-text">TerraTorch Workflows</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/resources/course_resources.html">
 <span class="dropdown-text">üìö Reference Materials</span></a>
  </li>  
        <li class="dropdown-header">üìÅ Project Templates</li>
        <li>
    <a class="dropdown-item" href="../../extras/projects/project-proposal-template.html">
 <span class="dropdown-text">Project Proposal Template</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/projects/mvp-template.html">
 <span class="dropdown-text">Project Results Template</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gfms-from-scratch/gfms-from-scratch.github.io" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">Getting started with fine tuning with TerraTorch</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#step-0-setup" id="toc-step-0-setup" class="nav-link active" data-scroll-target="#step-0-setup">Step 0: Setup</a>
  <ul class="collapse">
  <li><a href="#huggingface-cache" id="toc-huggingface-cache" class="nav-link" data-scroll-target="#huggingface-cache">HuggingFace cache</a></li>
  </ul></li>
  <li><a href="#step-1-get-your-data-in-the-right-format-for-terratorch" id="toc-step-1-get-your-data-in-the-right-format-for-terratorch" class="nav-link" data-scroll-target="#step-1-get-your-data-in-the-right-format-for-terratorch">Step 1: Get your data in the right format for TerraTorch</a>
  <ul class="collapse">
  <li><a href="#file-organization" id="toc-file-organization" class="nav-link" data-scroll-target="#file-organization">File organization</a></li>
  <li><a href="#specify-splits" id="toc-specify-splits" class="nav-link" data-scroll-target="#specify-splits">Specify splits</a></li>
  </ul></li>
  <li><a href="#step-2-get-your-datamodule-set-up" id="toc-step-2-get-your-datamodule-set-up" class="nav-link" data-scroll-target="#step-2-get-your-datamodule-set-up">Step 2: Get your DataModule set up</a>
  <ul class="collapse">
  <li><a href="#inspect-your-data" id="toc-inspect-your-data" class="nav-link" data-scroll-target="#inspect-your-data">Inspect your data</a></li>
  <li><a href="#define-bands-statistics-and-transforms" id="toc-define-bands-statistics-and-transforms" class="nav-link" data-scroll-target="#define-bands-statistics-and-transforms">Define bands, statistics, and transforms</a></li>
  <li><a href="#define-your-datamodule" id="toc-define-your-datamodule" class="nav-link" data-scroll-target="#define-your-datamodule">Define your DataModule</a></li>
  <li><a href="#check-your-datamodule" id="toc-check-your-datamodule" class="nav-link" data-scroll-target="#check-your-datamodule">Check your DataModule</a></li>
  </ul></li>
  <li><a href="#step-3-get-your-task-set-up" id="toc-step-3-get-your-task-set-up" class="nav-link" data-scroll-target="#step-3-get-your-task-set-up">Step 3: Get your Task set up</a>
  <ul class="collapse">
  <li><a href="#choose-your-model-from-the-model-factory" id="toc-choose-your-model-from-the-model-factory" class="nav-link" data-scroll-target="#choose-your-model-from-the-model-factory">Choose your model from the model factory</a></li>
  <li><a href="#define-your-task" id="toc-define-your-task" class="nav-link" data-scroll-target="#define-your-task">Define your Task</a></li>
  </ul></li>
  <li><a href="#step-4-train-your-model" id="toc-step-4-train-your-model" class="nav-link" data-scroll-target="#step-4-train-your-model">Step 4: Train your model</a></li>
  <li><a href="#step-5-run-inference-with-your-trained-model" id="toc-step-5-run-inference-with-your-trained-model" class="nav-link" data-scroll-target="#step-5-run-inference-with-your-trained-model">Step 5: Run inference with your trained model</a>
  <ul class="collapse">
  <li><a href="#load-the-best-checkpoint" id="toc-load-the-best-checkpoint" class="nav-link" data-scroll-target="#load-the-best-checkpoint">Load the best checkpoint</a></li>
  <li><a href="#get-some-test-images" id="toc-get-some-test-images" class="nav-link" data-scroll-target="#get-some-test-images">Get some test images</a></li>
  <li><a href="#run-predictions" id="toc-run-predictions" class="nav-link" data-scroll-target="#run-predictions">Run predictions</a></li>
  <li><a href="#compare-predictions-to-ground-truth" id="toc-compare-predictions-to-ground-truth" class="nav-link" data-scroll-target="#compare-predictions-to-ground-truth">Compare predictions to ground truth</a></li>
  <li><a href="#visualize-predictions" id="toc-visualize-predictions" class="nav-link" data-scroll-target="#visualize-predictions">Visualize predictions</a></li>
  <li><a href="#get-prediction-probabilities" id="toc-get-prediction-probabilities" class="nav-link" data-scroll-target="#get-prediction-probabilities">Get prediction probabilities</a></li>
  <li><a href="#evaluate-on-full-test-set" id="toc-evaluate-on-full-test-set" class="nav-link" data-scroll-target="#evaluate-on-full-test-set">Evaluate on full test set</a></li>
  </ul></li>
  <li><a href="#bonus-exploring-model-embeddings" id="toc-bonus-exploring-model-embeddings" class="nav-link" data-scroll-target="#bonus-exploring-model-embeddings">Bonus: Exploring model embeddings</a>
  <ul class="collapse">
  <li><a href="#visualize-embedding-space-with-pca" id="toc-visualize-embedding-space-with-pca" class="nav-link" data-scroll-target="#visualize-embedding-space-with-pca">Visualize embedding space with PCA</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<p>TerraTorch is a package that allows you to easily use and fine tune geospatial foundation models (GeoFMs). This tutorial walks through how to get started with TerraTorch to fine tune a GeoFM on your own data and task, whatever that may be.</p>
<p>Achieving fine tuning and inference using TerraTorch can be achieved in four steps:</p>
<ol type="1">
<li><strong>Organize your data:</strong> Make sure your inputs, labels, and spits are organized in a standardized way that TerraTorch generic DataModules can interpret</li>
<li><strong>Set up your DataModule:</strong> Use TerraTorch generic DataModules to create an object which reads in your data, makes any necessary adjustments, and passes it to your model in the format it expects for training.</li>
<li><strong>Set up your Task:</strong> Identify your chosen task, choose your model and define hyperparemeters</li>
<li><strong>Train your model:</strong> Use Pytorch Lightning to handle training and logging for a set number of epochs.</li>
</ol>
<p>In this demo, we will show how to fine tune Prithvi on a subset of the EuroSAT benchmark, which classifies 64x64 pixel Sentinel 2 L1C images into one of 10 classes. The demo is written in a general way to help users adapt this code to their specific use case.</p>
<section id="step-0-setup" class="level2">
<h2 class="anchored" data-anchor-id="step-0-setup">Step 0: Setup</h2>
<section id="huggingface-cache" class="level3">
<h3 class="anchored" data-anchor-id="huggingface-cache">HuggingFace cache</h3>
<p>Because we are on a shared server with shared conda environment, we need to reorient where huggingface downloads things like model weights and datasets</p>
<div id="88952882" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify where you want model weights/datasets to be saved</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>DATA_PATH <span class="op">=</span> <span class="st">'/Users/kellycaylor/dev/geoAI/data'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="68283e75" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up environment variables that are used by HuggingFace</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"HF_HOME"</span>] <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"hfhome"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"HF_HUB_CACHE"</span>] <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"hub"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"HF_DATASETS_CACHE"</span>] <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"datasets"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"TRANSFORMERS_CACHE"</span>] <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"transformers"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-1-get-your-data-in-the-right-format-for-terratorch" class="level2">
<h2 class="anchored" data-anchor-id="step-1-get-your-data-in-the-right-format-for-terratorch">Step 1: Get your data in the right format for TerraTorch</h2>
<p>TerraTorch makes your life easier if you organize your data in standard ways. Specifically, following these conventions will allow you to use their generic DataModules and save your the trouble of writing your own.</p>
<section id="file-organization" class="level3">
<h3 class="anchored" data-anchor-id="file-organization">File organization</h3>
<ul>
<li><strong>Classification:</strong> Organize your images into different folders depending on their class (this is how EuroSAT is organized). Alternatively, have a metadata file listing</li>
<li><strong>Segmentation/regression:</strong> Have images and their labels (masks or continuous outputs) have the same name but followed by an image vs.&nbsp;mask or label identifier (e.g.&nbsp;image: <code>Im_1_img.tif</code> and <code>Im_1_mask.tif</code></li>
</ul>
<section id="eurosat-classification-example" class="level4">
<h4 class="anchored" data-anchor-id="eurosat-classification-example">EuroSAT classification example</h4>
<p>We can retrieve a subsample of the EuroSAT dataset using torchgeo. Luckily, we will show it is already in the format TerraTorch expects for a classification task.</p>
<div id="bc581861" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchgeo.datasets <span class="im">import</span> EuroSAT100 <span class="co"># 100 image subset from EuroSAT</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>EuroSAT100(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    root<span class="op">=</span>DATA_PATH, <span class="co"># make sure you have defined the path where you want data saved</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    split<span class="op">=</span><span class="st">'train'</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>EuroSAT100(</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    root<span class="op">=</span>DATA_PATH,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    split<span class="op">=</span><span class="st">'val'</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>EuroSAT100(</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    root<span class="op">=</span>DATA_PATH,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    split<span class="op">=</span><span class="st">'test'</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When opening inspecting the downloaded dataset, you will find that the data will be stored at the following path:</p>
<div id="15b2bb6a" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the location of the saved EUROSAT data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>EUROSAT <span class="op">=</span> DATA_PATH <span class="op">+</span> <span class="st">"/ds/images/remote_sensing/otherDatasets/sentinel_2/tif/"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There is one folder for each class, each containing <code>.tif</code> files with the images to be classified.</p>
<div id="4a979be9" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List the folders each containing images for a given EuroSAT class</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>class_paths <span class="op">=</span> [item <span class="cf">for</span> item <span class="kw">in</span> Path(EUROSAT).iterdir()]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>class_names <span class="op">=</span> [item.name <span class="cf">for</span> item <span class="kw">in</span> class_paths]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(class_names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="specify-splits" class="level3">
<h3 class="anchored" data-anchor-id="specify-splits">Specify splits</h3>
<p>To specify which images belong to which split, you have two options:</p>
<ul>
<li>provide <code>.txt</code> files that have the names of the images in each split in them</li>
<li>organize the splits into different folders</li>
</ul>
<section id="eurosat-example" class="level4">
<h4 class="anchored" data-anchor-id="eurosat-example">EuroSAT example</h4>
<p>In the case of EuroSAT, the names of the images belonging to each split are saved as <code>.txt</code> files.</p>
<div id="af8aa109" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the paths to each split for use in the DataModule setup</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>TRAIN_SPLIT <span class="op">=</span> DATA_PATH <span class="op">+</span> <span class="st">'/eurosat-100-train.txt'</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>VAL_SPLIT <span class="op">=</span> DATA_PATH <span class="op">+</span> <span class="st">'/eurosat-100-val.txt'</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>TEST_SPLIT <span class="op">=</span> DATA_PATH <span class="op">+</span> <span class="st">'/eurosat-100-test.txt'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="step-2-get-your-datamodule-set-up" class="level2">
<h2 class="anchored" data-anchor-id="step-2-get-your-datamodule-set-up">Step 2: Get your DataModule set up</h2>
<section id="inspect-your-data" class="level3">
<h3 class="anchored" data-anchor-id="inspect-your-data">Inspect your data</h3>
<p>It is important to have a good grasp of the contents of your data in order to set up the DataModule properly. It can therefore be useful to do a bit of exploration and visualization.</p>
<div id="f2716f52" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the first image in each class for inspection</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># get the first image in each class</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>image_sample <span class="op">=</span> [<span class="bu">next</span>(folder.iterdir()) <span class="cf">for</span> folder <span class="kw">in</span> class_paths] <span class="co"># list of 10 images</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># read all 10 sample images</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>ims <span class="op">=</span> [rasterio.<span class="bu">open</span>(image).read() <span class="cf">for</span> image <span class="kw">in</span> image_sample]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="image-statistics" class="level4">
<h4 class="anchored" data-anchor-id="image-statistics">Image statistics</h4>
<p>By inspecting the first image, we find that we have 13 bands per image (corresponding to the 13 Sentinel-2 L1C bands) and images are 64x64 pixels. Neither of these is what Prithvi expects, so it‚Äôs important to know this so we can adjust it in the DataLoader.</p>
<p>We also note that the units are in reflectance values.</p>
<div id="5048c2f8" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print some statistics for the first image</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Shape:"</span>, ims[<span class="dv">1</span>].shape)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Means by band:"</span>, ims[<span class="dv">1</span>].mean(axis<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>)))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Stds by band:"</span>, ims[<span class="dv">1</span>].std(axis<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualization" class="level4">
<h4 class="anchored" data-anchor-id="visualization">Visualization</h4>
<div id="d8bd8a5d" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_rgb(img):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># select the r,g,b bands</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> img[[<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>]].astype(<span class="bu">float</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Follow EuroSAT guidelines for visualization</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># clip to a max of 2750</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normalize to 0-1</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> np.clip(rgb, <span class="dv">0</span>, <span class="dv">2750</span>) <span class="op">/</span> <span class="dv">2750</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># go from (CxWxH) to (WxHxC)</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> np.transpose(rgb, (<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rgb</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.ravel()</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (ax, img, name) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes, ims, class_names)):</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> to_rgb(img)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    ax.imshow(rgb)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    ax.set_title(name)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    ax.axis(<span class="st">"off"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="define-bands-statistics-and-transforms" class="level3">
<h3 class="anchored" data-anchor-id="define-bands-statistics-and-transforms">Define bands, statistics, and transforms</h3>
<p>There are a few important parameters we will need to define when setting up our DataModule in addition to the location of the data and splits that we defined in Step 1.</p>
<p>We specifically use the GenericNonGeoClassificationDataModule, though all generic DataModules will need these inputs. You can always learn more about the arguments for a given DataModule by adapting the following code:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.datamodules <span class="im">import</span> GenericNonGeoClassificationDataModule</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>?GenericNonGeoClassificationDataModule</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="band-names" class="level4">
<h4 class="anchored" data-anchor-id="band-names">Band names</h4>
<p>We need to tell the datamodule which bands we actually want to go into the model.</p>
<p>In our case, we have 13 sentinel 2 bands, but Prithvi is trained on 6 landsay bands, so we need to subset them.</p>
<div id="9e81a382" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sentinel2_bands <span class="op">=</span> [</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B1"</span>, <span class="st">"B2"</span>, <span class="st">"B3"</span>, <span class="st">"B4"</span>, <span class="st">"B5"</span>, <span class="st">"B6"</span>, <span class="st">"B7"</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B8"</span>, <span class="st">"B8A"</span>, <span class="st">"B9"</span>, <span class="st">"B10"</span>, <span class="st">"B11"</span>, <span class="st">"B12"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The subset of our bands Prithvi will take</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>prithvi_subset <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">11</span>, <span class="dv">12</span>]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>prithvi_bands <span class="op">=</span> [sentinel2_bands[i] <span class="cf">for</span> i <span class="kw">in</span> prithvi_subset]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prithvi_bands)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="means-and-standard-deviations" class="level4">
<h4 class="anchored" data-anchor-id="means-and-standard-deviations">Means and standard deviations</h4>
<p>We need band-level means and standard deviations. Either compute them yourself over your entire dataset, or get general numbers that work well for your data type.</p>
<p>We have S2 L1C data. We can use TerraMesh statistics I grabbed from their huggingface: https://huggingface.co/api/resolve-cache/datasets/ibm-esa-geospatial/TerraMesh/6c548cdacdd70e98a236de9f5b708d4b9dadf253/terramesh.py</p>
<div id="99d61428" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>statistics <span class="op">=</span> {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean"</span>: {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2L1C"</span>: [<span class="fl">2357.090</span>, <span class="fl">2137.398</span>, <span class="fl">2018.799</span>, <span class="fl">2082.998</span>, <span class="fl">2295.663</span>, <span class="fl">2854.548</span>, <span class="fl">3122.860</span>, <span class="fl">3040.571</span>, <span class="fl">3306.491</span>, <span class="fl">1473.849</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">506.072</span>, <span class="fl">2472.840</span>, <span class="fl">1838.943</span>],</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2L2A"</span>: [<span class="fl">1390.461</span>, <span class="fl">1503.332</span>, <span class="fl">1718.211</span>, <span class="fl">1853.926</span>, <span class="fl">2199.116</span>, <span class="fl">2779.989</span>, <span class="fl">2987.025</span>, <span class="fl">3083.248</span>, <span class="fl">3132.235</span>, <span class="fl">3162.989</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">2424.902</span>, <span class="fl">1857.665</span>],</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2RGB"</span>: [<span class="fl">110.349</span>, <span class="fl">99.507</span>, <span class="fl">75.843</span>],</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S1GRD"</span>: [<span class="op">-</span><span class="fl">12.577</span>, <span class="op">-</span><span class="fl">20.265</span>],</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S1RTC"</span>: [<span class="op">-</span><span class="fl">10.93</span>, <span class="op">-</span><span class="fl">17.329</span>],</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NDVI"</span>: [<span class="fl">0.327</span>],</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"DEM"</span>: [<span class="fl">651.663</span>],</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"std"</span>: {</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2L1C"</span>: [<span class="fl">1673.639</span>, <span class="fl">1722.641</span>, <span class="fl">1602.205</span>, <span class="fl">1873.138</span>, <span class="fl">1866.055</span>, <span class="fl">1779.839</span>, <span class="fl">1776.496</span>, <span class="fl">1724.114</span>, <span class="fl">1771.041</span>, <span class="fl">1079.786</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">512.404</span>, <span class="fl">1340.879</span>, <span class="fl">1172.435</span>],</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2L2A"</span>: [<span class="fl">2131.157</span>, <span class="fl">2163.666</span>, <span class="fl">2059.311</span>, <span class="fl">2152.477</span>, <span class="fl">2105.179</span>, <span class="fl">1912.773</span>, <span class="fl">1842.326</span>, <span class="fl">1893.568</span>, <span class="fl">1775.656</span>, <span class="fl">1814.907</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">1436.282</span>, <span class="fl">1336.155</span>],</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2RGB"</span>: [<span class="fl">69.905</span>, <span class="fl">53.708</span>, <span class="fl">53.378</span>],</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S1GRD"</span>: [<span class="fl">5.179</span>, <span class="fl">5.872</span>],</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S1RTC"</span>: [<span class="fl">4.391</span>, <span class="fl">4.459</span>],</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NDVI"</span>: [<span class="fl">0.322</span>],</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"DEM"</span>: [<span class="fl">928.168</span>]</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We specifically need to pass Sentinel 2 L1C means and stds, but only for the 6 bands we are subsetting for input into prithvi.</p>
<div id="ffd415d5" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>S2L1C_prithvi_means <span class="op">=</span> [statistics[<span class="st">"mean"</span>][<span class="st">"S2L1C"</span>][i] <span class="cf">for</span> i <span class="kw">in</span> prithvi_subset]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>S2L1C_prithvi_stds <span class="op">=</span> [statistics[<span class="st">"std"</span>][<span class="st">"S2L1C"</span>][i] <span class="cf">for</span> i <span class="kw">in</span> prithvi_subset]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(S2L1C_prithvi_means)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(S2L1C_prithvi_stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="transforms" class="level4">
<h4 class="anchored" data-anchor-id="transforms">Transforms</h4>
<p>Transforms allow you to make changes to your data on the fly before feeding them to a model for training. There are three important types of transforms:</p>
<ul>
<li>Reshaping/resizing/clipping: To get your data into the shape your model expects.</li>
<li>Data augmentations: If you don‚Äôt have a lot of training data, you can ‚Äúaugment‚Äù your dataset by presenting changed versions of your images to the model. For example, flip your images. This type of transform generally should only happen to your training data, and not your validation and testing data.</li>
<li>Make your image a tensor (the data format that GPUs can use)</li>
</ul>
<p>We can use albumentations to do any of these.</p>
<div id="9494426d" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> albumentations</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>train_transforms <span class="op">=</span> albumentations.Compose([</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    albumentations.Resize(<span class="dv">224</span>, <span class="dv">224</span>), <span class="co"># go from 64x64 to 224x224 (Prithvi expected size)</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    albumentations.HorizontalFlip(), <span class="co"># augmentation</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    albumentations.pytorch.transforms.ToTensorV2(),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Same transforms but without augmentations for validation and testing</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>val_test_transforms <span class="op">=</span> albumentations.Compose([</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    albumentations.Resize(<span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    albumentations.pytorch.transforms.ToTensorV2(),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="define-your-datamodule" class="level3">
<h3 class="anchored" data-anchor-id="define-your-datamodule">Define your DataModule</h3>
<div id="22c7327e" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.datamodules <span class="im">import</span> GenericNonGeoClassificationDataModule</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>datamodule <span class="op">=</span> GenericNonGeoClassificationDataModule(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">16</span>, <span class="co"># How many images to give the model at once. More = faster, but more RAM is needed</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    num_workers<span class="op">=</span><span class="dv">0</span>, <span class="co"># extra CPU threads for image loading</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Where is our data? In our case, all splits are in the same folder</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    train_data_root<span class="op">=</span>EUROSAT,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    val_data_root<span class="op">=</span>EUROSAT,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    test_data_root<span class="op">=</span>EUROSAT,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Because images for all splits are in the same place, we need to specify our split files</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    train_split<span class="op">=</span>TRAIN_SPLIT,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    val_split<span class="op">=</span>VAL_SPLIT,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    test_split<span class="op">=</span>TEST_SPLIT,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># means and standard deviations for the bands being input into the model</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    means<span class="op">=</span>S2L1C_prithvi_means,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    stds<span class="op">=</span>S2L1C_prithvi_stds,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># number of classes</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="bu">len</span>(class_names),</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tranforms, defined using albumentations</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    train_transform<span class="op">=</span>train_transforms,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    val_transform<span class="op">=</span>val_test_transforms,</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    test_transform<span class="op">=</span>val_test_transforms,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bands of our dataset</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    dataset_bands<span class="op">=</span>sentinel2_bands,</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bands to input into our model</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    output_bands<span class="op">=</span>prithvi_bands,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>datamodule.setup(<span class="st">"fit"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="check-your-datamodule" class="level3">
<h3 class="anchored" data-anchor-id="check-your-datamodule">Check your DataModule</h3>
<p>To ensure that the data are as we would expect the model to find them, we can manually iterate through a batch of the datamodule to inspect it.</p>
<div id="9565f378" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>batch <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(datamodule.train_dataloader()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0361dcb5" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Batch keys: </span><span class="sc">{</span>batch<span class="sc">.</span>keys()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image shape: </span><span class="sc">{</span>batch[<span class="st">'image'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Label shape: </span><span class="sc">{</span>batch[<span class="st">'label'</span>]<span class="sc">.</span>shape <span class="cf">if</span> <span class="st">'label'</span> <span class="kw">in</span> batch <span class="cf">else</span> batch[<span class="st">'labels'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the actual values</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Image dtype: </span><span class="sc">{</span>batch[<span class="st">'image'</span>]<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image min/max: </span><span class="sc">{</span>batch[<span class="st">'image'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>batch[<span class="st">'image'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Labels: </span><span class="sc">{</span>batch[<span class="st">'label'</span>] <span class="cf">if</span> <span class="st">'label'</span> <span class="kw">in</span> batch <span class="cf">else</span> batch[<span class="st">'labels'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As expected, we have 16 images with 6 bands and resized to the width and height the model expects.</p>
<p>Notice the min and max have not been normalized. This is because normalization occurs during every training and validation step, which happens below.</p>
</section>
</section>
<section id="step-3-get-your-task-set-up" class="level2">
<h2 class="anchored" data-anchor-id="step-3-get-your-task-set-up">Step 3: Get your Task set up</h2>
<p>TerraTorch has several Lightning Trainers to easily handle model training, and has Tasks defined for each major task type. We will be using the ClassificationTask.</p>
<p>These Tasks are where you can define your model choice and model hyperparameters.</p>
<section id="choose-your-model-from-the-model-factory" class="level3">
<h3 class="anchored" data-anchor-id="choose-your-model-from-the-model-factory">Choose your model from the model factory</h3>
<p>If you don‚Äôt know which model you would like to use, you can explore what is available in TerraTorch‚Äôs model factory.</p>
<section id="explore-encoders" class="level4">
<h4 class="anchored" data-anchor-id="explore-encoders">Explore encoders</h4>
<div id="538f2e18" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.registry <span class="im">import</span> BACKBONE_REGISTRY</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># List all the available backbones from different sources</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, source <span class="kw">in</span> BACKBONE_REGISTRY._sources.items():</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">====</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">====="</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">list</span>(source))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="18ea5d07" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># let's just list out the Prithvi models in the terratorch source</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>([mod <span class="cf">for</span> mod <span class="kw">in</span> BACKBONE_REGISTRY._sources[<span class="st">'terratorch'</span>] <span class="cf">if</span> <span class="st">'prithvi'</span> <span class="kw">in</span> mod])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are many different prithvi versions to select from ‚Äì for this demo we will choose the smaller <code>prithvi_eo_v1_100</code>.</p>
</section>
<section id="explore-decoders" class="level4">
<h4 class="anchored" data-anchor-id="explore-decoders">Explore decoders</h4>
<div id="9d5550ed" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.registry <span class="im">import</span> DECODER_REGISTRY</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check available decoders</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, source <span class="kw">in</span> DECODER_REGISTRY._sources.items():</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">====</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">====="</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">list</span>(source))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We choose the FCNDecoder because it is good for Classification tasks.</p>
</section>
</section>
<section id="define-your-task" class="level3">
<h3 class="anchored" data-anchor-id="define-your-task">Define your Task</h3>
<div id="19e4981e" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.tasks <span class="im">import</span> ClassificationTask</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> ClassificationTask(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define your model</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    model_factory<span class="op">=</span><span class="st">"EncoderDecoderFactory"</span>, <span class="co"># TerraTorch's EncoderDecoderFactory, where we found our models</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    model_args<span class="op">=</span>{</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'backbone'</span>: <span class="st">'prithvi_eo_v1_100'</span>, <span class="co"># Smaller Prithvi model for demo</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'backbone_pretrained'</span>: <span class="va">True</span>, <span class="co"># Train from scratch or use pre-trained weights?</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'decoder'</span>: <span class="st">'FCNDecoder'</span>, <span class="co"># Chosen decoder for classification</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'num_classes'</span>: <span class="bu">len</span>(class_names),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># What would you like to train?</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    freeze_backbone<span class="op">=</span><span class="va">True</span>, <span class="co"># Do not update prithvi weights for demo</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    freeze_decoder<span class="op">=</span><span class="va">False</span>, <span class="co"># Train the decoder</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally, change hyperparameters from the defaults</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    loss<span class="op">=</span><span class="st">'ce'</span>,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">1e-4</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-4-train-your-model" class="level2">
<h2 class="anchored" data-anchor-id="step-4-train-your-model">Step 4: Train your model</h2>
<p>Now that we have our Task and DataModule, we can easily use PyTorch Lightning to train our model.</p>
<p>We also use Weights and Biases to check our progress during training.</p>
<div id="216e1858" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch.loggers <span class="im">import</span> WandbLogger</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch <span class="im">import</span> Trainer</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch.callbacks <span class="im">import</span> EarlyStopping, ModelCheckpoint, RichProgressBar, LearningRateMonitor</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Auto-detect best precision based on available hardware</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> <span class="st">"16-mixed"</span>  <span class="co"># CUDA supports mixed precision well</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"‚úì Using CUDA GPU with 16-bit mixed precision"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> torch.backends.mps.is_available():</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> <span class="st">"32"</span>  <span class="co"># MPS has limited 16-bit support</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"‚úì Using MPS (Mac GPU) with 32-bit precision"</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> <span class="st">"32"</span>  <span class="co"># CPU doesn't benefit from mixed precision</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"‚ö† Using CPU with 32-bit precision"</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize callbacks</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the best and the last model</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>checkpoint_callback <span class="op">=</span> ModelCheckpoint(</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span>task.monitor, save_top_k<span class="op">=</span><span class="dv">1</span>, save_last<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop training if validation metrics stop improving for a certain number of epochs</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>early_stopping_callback <span class="op">=</span> EarlyStopping(</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span>task.monitor, min_delta<span class="op">=</span><span class="fl">0.00</span>, patience<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Check your progress and results during training using Weights and Biases.</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co"># You'll have to make an account but it's very useful.</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Just click the link it gives you to watch your training progress plotted in real time.</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>wandb_logger <span class="op">=</span> WandbLogger(log_model<span class="op">=</span><span class="st">"all"</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Define your Trainer</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> Trainer(</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    accelerator<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    devices<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Number of GPUs. Interactive mode recommended with 1 device</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    precision<span class="op">=</span>precision,  <span class="co"># Mac MPS has limited support for 16-bit floats</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># precision="16-mixed", # Use 16-bit floats as opposed to 32-bit (higher precision) when it's safe to save on time and memory</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    callbacks<span class="op">=</span>[</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        RichProgressBar(),</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        checkpoint_callback,</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>        early_stopping_callback,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>        LearningRateMonitor(logging_interval<span class="op">=</span><span class="st">"epoch"</span>),</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">=</span>wandb_logger,</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    max_epochs<span class="op">=</span><span class="dv">100</span>,  <span class="co"># Train for up to 100 epochs</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    default_root_dir<span class="op">=</span><span class="st">'output/tutorial'</span>,  <span class="co"># where checkpoints/logs go.</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    log_every_n_steps<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    check_val_every_n_epoch<span class="op">=</span><span class="dv">1</span>  <span class="co"># How frequently to calcualte validation performance</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit your model!</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> trainer.fit(model<span class="op">=</span>task, datamodule<span class="op">=</span>datamodule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5-run-inference-with-your-trained-model" class="level2">
<h2 class="anchored" data-anchor-id="step-5-run-inference-with-your-trained-model">Step 5: Run inference with your trained model</h2>
<p>Now that we have a trained model, let‚Äôs see how to use it for predictions on new images.</p>
<section id="load-the-best-checkpoint" class="level3">
<h3 class="anchored" data-anchor-id="load-the-best-checkpoint">Load the best checkpoint</h3>
<p>After training, the best model is saved. Let‚Äôs load it.</p>
<div id="d7339bd4" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the best model from checkpoint</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>best_model_path <span class="op">=</span> checkpoint_callback.best_model_path</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best model saved at: </span><span class="sc">{</span>best_model_path<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2b3c1ef5" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model for inference</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.tasks <span class="im">import</span> ClassificationTask</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>trained_task <span class="op">=</span> ClassificationTask.load_from_checkpoint(best_model_path)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>trained_task.<span class="bu">eval</span>() <span class="co"># set to evaluation mode</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-some-test-images" class="level3">
<h3 class="anchored" data-anchor-id="get-some-test-images">Get some test images</h3>
<div id="eecb7dea" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a batch from the test dataloader</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>val_batch <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(datamodule.val_dataloader()))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>val_images <span class="op">=</span> val_batch[<span class="st">'image'</span>]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>val_labels <span class="op">=</span> val_batch[<span class="st">'label'</span>]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Validation batch shape: </span><span class="sc">{</span>val_images<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Labels: </span><span class="sc">{</span>val_labels<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-predictions" class="level3">
<h3 class="anchored" data-anchor-id="run-predictions">Run predictions</h3>
<div id="436f0809" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> trained_task(val_images)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Access the logits from the ModelOutput object</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>logits <span class="op">=</span> predictions.output  <span class="co"># or predictions.logits depending on the model</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predicted classes</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>predicted_classes <span class="op">=</span> logits.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted labels: </span><span class="sc">{</span>predicted_classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"True labels: </span><span class="sc">{</span>val_labels<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compare-predictions-to-ground-truth" class="level3">
<h3 class="anchored" data-anchor-id="compare-predictions-to-ground-truth">Compare predictions to ground truth</h3>
<div id="8783c75a" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate accuracy on this batch</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>correct <span class="op">=</span> (predicted_classes <span class="op">==</span> test_labels).<span class="bu">sum</span>().item()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> correct <span class="op">/</span> <span class="bu">len</span>(test_labels)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Batch accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Correct: </span><span class="sc">{</span>correct<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(test_labels)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-predictions" class="level3">
<h3 class="anchored" data-anchor-id="visualize-predictions">Visualize predictions</h3>
<div id="a19e67d8" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick first 4 images to visualize</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>n_images <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, n_images, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">4</span>))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_images):</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use to_rgb function to get an RGB image for visualization</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    img_numpy <span class="op">=</span> val_images[i].cpu().numpy()  <span class="co"># Add .cpu().numpy()</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> to_rgb(img_numpy)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    axes[i].imshow(rgb)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    true_label <span class="op">=</span> class_names[val_labels[i]]</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    pred_label <span class="op">=</span> class_names[predicted_classes[i]]</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color code: green if correct, red if wrong</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> <span class="st">'green'</span> <span class="cf">if</span> val_labels[i] <span class="op">==</span> predicted_classes[i] <span class="cf">else</span> <span class="st">'red'</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(<span class="ss">f"True: </span><span class="sc">{</span>true_label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Pred: </span><span class="sc">{</span>pred_label<span class="sc">}</span><span class="ss">"</span>, color<span class="op">=</span>color)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    axes[i].axis(<span class="st">'off'</span>)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-prediction-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="get-prediction-probabilities">Get prediction probabilities</h3>
<div id="bf83769a" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get probabilities instead of just the class</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    model_output <span class="op">=</span> trained_task(test_images)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> model_output.output  <span class="co"># Extract the actual tensor</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    probabilities <span class="op">=</span> F.softmax(logits, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the first prediction</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"First image probabilities:"</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(class_names):</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>class_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>probabilities[<span class="dv">0</span>, i]<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluate-on-full-test-set" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-on-full-test-set">Evaluate on full test set</h3>
<div id="7a47798d" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the model on the full test set</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>test_results <span class="op">=</span> trainer.test(trained_task, datamodule<span class="op">=</span>datamodule)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Test set results:"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="bonus-exploring-model-embeddings" class="level2">
<h2 class="anchored" data-anchor-id="bonus-exploring-model-embeddings">Bonus: Exploring model embeddings</h2>
<p>Let‚Äôs visualize the embeddings of the pretrained and fine-tuned models to see how the classification head might have learned to separate classes, even though the backbone embeddings remain unchanged.</p>
<section id="visualize-embedding-space-with-pca" class="level3">
<h3 class="anchored" data-anchor-id="visualize-embedding-space-with-pca">Visualize embedding space with PCA</h3>
<div id="bd24b47a" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase the number of points by using both validation and test images</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (Or, if suitable, all available data splits)</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>all_embeddings <span class="op">=</span> []</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>all_labels <span class="op">=</span> []</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use both validation and test sets for more points in PCA</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> loader <span class="kw">in</span> [datamodule.val_dataloader(), datamodule.test_dataloader()]:</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> loader:</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>            images <span class="op">=</span> batch[<span class="st">'image'</span>]</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> batch[<span class="st">'label'</span>]</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>            emb <span class="op">=</span> pretrained_task.model.encoder(images)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>            emb_flat <span class="op">=</span> emb.mean(dim<span class="op">=</span><span class="dv">1</span>)  <span class="co"># Global average pooling</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>            all_embeddings.append(emb_flat.cpu())</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>            all_labels.append(labels.cpu())</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>all_embeddings <span class="op">=</span> torch.cat(all_embeddings).numpy()</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>all_labels <span class="op">=</span> torch.cat(all_labels).numpy()</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA to 2D</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>pca <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>embeddings_2d <span class="op">=</span> pca.fit_transform(all_embeddings)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot with class names as legend entries</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>scatter <span class="op">=</span> plt.scatter(</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    embeddings_2d[:, <span class="dv">0</span>], embeddings_2d[:, <span class="dv">1</span>],</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    c<span class="op">=</span>all_labels, cmap<span class="op">=</span><span class="st">'tab10'</span>, alpha<span class="op">=</span><span class="fl">0.6</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Build legend mapping colors back to class names</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.lines <span class="im">import</span> Line2D</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>handles <span class="op">=</span> []</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>unique_labels <span class="op">=</span> np.unique(all_labels)</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label <span class="kw">in</span> unique_labels:</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> scatter.cmap(scatter.norm(label))</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    handles.append(Line2D(</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>], [<span class="dv">0</span>], marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span>class_names[label],</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span>color, markersize<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.6</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>plt.legend(handles<span class="op">=</span>handles, title<span class="op">=</span><span class="st">"Class"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.05</span>, <span class="dv">1</span>), loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Validation &amp; Test Set Embeddings (PCA)</span><span class="ch">\n</span><span class="st">(same for pretrained &amp; fine-tuned)'</span>)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'PC1'</span>)</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'PC2'</span>)</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kcaylor\.github\.io\/GEOG-288KC-geospatial-foundation-models");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Getting started with fine tuning with TerraTorch"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> geoai</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>TerraTorch is a package that allows you to easily use and fine tune geospatial foundation models (GeoFMs). This tutorial walks through how to get started with TerraTorch to fine tune a GeoFM on your own data and task, whatever that may be.</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>Achieving fine tuning and inference using TerraTorch can be achieved in four steps:</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Organize your data:** Make sure your inputs, labels, and spits are organized in a standardized way that TerraTorch generic DataModules can interpret</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Set up your DataModule:** Use TerraTorch generic DataModules to create an object which reads in your data, makes any necessary adjustments, and passes it to your model in the format it expects for training.</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Set up your Task:** Identify your chosen task, choose your model and define hyperparemeters</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Train your model:** Use Pytorch Lightning to handle training and logging for a set number of epochs.</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>In this demo, we will show how to fine tune Prithvi on a subset of the EuroSAT benchmark, which classifies 64x64 pixel Sentinel 2 L1C images into one of 10 classes. The demo is written in a general way to help users adapt this code to their specific use case.</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 0: Setup</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="fu">### HuggingFace cache</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>Because we are on a shared server with shared conda environment, we need to reorient where huggingface downloads things like model weights and datasets</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify where you want model weights/datasets to be saved</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>DATA_PATH <span class="op">=</span> <span class="st">'/Users/kellycaylor/dev/geoAI/data'</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up environment variables that are used by HuggingFace</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"HF_HOME"</span>] <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"hfhome"</span>)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"HF_HUB_CACHE"</span>] <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"hub"</span>)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"HF_DATASETS_CACHE"</span>] <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"datasets"</span>)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"TRANSFORMERS_CACHE"</span>] <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"transformers"</span>)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Get your data in the right format for TerraTorch</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>TerraTorch makes your life easier if you organize your data in standard ways. Specifically, following these conventions will allow you to use their generic DataModules and save your the trouble of writing your own.</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="fu">### File organization</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**Classification:** Organize your images into different folders depending on their class (this is how EuroSAT is organized). Alternatively, have a metadata file listing</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**Segmentation/regression:** Have images and their labels (masks or continuous outputs) have the same name but followed by an image vs. mask or label identifier (e.g. image: <span class="in">`Im_1_img.tif`</span> and <span class="in">`Im_1_mask.tif`</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a><span class="fu">#### EuroSAT classification example</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>We can retrieve a subsample of the EuroSAT dataset using torchgeo. Luckily, we will show it is already in the format TerraTorch expects for a classification task.</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchgeo.datasets <span class="im">import</span> EuroSAT100 <span class="co"># 100 image subset from EuroSAT</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>EuroSAT100(</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>    root<span class="op">=</span>DATA_PATH, <span class="co"># make sure you have defined the path where you want data saved</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>    split<span class="op">=</span><span class="st">'train'</span>,</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>    download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>EuroSAT100(</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>    root<span class="op">=</span>DATA_PATH,</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>    split<span class="op">=</span><span class="st">'val'</span>,</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>    download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>EuroSAT100(</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>    root<span class="op">=</span>DATA_PATH,</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>    split<span class="op">=</span><span class="st">'test'</span>,</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>    download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>When opening inspecting the downloaded dataset, you will find that the data will be stored at the following path:</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the location of the saved EUROSAT data</span></span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>EUROSAT <span class="op">=</span> DATA_PATH <span class="op">+</span> <span class="st">"/ds/images/remote_sensing/otherDatasets/sentinel_2/tif/"</span></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>There is one folder for each class, each containing <span class="in">`.tif`</span> files with the images to be classified.</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a><span class="co"># List the folders each containing images for a given EuroSAT class</span></span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>class_paths <span class="op">=</span> [item <span class="cf">for</span> item <span class="kw">in</span> Path(EUROSAT).iterdir()]</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>class_names <span class="op">=</span> [item.name <span class="cf">for</span> item <span class="kw">in</span> class_paths]</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(class_names)</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a><span class="fu">### Specify splits</span></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>To specify which images belong to which split, you have two options:</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>provide <span class="in">`.txt`</span> files that have the names of the images in each split in them</span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>organize the splits into different folders</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a><span class="fu">#### EuroSAT example</span></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>In the case of EuroSAT, the names of the images belonging to each split are saved as <span class="in">`.txt`</span> files.</span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the paths to each split for use in the DataModule setup</span></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>TRAIN_SPLIT <span class="op">=</span> DATA_PATH <span class="op">+</span> <span class="st">'/eurosat-100-train.txt'</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>VAL_SPLIT <span class="op">=</span> DATA_PATH <span class="op">+</span> <span class="st">'/eurosat-100-val.txt'</span></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>TEST_SPLIT <span class="op">=</span> DATA_PATH <span class="op">+</span> <span class="st">'/eurosat-100-test.txt'</span></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Get your DataModule set up</span></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inspect your data</span></span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>It is important to have a good grasp of the contents of your data in order to set up the DataModule properly. It can therefore be useful to do a bit of exploration and visualization.</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the first image in each class for inspection</span></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a><span class="co"># get the first image in each class</span></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>image_sample <span class="op">=</span> [<span class="bu">next</span>(folder.iterdir()) <span class="cf">for</span> folder <span class="kw">in</span> class_paths] <span class="co"># list of 10 images</span></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a><span class="co"># read all 10 sample images</span></span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>ims <span class="op">=</span> [rasterio.<span class="bu">open</span>(image).read() <span class="cf">for</span> image <span class="kw">in</span> image_sample]</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Image statistics</span></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>By inspecting the first image, we find that we have 13 bands per image (corresponding to the 13 Sentinel-2 L1C bands) and images are 64x64 pixels. Neither of these is what Prithvi expects, so it's important to know this so we can adjust it in the DataLoader.</span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>We also note that the units are in reflectance values.</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a><span class="co"># print some statistics for the first image</span></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Shape:"</span>, ims[<span class="dv">1</span>].shape)</span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Means by band:"</span>, ims[<span class="dv">1</span>].mean(axis<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>)))</span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Stds by band:"</span>, ims[<span class="dv">1</span>].std(axis<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>)))</span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualization</span></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_rgb(img):</span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>    <span class="co"># select the r,g,b bands</span></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> img[[<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>]].astype(<span class="bu">float</span>)</span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Follow EuroSAT guidelines for visualization</span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>    <span class="co"># clip to a max of 2750</span></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normalize to 0-1</span></span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> np.clip(rgb, <span class="dv">0</span>, <span class="dv">2750</span>) <span class="op">/</span> <span class="dv">2750</span></span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># go from (CxWxH) to (WxHxC)</span></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> np.transpose(rgb, (<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rgb</span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.ravel()</span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (ax, img, name) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes, ims, class_names)):</span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> to_rgb(img)</span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>    ax.imshow(rgb)</span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>    ax.set_title(name)</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>    ax.axis(<span class="st">"off"</span>)</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a><span class="fu">### Define bands, statistics, and transforms</span></span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>There are a few important parameters we will need to define when setting up our DataModule in addition to the location of the data and splits that we defined in Step 1.</span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>We specifically use the GenericNonGeoClassificationDataModule, though all generic DataModules will need these inputs. You can always learn more about the arguments for a given DataModule by adapting the following code:</span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.datamodules <span class="im">import</span> GenericNonGeoClassificationDataModule</span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>?GenericNonGeoClassificationDataModule</span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Band names</span></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a>We need to tell the datamodule which bands we actually want to go into the model.</span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a>In our case, we have 13 sentinel 2 bands, but Prithvi is trained on 6 landsay bands, so we need to subset them.</span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>sentinel2_bands <span class="op">=</span> [</span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B1"</span>, <span class="st">"B2"</span>, <span class="st">"B3"</span>, <span class="st">"B4"</span>, <span class="st">"B5"</span>, <span class="st">"B6"</span>, <span class="st">"B7"</span>,</span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B8"</span>, <span class="st">"B8A"</span>, <span class="st">"B9"</span>, <span class="st">"B10"</span>, <span class="st">"B11"</span>, <span class="st">"B12"</span></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a><span class="co"># The subset of our bands Prithvi will take</span></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a>prithvi_subset <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">11</span>, <span class="dv">12</span>]</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a>prithvi_bands <span class="op">=</span> [sentinel2_bands[i] <span class="cf">for</span> i <span class="kw">in</span> prithvi_subset]</span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prithvi_bands)</span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Means and standard deviations</span></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>We need band-level means and standard deviations. Either compute them yourself over your entire dataset, or get general numbers that work well for your data type.</span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>We have S2 L1C data. We can use TerraMesh statistics I grabbed from their huggingface: https://huggingface.co/api/resolve-cache/datasets/ibm-esa-geospatial/TerraMesh/6c548cdacdd70e98a236de9f5b708d4b9dadf253/terramesh.py</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a>statistics <span class="op">=</span> {</span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean"</span>: {</span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2L1C"</span>: [<span class="fl">2357.090</span>, <span class="fl">2137.398</span>, <span class="fl">2018.799</span>, <span class="fl">2082.998</span>, <span class="fl">2295.663</span>, <span class="fl">2854.548</span>, <span class="fl">3122.860</span>, <span class="fl">3040.571</span>, <span class="fl">3306.491</span>, <span class="fl">1473.849</span>,</span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">506.072</span>, <span class="fl">2472.840</span>, <span class="fl">1838.943</span>],</span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2L2A"</span>: [<span class="fl">1390.461</span>, <span class="fl">1503.332</span>, <span class="fl">1718.211</span>, <span class="fl">1853.926</span>, <span class="fl">2199.116</span>, <span class="fl">2779.989</span>, <span class="fl">2987.025</span>, <span class="fl">3083.248</span>, <span class="fl">3132.235</span>, <span class="fl">3162.989</span>,</span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">2424.902</span>, <span class="fl">1857.665</span>],</span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2RGB"</span>: [<span class="fl">110.349</span>, <span class="fl">99.507</span>, <span class="fl">75.843</span>],</span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S1GRD"</span>: [<span class="op">-</span><span class="fl">12.577</span>, <span class="op">-</span><span class="fl">20.265</span>],</span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S1RTC"</span>: [<span class="op">-</span><span class="fl">10.93</span>, <span class="op">-</span><span class="fl">17.329</span>],</span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NDVI"</span>: [<span class="fl">0.327</span>],</span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a>        <span class="st">"DEM"</span>: [<span class="fl">651.663</span>],</span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a>    <span class="st">"std"</span>: {</span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2L1C"</span>: [<span class="fl">1673.639</span>, <span class="fl">1722.641</span>, <span class="fl">1602.205</span>, <span class="fl">1873.138</span>, <span class="fl">1866.055</span>, <span class="fl">1779.839</span>, <span class="fl">1776.496</span>, <span class="fl">1724.114</span>, <span class="fl">1771.041</span>, <span class="fl">1079.786</span>,</span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">512.404</span>, <span class="fl">1340.879</span>, <span class="fl">1172.435</span>],</span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2L2A"</span>: [<span class="fl">2131.157</span>, <span class="fl">2163.666</span>, <span class="fl">2059.311</span>, <span class="fl">2152.477</span>, <span class="fl">2105.179</span>, <span class="fl">1912.773</span>, <span class="fl">1842.326</span>, <span class="fl">1893.568</span>, <span class="fl">1775.656</span>, <span class="fl">1814.907</span>,</span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">1436.282</span>, <span class="fl">1336.155</span>],</span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S2RGB"</span>: [<span class="fl">69.905</span>, <span class="fl">53.708</span>, <span class="fl">53.378</span>],</span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S1GRD"</span>: [<span class="fl">5.179</span>, <span class="fl">5.872</span>],</span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S1RTC"</span>: [<span class="fl">4.391</span>, <span class="fl">4.459</span>],</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NDVI"</span>: [<span class="fl">0.322</span>],</span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a>        <span class="st">"DEM"</span>: [<span class="fl">928.168</span>]</span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a>We specifically need to pass Sentinel 2 L1C means and stds, but only for the 6 bands we are subsetting for input into prithvi.</span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>S2L1C_prithvi_means <span class="op">=</span> [statistics[<span class="st">"mean"</span>][<span class="st">"S2L1C"</span>][i] <span class="cf">for</span> i <span class="kw">in</span> prithvi_subset]</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a>S2L1C_prithvi_stds <span class="op">=</span> [statistics[<span class="st">"std"</span>][<span class="st">"S2L1C"</span>][i] <span class="cf">for</span> i <span class="kw">in</span> prithvi_subset]</span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(S2L1C_prithvi_means)</span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(S2L1C_prithvi_stds)</span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Transforms</span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>Transforms allow you to make changes to your data on the fly before feeding them to a model for training. There are three important types of transforms:</span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Reshaping/resizing/clipping: To get your data into the shape your model expects.</span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Data augmentations: If you don't have a lot of training data, you can "augment" your dataset by presenting changed versions of your images to the model. For example, flip your images. This type of transform generally should only happen to your training data, and not your validation and testing data.</span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Make your image a tensor (the data format that GPUs can use)</span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a>We can use albumentations to do any of these.</span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> albumentations</span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a>train_transforms <span class="op">=</span> albumentations.Compose([</span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a>    albumentations.Resize(<span class="dv">224</span>, <span class="dv">224</span>), <span class="co"># go from 64x64 to 224x224 (Prithvi expected size)</span></span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a>    albumentations.HorizontalFlip(), <span class="co"># augmentation</span></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a>    albumentations.pytorch.transforms.ToTensorV2(),</span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a><span class="co"># Same transforms but without augmentations for validation and testing</span></span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a>val_test_transforms <span class="op">=</span> albumentations.Compose([</span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a>    albumentations.Resize(<span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a>    albumentations.pytorch.transforms.ToTensorV2(),</span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a><span class="fu">### Define your DataModule</span></span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.datamodules <span class="im">import</span> GenericNonGeoClassificationDataModule</span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a>datamodule <span class="op">=</span> GenericNonGeoClassificationDataModule(</span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">16</span>, <span class="co"># How many images to give the model at once. More = faster, but more RAM is needed</span></span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a>    num_workers<span class="op">=</span><span class="dv">0</span>, <span class="co"># extra CPU threads for image loading</span></span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Where is our data? In our case, all splits are in the same folder</span></span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a>    train_data_root<span class="op">=</span>EUROSAT,</span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a>    val_data_root<span class="op">=</span>EUROSAT,</span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a>    test_data_root<span class="op">=</span>EUROSAT,</span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Because images for all splits are in the same place, we need to specify our split files</span></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a>    train_split<span class="op">=</span>TRAIN_SPLIT,</span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a>    val_split<span class="op">=</span>VAL_SPLIT,</span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>    test_split<span class="op">=</span>TEST_SPLIT,</span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># means and standard deviations for the bands being input into the model</span></span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a>    means<span class="op">=</span>S2L1C_prithvi_means,</span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>    stds<span class="op">=</span>S2L1C_prithvi_stds,</span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a>    <span class="co"># number of classes</span></span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="bu">len</span>(class_names),</span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tranforms, defined using albumentations</span></span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>    train_transform<span class="op">=</span>train_transforms,</span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a>    val_transform<span class="op">=</span>val_test_transforms,</span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a>    test_transform<span class="op">=</span>val_test_transforms,</span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bands of our dataset</span></span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a>    dataset_bands<span class="op">=</span>sentinel2_bands,</span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bands to input into our model</span></span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a>    output_bands<span class="op">=</span>prithvi_bands,</span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a>datamodule.setup(<span class="st">"fit"</span>)</span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a><span class="fu">### Check your DataModule</span></span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a>To ensure that the data are as we would expect the model to find them, we can manually iterate through a batch of the datamodule to inspect it.</span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a>batch <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(datamodule.train_dataloader()))</span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Batch keys: </span><span class="sc">{</span>batch<span class="sc">.</span>keys()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image shape: </span><span class="sc">{</span>batch[<span class="st">'image'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Label shape: </span><span class="sc">{</span>batch[<span class="st">'label'</span>]<span class="sc">.</span>shape <span class="cf">if</span> <span class="st">'label'</span> <span class="kw">in</span> batch <span class="cf">else</span> batch[<span class="st">'labels'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the actual values</span></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Image dtype: </span><span class="sc">{</span>batch[<span class="st">'image'</span>]<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image min/max: </span><span class="sc">{</span>batch[<span class="st">'image'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>batch[<span class="st">'image'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Labels: </span><span class="sc">{</span>batch[<span class="st">'label'</span>] <span class="cf">if</span> <span class="st">'label'</span> <span class="kw">in</span> batch <span class="cf">else</span> batch[<span class="st">'labels'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a>As expected, we have 16 images with 6 bands and resized to the width and height the model expects.</span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a>Notice the min and max have not been normalized. This is because normalization occurs during every training and validation step, which happens below.</span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Get your Task set up</span></span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a>TerraTorch has several Lightning Trainers to easily handle model training, and has Tasks defined for each major task type. We will be using the ClassificationTask.</span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a>These Tasks are where you can define your model choice and model hyperparameters.</span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a><span class="fu">### Choose your model from the model factory</span></span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a>If you don't know which model you would like to use, you can explore what is available in TerraTorch's model factory.</span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Explore encoders</span></span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.registry <span class="im">import</span> BACKBONE_REGISTRY</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a><span class="co"># List all the available backbones from different sources</span></span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, source <span class="kw">in</span> BACKBONE_REGISTRY._sources.items():</span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">====</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">====="</span>)</span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">list</span>(source))</span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a><span class="co"># let's just list out the Prithvi models in the terratorch source</span></span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>([mod <span class="cf">for</span> mod <span class="kw">in</span> BACKBONE_REGISTRY._sources[<span class="st">'terratorch'</span>] <span class="cf">if</span> <span class="st">'prithvi'</span> <span class="kw">in</span> mod])</span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a>There are many different prithvi versions to select from -- for this demo we will choose the smaller <span class="in">`prithvi_eo_v1_100`</span>.</span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Explore decoders</span></span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.registry <span class="im">import</span> DECODER_REGISTRY</span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a><span class="co"># Check available decoders</span></span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, source <span class="kw">in</span> DECODER_REGISTRY._sources.items():</span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">====</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">====="</span>)</span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">list</span>(source))</span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a>We choose the FCNDecoder because it is good for Classification tasks.</span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a><span class="fu">### Define your Task</span></span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.tasks <span class="im">import</span> ClassificationTask</span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> ClassificationTask(</span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define your model</span></span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a>    model_factory<span class="op">=</span><span class="st">"EncoderDecoderFactory"</span>, <span class="co"># TerraTorch's EncoderDecoderFactory, where we found our models</span></span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a>    model_args<span class="op">=</span>{</span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a>        <span class="st">'backbone'</span>: <span class="st">'prithvi_eo_v1_100'</span>, <span class="co"># Smaller Prithvi model for demo</span></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a>        <span class="st">'backbone_pretrained'</span>: <span class="va">True</span>, <span class="co"># Train from scratch or use pre-trained weights?</span></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a>        <span class="st">'decoder'</span>: <span class="st">'FCNDecoder'</span>, <span class="co"># Chosen decoder for classification</span></span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a>        <span class="st">'num_classes'</span>: <span class="bu">len</span>(class_names),</span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a>    <span class="co"># What would you like to train?</span></span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a>    freeze_backbone<span class="op">=</span><span class="va">True</span>, <span class="co"># Do not update prithvi weights for demo</span></span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a>    freeze_decoder<span class="op">=</span><span class="va">False</span>, <span class="co"># Train the decoder</span></span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally, change hyperparameters from the defaults</span></span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a>    loss<span class="op">=</span><span class="st">'ce'</span>,</span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">1e-4</span></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Train your model</span></span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a>Now that we have our Task and DataModule, we can easily use PyTorch Lightning to train our model.</span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a>We also use Weights and Biases to check our progress during training.</span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch.loggers <span class="im">import</span> WandbLogger</span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch <span class="im">import</span> Trainer</span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch.callbacks <span class="im">import</span> EarlyStopping, ModelCheckpoint, RichProgressBar, LearningRateMonitor</span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a><span class="co"># Auto-detect best precision based on available hardware</span></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> <span class="st">"16-mixed"</span>  <span class="co"># CUDA supports mixed precision well</span></span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"‚úì Using CUDA GPU with 16-bit mixed precision"</span>)</span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> torch.backends.mps.is_available():</span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> <span class="st">"32"</span>  <span class="co"># MPS has limited 16-bit support</span></span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"‚úì Using MPS (Mac GPU) with 32-bit precision"</span>)</span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> <span class="st">"32"</span>  <span class="co"># CPU doesn't benefit from mixed precision</span></span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"‚ö† Using CPU with 32-bit precision"</span>)</span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize callbacks</span></span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the best and the last model</span></span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a>checkpoint_callback <span class="op">=</span> ModelCheckpoint(</span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span>task.monitor, save_top_k<span class="op">=</span><span class="dv">1</span>, save_last<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop training if validation metrics stop improving for a certain number of epochs</span></span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a>early_stopping_callback <span class="op">=</span> EarlyStopping(</span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span>task.monitor, min_delta<span class="op">=</span><span class="fl">0.00</span>, patience<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a><span class="co"># Check your progress and results during training using Weights and Biases.</span></span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a><span class="co"># You'll have to make an account but it's very useful.</span></span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a><span class="co"># Just click the link it gives you to watch your training progress plotted in real time.</span></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a>wandb_logger <span class="op">=</span> WandbLogger(log_model<span class="op">=</span><span class="st">"all"</span>)</span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a><span class="co"># Define your Trainer</span></span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> Trainer(</span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a>    accelerator<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>    devices<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Number of GPUs. Interactive mode recommended with 1 device</span></span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a>    precision<span class="op">=</span>precision,  <span class="co"># Mac MPS has limited support for 16-bit floats</span></span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a>    <span class="co"># precision="16-mixed", # Use 16-bit floats as opposed to 32-bit (higher precision) when it's safe to save on time and memory</span></span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a>    callbacks<span class="op">=</span>[</span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a>        RichProgressBar(),</span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a>        checkpoint_callback,</span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a>        early_stopping_callback,</span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a>        LearningRateMonitor(logging_interval<span class="op">=</span><span class="st">"epoch"</span>),</span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">=</span>wandb_logger,</span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a>    max_epochs<span class="op">=</span><span class="dv">100</span>,  <span class="co"># Train for up to 100 epochs</span></span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a>    default_root_dir<span class="op">=</span><span class="st">'output/tutorial'</span>,  <span class="co"># where checkpoints/logs go.</span></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a>    log_every_n_steps<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a>    check_val_every_n_epoch<span class="op">=</span><span class="dv">1</span>  <span class="co"># How frequently to calcualte validation performance</span></span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit your model!</span></span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> trainer.fit(model<span class="op">=</span>task, datamodule<span class="op">=</span>datamodule)</span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Run inference with your trained model</span></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a>Now that we have a trained model, let's see how to use it for predictions on new images.</span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load the best checkpoint</span></span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a>After training, the best model is saved. Let's load it.</span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the best model from checkpoint</span></span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a>best_model_path <span class="op">=</span> checkpoint_callback.best_model_path</span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best model saved at: </span><span class="sc">{</span>best_model_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model for inference</span></span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> terratorch.tasks <span class="im">import</span> ClassificationTask</span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a>trained_task <span class="op">=</span> ClassificationTask.load_from_checkpoint(best_model_path)</span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a>trained_task.<span class="bu">eval</span>() <span class="co"># set to evaluation mode</span></span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a><span class="fu">### Get some test images</span></span>
<span id="cb32-540"><a href="#cb32-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a batch from the test dataloader</span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a>val_batch <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(datamodule.val_dataloader()))</span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a>val_images <span class="op">=</span> val_batch[<span class="st">'image'</span>]</span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>val_labels <span class="op">=</span> val_batch[<span class="st">'label'</span>]</span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Validation batch shape: </span><span class="sc">{</span>val_images<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Labels: </span><span class="sc">{</span>val_labels<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a><span class="fu">### Run predictions</span></span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions</span></span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> trained_task(val_images)</span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a><span class="co"># Access the logits from the ModelOutput object</span></span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a>logits <span class="op">=</span> predictions.output  <span class="co"># or predictions.logits depending on the model</span></span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predicted classes</span></span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a>predicted_classes <span class="op">=</span> logits.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted labels: </span><span class="sc">{</span>predicted_classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"True labels: </span><span class="sc">{</span>val_labels<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a><span class="fu">### Compare predictions to ground truth</span></span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate accuracy on this batch</span></span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a>correct <span class="op">=</span> (predicted_classes <span class="op">==</span> test_labels).<span class="bu">sum</span>().item()</span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> correct <span class="op">/</span> <span class="bu">len</span>(test_labels)</span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Batch accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Correct: </span><span class="sc">{</span>correct<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(test_labels)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualize predictions</span></span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick first 4 images to visualize</span></span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a>n_images <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, n_images, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">4</span>))</span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_images):</span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use to_rgb function to get an RGB image for visualization</span></span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>    img_numpy <span class="op">=</span> val_images[i].cpu().numpy()  <span class="co"># Add .cpu().numpy()</span></span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> to_rgb(img_numpy)</span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a>    axes[i].imshow(rgb)</span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a>    true_label <span class="op">=</span> class_names[val_labels[i]]</span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a>    pred_label <span class="op">=</span> class_names[predicted_classes[i]]</span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color code: green if correct, red if wrong</span></span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> <span class="st">'green'</span> <span class="cf">if</span> val_labels[i] <span class="op">==</span> predicted_classes[i] <span class="cf">else</span> <span class="st">'red'</span></span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(<span class="ss">f"True: </span><span class="sc">{</span>true_label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Pred: </span><span class="sc">{</span>pred_label<span class="sc">}</span><span class="ss">"</span>, color<span class="op">=</span>color)</span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a>    axes[i].axis(<span class="st">'off'</span>)</span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a><span class="fu">### Get prediction probabilities</span></span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a><span class="co"># Get probabilities instead of just the class</span></span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a>    model_output <span class="op">=</span> trained_task(test_images)</span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> model_output.output  <span class="co"># Extract the actual tensor</span></span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a>    probabilities <span class="op">=</span> F.softmax(logits, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-630"><a href="#cb32-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the first prediction</span></span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"First image probabilities:"</span>)</span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(class_names):</span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>class_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>probabilities[<span class="dv">0</span>, i]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb32-636"><a href="#cb32-636" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-637"><a href="#cb32-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a><span class="fu">### Evaluate on full test set</span></span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the model on the full test set</span></span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a>test_results <span class="op">=</span> trainer.test(trained_task, datamodule<span class="op">=</span>datamodule)</span>
<span id="cb32-645"><a href="#cb32-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-646"><a href="#cb32-646" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Test set results:"</span>)</span>
<span id="cb32-647"><a href="#cb32-647" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_results)</span>
<span id="cb32-648"><a href="#cb32-648" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bonus: Exploring model embeddings</span></span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a>Let's visualize the embeddings of the pretrained and fine-tuned models to see how the classification head might have learned to separate classes, even though the backbone embeddings remain unchanged.</span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualize embedding space with PCA</span></span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-657"><a href="#cb32-657" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase the number of points by using both validation and test images</span></span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a><span class="co"># (Or, if suitable, all available data splits)</span></span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a>all_embeddings <span class="op">=</span> []</span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a>all_labels <span class="op">=</span> []</span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use both validation and test sets for more points in PCA</span></span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> loader <span class="kw">in</span> [datamodule.val_dataloader(), datamodule.test_dataloader()]:</span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> loader:</span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a>            images <span class="op">=</span> batch[<span class="st">'image'</span>]</span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> batch[<span class="st">'label'</span>]</span>
<span id="cb32-672"><a href="#cb32-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-673"><a href="#cb32-673" aria-hidden="true" tabindex="-1"></a>            emb <span class="op">=</span> pretrained_task.model.encoder(images)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a>            emb_flat <span class="op">=</span> emb.mean(dim<span class="op">=</span><span class="dv">1</span>)  <span class="co"># Global average pooling</span></span>
<span id="cb32-675"><a href="#cb32-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-676"><a href="#cb32-676" aria-hidden="true" tabindex="-1"></a>            all_embeddings.append(emb_flat.cpu())</span>
<span id="cb32-677"><a href="#cb32-677" aria-hidden="true" tabindex="-1"></a>            all_labels.append(labels.cpu())</span>
<span id="cb32-678"><a href="#cb32-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a>all_embeddings <span class="op">=</span> torch.cat(all_embeddings).numpy()</span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a>all_labels <span class="op">=</span> torch.cat(all_labels).numpy()</span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA to 2D</span></span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a>pca <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-684"><a href="#cb32-684" aria-hidden="true" tabindex="-1"></a>embeddings_2d <span class="op">=</span> pca.fit_transform(all_embeddings)</span>
<span id="cb32-685"><a href="#cb32-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot with class names as legend entries</span></span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a>scatter <span class="op">=</span> plt.scatter(</span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a>    embeddings_2d[:, <span class="dv">0</span>], embeddings_2d[:, <span class="dv">1</span>],</span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a>    c<span class="op">=</span>all_labels, cmap<span class="op">=</span><span class="st">'tab10'</span>, alpha<span class="op">=</span><span class="fl">0.6</span></span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a><span class="co"># Build legend mapping colors back to class names</span></span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.lines <span class="im">import</span> Line2D</span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-697"><a href="#cb32-697" aria-hidden="true" tabindex="-1"></a>handles <span class="op">=</span> []</span>
<span id="cb32-698"><a href="#cb32-698" aria-hidden="true" tabindex="-1"></a>unique_labels <span class="op">=</span> np.unique(all_labels)</span>
<span id="cb32-699"><a href="#cb32-699" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label <span class="kw">in</span> unique_labels:</span>
<span id="cb32-700"><a href="#cb32-700" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> scatter.cmap(scatter.norm(label))</span>
<span id="cb32-701"><a href="#cb32-701" aria-hidden="true" tabindex="-1"></a>    handles.append(Line2D(</span>
<span id="cb32-702"><a href="#cb32-702" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>], [<span class="dv">0</span>], marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span>class_names[label],</span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a>        markerfacecolor<span class="op">=</span>color, markersize<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.6</span></span>
<span id="cb32-704"><a href="#cb32-704" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb32-705"><a href="#cb32-705" aria-hidden="true" tabindex="-1"></a>plt.legend(handles<span class="op">=</span>handles, title<span class="op">=</span><span class="st">"Class"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.05</span>, <span class="dv">1</span>), loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb32-706"><a href="#cb32-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-707"><a href="#cb32-707" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Validation &amp; Test Set Embeddings (PCA)</span><span class="ch">\n</span><span class="st">(same for pretrained &amp; fine-tuned)'</span>)</span>
<span id="cb32-708"><a href="#cb32-708" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'PC1'</span>)</span>
<span id="cb32-709"><a href="#cb32-709" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'PC2'</span>)</span>
<span id="cb32-710"><a href="#cb32-710" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-711"><a href="#cb32-711" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-712"><a href="#cb32-712" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/geog-logo.png" class="img-fluid figure-img" width="250"></p>
<figcaption>Department of Geography logo</figcaption>
</figure>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This website is built with <a href="https://github.com/kcaylor/GEOG-288KC-geospatial-foundation-models"><i class="fa-brands fa-github" title="the github octocat logo" aria-label="github"></i></a> and <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>