<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 3: TerraTorch Foundation Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">GEOG 288KC</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">🏠 home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Syllabus.html"> 
<span class="menu-text">📋 syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-sessions" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">💻 weekly sessions</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-weekly-sessions">    
        <li>
    <a class="dropdown-item" href="./chapters/c01-geospatial-data-foundations.html">
 <span class="dropdown-text">Week 1 - 🚀 Core Tools and Data Access</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./chapters/c02-spatial-temporal-attention-mechanisms.html">
 <span class="dropdown-text">Week 2 - ⚡ Rapid Remote Sensing Preprocessing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./chapters/c03a-terratorch-foundations.html">
 <span class="dropdown-text">Week 3a - 🌍 TerraTorch Foundations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./chapters/c03-complete-gfm-architecture.html">
 <span class="dropdown-text">Week 3b - 🤖 Machine Learning on Remote Sensing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./chapters/c04-pretraining-implementation.html">
 <span class="dropdown-text">Week 4 - 🏗️ Foundation Models in Practice</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./chapters/c05-training-loop-optimization.html">
 <span class="dropdown-text">Week 5 - 🔧 Fine-Tuning &amp; Transfer Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./chapters/c06-model-evaluation-analysis.html">
 <span class="dropdown-text">Week 6 - ⏰ Spatiotemporal Modeling &amp; Projects</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cheatsheets" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">👀 cheatsheets</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-cheatsheets">    
        <li>
    <a class="dropdown-item" href="./cheatsheets.html">
 <span class="dropdown-text">📋 All Cheatsheets</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">⚡ Quick Starts</li>
        <li>
    <a class="dropdown-item" href="./extras/cheatsheets/week01_imports.html">
 <span class="dropdown-text">Week 01: Import Guide</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-explainers" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">🧩 explainers</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-explainers">    
        <li class="dropdown-header">1️⃣ Week 1</li>
        <li>
    <a class="dropdown-item" href="./extras/ai-ml-dl-fm-hierarchy.html">
 <span class="dropdown-text">🤖 AI/ML/DL/FM Hierarchy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/geospatial-foundation-model-predictions-standalone.html">
 <span class="dropdown-text">🎯 GFM Predictions (Standalone)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/geospatial-prediction-hierarchy.html">
 <span class="dropdown-text">✅ Geospatial Task/Prediction Types</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/neural_networks_explainer.html">
 <span class="dropdown-text">🧠 Neural Networks: Neurons to Transformers</span></a>
  </li>  
        <li class="dropdown-header">2️⃣ Week 2</li>
        <li>
    <a class="dropdown-item" href="./chapters/c00a-foundation_model_architectures.html">
 <span class="dropdown-text">🏗️ Foundation Model Architectures</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./chapters/c00b-introduction-to-deeplearning-architecture.html">
 <span class="dropdown-text">🎓 Introduction to Deep Learning Architecture</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-extras" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">📖 extras</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-extras">    
        <li class="dropdown-header">🎯 Practical Examples</li>
        <li>
    <a class="dropdown-item" href="./extras/examples/normalization_comparison.html">
 <span class="dropdown-text">Normalization Comparison</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/examples/resnet.html">
 <span class="dropdown-text">ResNet Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/examples/segmentation_finetuning.html">
 <span class="dropdown-text">Segmentation Fine-Tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/examples/text_encoder.html">
 <span class="dropdown-text">Text Encoder</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/examples/tiling-and-patches.html">
 <span class="dropdown-text">Tiling and Patches</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/examples/terratorch_workflows.html">
 <span class="dropdown-text">TerraTorch Workflows</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/resources/course_resources.html">
 <span class="dropdown-text">📚 Reference Materials</span></a>
  </li>  
        <li class="dropdown-header">📁 Project Templates</li>
        <li>
    <a class="dropdown-item" href="./extras/projects/project-proposal-template.html">
 <span class="dropdown-text">Project Proposal Template</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./extras/projects/mvp-template.html">
 <span class="dropdown-text">Project Results Template</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gfms-from-scratch/gfms-from-scratch.github.io" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">Week 3: TerraTorch Foundation Models</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead">Using pretrained models for geospatial tasks</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#imports" id="toc-imports" class="nav-link" data-scroll-target="#imports">Imports</a></li>
  <li><a href="#extract-patches" id="toc-extract-patches" class="nav-link" data-scroll-target="#extract-patches">Extract Patches</a></li>
  <li><a href="#create-labels" id="toc-create-labels" class="nav-link" data-scroll-target="#create-labels">Create Labels</a></li>
  <li><a href="#patchdataset-object-definition" id="toc-patchdataset-object-definition" class="nav-link" data-scroll-target="#patchdataset-object-definition"><code>PatchDataset</code> Object Definition</a></li>
  </ul></li>
  <li><a href="#create-sample-datasets" id="toc-create-sample-datasets" class="nav-link" data-scroll-target="#create-sample-datasets">Create Sample Datasets</a>
  <ul class="collapse">
  <li><a href="#load-satellite-data" id="toc-load-satellite-data" class="nav-link" data-scroll-target="#load-satellite-data">Load Satellite Data</a></li>
  <li><a href="#extract-patches-1" id="toc-extract-patches-1" class="nav-link" data-scroll-target="#extract-patches-1">Extract Patches</a></li>
  <li><a href="#create-labels-1" id="toc-create-labels-1" class="nav-link" data-scroll-target="#create-labels-1">Create Labels:</a></li>
  <li><a href="#visualize-some-example-patches-and-labels" id="toc-visualize-some-example-patches-and-labels" class="nav-link" data-scroll-target="#visualize-some-example-patches-and-labels">Visualize some example patches and labels:</a></li>
  <li><a href="#create-trainingvalidationtesting-datasets" id="toc-create-trainingvalidationtesting-datasets" class="nav-link" data-scroll-target="#create-trainingvalidationtesting-datasets">Create Training/Validation/Testing Datasets:</a></li>
  </ul></li>
  <li><a href="#we-split-our-patch-dataset-into-three-distinct-sets" id="toc-we-split-our-patch-dataset-into-three-distinct-sets" class="nav-link" data-scroll-target="#we-split-our-patch-dataset-into-three-distinct-sets">We split our patch dataset into three distinct sets:</a></li>
  <li><a href="#training-set-used-to-fit-the-models-weights-learn-patterns." id="toc-training-set-used-to-fit-the-models-weights-learn-patterns." class="nav-link" data-scroll-target="#training-set-used-to-fit-the-models-weights-learn-patterns.">- Training set: Used to fit the model’s weights (learn patterns).</a></li>
  <li><a href="#validation-set-used-for-intermediate-evaluation-to-tune-hyperparameters-and-select-the-best-model-preventing-overfitting." id="toc-validation-set-used-for-intermediate-evaluation-to-tune-hyperparameters-and-select-the-best-model-preventing-overfitting." class="nav-link" data-scroll-target="#validation-set-used-for-intermediate-evaluation-to-tune-hyperparameters-and-select-the-best-model-preventing-overfitting.">- Validation set: Used for intermediate evaluation to tune hyperparameters and select the best model, preventing overfitting.</a></li>
  <li><a href="#test-set-held-out-entirely-until-final-evaluation-to-assess-model-generalization-on-unseen-data." id="toc-test-set-held-out-entirely-until-final-evaluation-to-assess-model-generalization-on-unseen-data." class="nav-link" data-scroll-target="#test-set-held-out-entirely-until-final-evaluation-to-assess-model-generalization-on-unseen-data.">- Test set: Held out entirely until final evaluation to assess model generalization on unseen data.</a></li>
  <li><a href="#typical-allocation-ratios-are" id="toc-typical-allocation-ratios-are" class="nav-link" data-scroll-target="#typical-allocation-ratios-are">Typical allocation ratios are:</a></li>
  <li><a href="#for-training" id="toc-for-training" class="nav-link" data-scroll-target="#for-training">70% for training,</a></li>
  <li><a href="#for-validation" id="toc-for-validation" class="nav-link" data-scroll-target="#for-validation">15% for validation,</a></li>
  <li><a href="#for-testing." id="toc-for-testing." class="nav-link" data-scroll-target="#for-testing.">15% for testing.</a></li>
  <li><a href="#below-we-compute-indices-for-these-splits-and-create-dataset-objects-accordingly." id="toc-below-we-compute-indices-for-these-splits-and-create-dataset-objects-accordingly." class="nav-link" data-scroll-target="#below-we-compute-indices-for-these-splits-and-create-dataset-objects-accordingly.">Below, we compute indices for these splits and create dataset objects accordingly.</a>
  <ul class="collapse">
  <li><a href="#using-terratorch-models" id="toc-using-terratorch-models" class="nav-link" data-scroll-target="#using-terratorch-models">Using TerraTorch Models</a>
  <ul class="collapse">
  <li><a href="#load-a-pretrained-model" id="toc-load-a-pretrained-model" class="nav-link" data-scroll-target="#load-a-pretrained-model">Load a Pretrained Model</a></li>
  </ul></li>
  <li><a href="#task-1-classification" id="toc-task-1-classification" class="nav-link" data-scroll-target="#task-1-classification">Task 1: Classification</a>
  <ul class="collapse">
  <li><a href="#train-the-model" id="toc-train-the-model" class="nav-link" data-scroll-target="#train-the-model">Train the Model</a></li>
  <li><a href="#evaluate" id="toc-evaluate" class="nav-link" data-scroll-target="#evaluate">Evaluate</a></li>
  <li><a href="#visualize-results" id="toc-visualize-results" class="nav-link" data-scroll-target="#visualize-results">Visualize Results</a></li>
  </ul></li>
  <li><a href="#task-2-segmentation" id="toc-task-2-segmentation" class="nav-link" data-scroll-target="#task-2-segmentation">Task 2: Segmentation</a>
  <ul class="collapse">
  <li><a href="#create-segmentation-targets" id="toc-create-segmentation-targets" class="nav-link" data-scroll-target="#create-segmentation-targets">Create Segmentation Targets</a></li>
  <li><a href="#train-segmentation" id="toc-train-segmentation" class="nav-link" data-scroll-target="#train-segmentation">Train Segmentation</a></li>
  </ul></li>
  <li><a href="#comparing-backbones" id="toc-comparing-backbones" class="nav-link" data-scroll-target="#comparing-backbones">Comparing Backbones</a>
  <ul class="collapse">
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a></li>
  </ul></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>TerraTorch is a library for working with pretrained geospatial foundation models. This session shows how to use it for practical tasks with real satellite data.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning Goals
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Load pretrained foundation models using TerraTorch</li>
<li>Apply models to classification tasks</li>
<li>Apply models to segmentation tasks</li>
<li>Compare different model backbones</li>
<li>Understand TerraTorch’s composable workflow</li>
</ul>
</div>
</div>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<section id="installation" class="level3">
<h3 class="anchored" data-anchor-id="installation">Installation</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If not already installed</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install terratorch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="imports" class="level3">
<h3 class="anchored" data-anchor-id="imports">Imports</h3>
<div id="09d9c0f9" class="cell" data-tangle="geogfm/c03.py">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c01 <span class="im">import</span> load_sentinel2_bands</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.ndimage <span class="im">import</span> zoom</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c02 <span class="im">import</span> load_scene_with_cloudmask</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c01 <span class="im">import</span> setup_planetary_computer_auth, search_sentinel2_scenes</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup authentication</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>setup_planetary_computer_auth()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure GDAL/PROJ environment before importing rasterio</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>proj_path <span class="op">=</span> os.path.join(sys.prefix, <span class="st">'share'</span>, <span class="st">'proj'</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(proj_path):</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    os.environ[<span class="st">'PROJ_LIB'</span>] <span class="op">=</span> proj_path</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    os.environ[<span class="st">'PROJ_DATA'</span>] <span class="op">=</span> proj_path</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>logger.debug(<span class="ss">f"PyTorch: </span><span class="sc">{</span>torch<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>logger.debug(<span class="ss">f"CUDA available: </span><span class="sc">{</span>torch<span class="sc">.</span>cuda<span class="sc">.</span>is_available()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Select best available device: CUDA (NVIDIA GPU) &gt; CPU</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: MPS has compatibility issues with some operations (adaptive pooling)</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># See: https://github.com/pytorch/pytorch/issues/96056</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> torch.device(<span class="st">'cuda'</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"Using CUDA for acceleration"</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> torch.device(<span class="st">'cpu'</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.backends.mps.is_available():</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="st">"Using CPU (MPS available but has compatibility issues with TerraTorch)"</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="st">"Using CPU (no GPU acceleration available)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extract-patches" class="level3">
<h3 class="anchored" data-anchor-id="extract-patches">Extract Patches</h3>
<p>We use the <code>extract_patches</code> function to efficiently sample many small, square patches (sub-images) from a larger Sentinel-2 satellite scene. This step is important for deep learning workflows such as our TerraTorch foundation model demo, where a model expects numerous fixed-size training samples rather than huge, unwieldy satellite images.</p>
<p>Specifically, this function:</p>
<ul>
<li>Loads six key Sentinel-2 bands (blue, green, red, NIR, SWIR1, SWIR2).</li>
<li>Resamples 20m bands to 10m to create a consistent resolution stack.</li>
<li>Randomly extracts small, square regions from the AOI, skipping patches that are heavily masked by clouds or contain mostly invalid data.</li>
<li>Normalizes patch data (per band) based on within-patch percentiles.</li>
</ul>
<p><strong>How we’re using it:</strong><br>
In the TerraTorch demo, this function provides ready-to-use data patches for model training and experimentation, abstracting away preprocessing and making it easy to sample imagery data batches directly from a STAC/scene object.</p>
<p><strong>Key limitations and assumptions:</strong></p>
<ul>
<li>Only a fixed set of six bands is extracted. If other bands or other sensors are needed, this will require code changes.</li>
<li>The function assumes Sentinel-2 naming and band layout, and will not generalize to other satellite products.</li>
<li>Patch validity is assessed using a simple cloud/nodata mask, with a hardcoded 80% threshold.</li>
<li>The <a href="./extras/examples/normalization_comparison.html">normalization</a> (2nd–98th percentile scaling) is done per patch, not globally, which may harm consistency across patches.</li>
<li>The function operates on a single scene at a time and does not support multi-temporal or multi-scene sampling.</li>
<li>Sampling within the AOI does not ensure spatial uniformity or class balance.</li>
</ul>
<p>Generalization to other dataset shapes, larger patches, different patch selection rules, or global normalization would require further refactoring.</p>
<div id="d579dd00" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_patches(scene, bbox, patch_size<span class="op">=</span><span class="dv">64</span>, n_patches<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract square patches of Sentinel-2 band data from a scene within a specified bounding box.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function loads six selected Sentinel-2 bands (B02, B03, B04, B08, B11, B12),</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    resamples 20m bands to 10m resolution, and extracts random patches of a given size,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ensuring that at least 80% of the pixels in each patch are valid (not cloud-masked or nodata).</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    scene : pystac.Item or similar</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">        The STAC item or scene object representing the Sentinel-2 scene.</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    bbox : list[float] or tuple[float, float, float, float]</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Bounding box in [min lon, min lat, max lon, max lat] format specifying the area to extract patches from.</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">    patch_size : int, optional</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">        The height and width of the square patches to extract. Default is 64.</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">    n_patches : int, optional</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">        The number of valid patches to extract. May attempt to extract more to satisfy mask requirements. Default is 100.</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">    patches : list of ndarray</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">        List of 3D NumPy arrays of shape (n_bands, patch_size, patch_size), containing normalized patch data.</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Notes</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">    - Bands B02, B03, B04, and B08 are at 10m native resolution; B11 and B12 are at 20m and will be resampled.</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">    - Only patches with at least 80% valid (unmasked) pixels are retained.</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">    - Bands are normalized per-patch using the 2nd and 98th percentiles of valid pixels.</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; from geogfm.c01 import search_sentinel2_scenes</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; scenes = search_sentinel2_scenes(bbox=[-119.85, 34.40, -119.75, 34.48], limit=1)</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; scene = scenes[0]</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; patches = extract_patches(scene, [-119.85, 34.40, -119.75, 34.48], patch_size=64, n_patches=10)</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; print(patches[0].shape)</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co">    (6, 64, 64)</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load 6 bands to match Prithvi's expected input</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    band_data <span class="op">=</span> load_sentinel2_bands(</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        scene,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        bands<span class="op">=</span>[<span class="st">'B02'</span>, <span class="st">'B03'</span>, <span class="st">'B04'</span>, <span class="st">'B08'</span>, <span class="st">'B11'</span>, <span class="st">'B12'</span>],</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        subset_bbox<span class="op">=</span>bbox,</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        max_retries<span class="op">=</span><span class="dv">3</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    logger.info(</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>([k <span class="cf">for</span> k <span class="kw">in</span> band_data.keys() <span class="cf">if</span> k.startswith(<span class="st">'B'</span>)])<span class="sc">}</span><span class="ss"> bands"</span>)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get target shape from 10m bands</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    target_shape <span class="op">=</span> band_data[<span class="st">'B02'</span>].shape</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resample 20m bands (B11, B12) to 10m resolution</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    bands_list <span class="op">=</span> []</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band_name <span class="kw">in</span> [<span class="st">'B02'</span>, <span class="st">'B03'</span>, <span class="st">'B04'</span>, <span class="st">'B08'</span>, <span class="st">'B11'</span>, <span class="st">'B12'</span>]:</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        band <span class="op">=</span> band_data[band_name]</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> band.shape <span class="op">!=</span> target_shape:</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Resample to target shape</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>            zoom_factors <span class="op">=</span> (</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>                target_shape[<span class="dv">0</span>] <span class="op">/</span> band.shape[<span class="dv">0</span>], target_shape[<span class="dv">1</span>] <span class="op">/</span> band.shape[<span class="dv">1</span>])</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>            band <span class="op">=</span> zoom(band, zoom_factors, order<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>        bands_list.append(band)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stack bands</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> np.stack(bands_list)</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create cloud mask</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> <span class="op">~</span>np.isnan(bands[<span class="dv">0</span>])</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract random patches</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    _, H, W <span class="op">=</span> bands.shape</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    patches <span class="op">=</span> []</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_patches <span class="op">*</span> <span class="dv">2</span>):  <span class="co"># Try more to ensure enough valid</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> np.random.randint(<span class="dv">0</span>, H <span class="op">-</span> patch_size)</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> np.random.randint(<span class="dv">0</span>, W <span class="op">-</span> patch_size)</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>            patch <span class="op">=</span> bands[:, y:y<span class="op">+</span>patch_size, x:x<span class="op">+</span>patch_size]</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>            patch_mask <span class="op">=</span> mask[y:y<span class="op">+</span>patch_size, x:x<span class="op">+</span>patch_size]</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> np.mean(patch_mask) <span class="op">&gt;</span> <span class="fl">0.8</span>:  <span class="co"># 80% valid</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Normalize</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>                patch_norm <span class="op">=</span> np.zeros_like(patch)</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(patch.shape[<span class="dv">0</span>]):</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>                    valid <span class="op">=</span> patch[c][<span class="op">~</span>np.isnan(patch[c])]</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>                        p2, p98 <span class="op">=</span> np.percentile(valid, [<span class="dv">2</span>, <span class="dv">98</span>])</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>                        patch_norm[c] <span class="op">=</span> np.clip(</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>                            (patch[c] <span class="op">-</span> p2) <span class="op">/</span> (p98 <span class="op">-</span> p2 <span class="op">+</span> <span class="fl">1e-8</span>), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>                        patch_norm[c] <span class="op">=</span> np.nan_to_num(patch_norm[c], <span class="dv">0</span>)</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>                patches.append(patch_norm)</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(patches) <span class="op">&gt;=</span> n_patches:</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.from_numpy(np.stack(patches)).<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-labels" class="level3">
<h3 class="anchored" data-anchor-id="create-labels">Create Labels</h3>
<p>The <code>create_labels</code> function generates simple, automatically assigned labels for satellite image patches based on their spectral characteristics, such as NDVI. These pseudo-labels (e.g., marking high NDVI areas as vegetation) serve as a basic example to help demonstrate and test the TerraTorch workflow. This label generation approach is not intended to be scientifically robust or production-ready—it is included here to showcase key TerraTorch features using a straightforward and easily understood process.</p>
<div id="6b8a087b" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_labels(patches):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate pseudo-labels for input patches based on their spectral signatures.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Labels are assigned as follows:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">        - 0: Vegetation (NDVI mean &gt; 0.5)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">        - 1: Water      (NDVI mean &lt; 0)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">        - 2: Other      (otherwise)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">    patches : list or array-like</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Sequence of image patches as numpy arrays or tensors, each with shape (bands, height, width).</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">    labels : torch.Tensor</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">        1D tensor of integer labels with length equal to number of patches.</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; patches = [np.random.rand(6, 64, 64) for _ in range(10)]</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; labels = create_labels(patches)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; print(labels)</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co">    tensor([2, 0, 2, 1, 0, 2, 0, 2, 1, 0])</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> []</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> patch <span class="kw">in</span> patches:</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prithvi bands: Blue, Green, Red, NIR, SWIR1, SWIR2</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        blue, green, red, nir, swir1, swir2 <span class="op">=</span> patch</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        ndvi <span class="op">=</span> (nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Simple classification</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ndvi.mean() <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="dv">0</span>)  <span class="co"># Vegetation</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> ndvi.mean() <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="dv">1</span>)  <span class="co"># Water</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="dv">2</span>)  <span class="co"># Other</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.tensor(labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="patchdataset-object-definition" class="level3">
<h3 class="anchored" data-anchor-id="patchdataset-object-definition"><code>PatchDataset</code> Object Definition</h3>
<p>PatchDataset is a custom dataset class that inherits from PyTorch’s <code>Dataset</code> object. By extending <code>Dataset</code>, <code>PatchDataset</code> can be used seamlessly with PyTorch’s data loading utilities, such as <code>DataLoader</code>. In this class, we store our patch tensors and their corresponding labels, and implement the <code>__len__</code> and <code>__getitem__</code> methods required for efficient data batching and shuffling during training and evaluation. In our workflow, <code>PatchDataset</code> enables structured, efficient access to labeled image patches for training, validation, and testing deep learning models.</p>
<div id="f662993a" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PatchDataset(Dataset):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, patches, labels):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.patches <span class="op">=</span> patches</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.labels <span class="op">=</span> labels</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.patches)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.patches[idx], <span class="va">self</span>.labels[idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="create-sample-datasets" class="level2">
<h2 class="anchored" data-anchor-id="create-sample-datasets">Create Sample Datasets</h2>
<section id="load-satellite-data" class="level3">
<h3 class="anchored" data-anchor-id="load-satellite-data">Load Satellite Data</h3>
<p>We’ll load a small Sentinel-2 scene and extract patches for our examples using our existing library code.</p>
<div id="b13ffc58" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Small AOI in Santa Barbara (5km x 5km)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>aoi <span class="op">=</span> [<span class="op">-</span><span class="fl">119.85</span>, <span class="fl">34.40</span>, <span class="op">-</span><span class="fl">119.75</span>, <span class="fl">34.48</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for clear scene</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>scenes <span class="op">=</span> search_sentinel2_scenes(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    bbox<span class="op">=</span>aoi, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    date_range<span class="op">=</span><span class="st">"2023-06-01/2023-08-31"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    cloud_cover_max<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span><span class="dv">1</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>scene <span class="op">=</span> scenes[<span class="dv">0</span>]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Using scene: </span><span class="sc">{</span>scene<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">30</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Date: </span><span class="sc">{</span>scene<span class="sc">.</span>properties[<span class="st">'datetime'</span>][:<span class="dv">10</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Cloud cover: </span><span class="sc">{</span>scene<span class="sc">.</span>properties[<span class="st">'eo:cloud_cover'</span>]<span class="sc">:.1f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extract-patches-1" class="level3">
<h3 class="anchored" data-anchor-id="extract-patches-1">Extract Patches</h3>
<div id="eac3e3be" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract patches</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>patches <span class="op">=</span> extract_patches(scene, aoi, patch_size<span class="op">=</span><span class="dv">64</span>, n_patches<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Extracted </span><span class="sc">{</span><span class="bu">len</span>(patches)<span class="sc">}</span><span class="ss"> patches of shape </span><span class="sc">{</span>patches[<span class="dv">0</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-labels-1" class="level3">
<h3 class="anchored" data-anchor-id="create-labels-1">Create Labels:</h3>
<div id="adf2b086" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> create_labels(patches)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Label distribution: </span><span class="sc">{</span>torch<span class="sc">.</span>bincount(labels)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-some-example-patches-and-labels" class="level3">
<h3 class="anchored" data-anchor-id="visualize-some-example-patches-and-labels">Visualize some example patches and labels:</h3>
<div id="795d17db" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Map label integers to class names</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>class_names <span class="op">=</span> {<span class="dv">0</span>: <span class="st">'Vegetation'</span>, <span class="dv">1</span>: <span class="st">'Water'</span>, <span class="dv">2</span>: <span class="st">'Other'</span>}</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a few (e.g., 6) random patches to visualize</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>num_examples <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> torch.randperm(<span class="bu">len</span>(patches))[:num_examples]</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, num_examples, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">3</span>))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, idx <span class="kw">in</span> <span class="bu">zip</span>(axes, indices):</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    patch <span class="op">=</span> patches[idx]</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HLS: bands are typically in (C, H, W) format; show an RGB composite</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here, assume RGB = bands 2,1,0 (if patch shape[0]&gt;=3)</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> patch.shape[<span class="dv">0</span>] <span class="op">&gt;=</span> <span class="dv">3</span>:</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        rgb <span class="op">=</span> patch[:<span class="dv">3</span>].permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Scale for visualization</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        rgb_min <span class="op">=</span> rgb.<span class="bu">min</span>().item()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        rgb_max <span class="op">=</span> rgb.<span class="bu">max</span>().item()</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rgb_max <span class="op">&gt;</span> rgb_min:</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>            rgb_vis <span class="op">=</span> (rgb <span class="op">-</span> rgb_min) <span class="op">/</span> (rgb_max <span class="op">-</span> rgb_min)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>            rgb_vis <span class="op">=</span> rgb</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        ax.imshow(rgb_vis)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        ax.imshow(patch[<span class="dv">0</span>].cpu(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    label <span class="op">=</span> labels[idx].item() <span class="cf">if</span> <span class="bu">hasattr</span>(labels[idx], <span class="st">'item'</span>) <span class="cf">else</span> labels[idx]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    ax.set_title(class_names[label])</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    ax.axis(<span class="st">'off'</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-trainingvalidationtesting-datasets" class="level3">
<h3 class="anchored" data-anchor-id="create-trainingvalidationtesting-datasets">Create Training/Validation/Testing Datasets:</h3>
</section>
</section>
<section id="we-split-our-patch-dataset-into-three-distinct-sets" class="level1">
<h1>We split our patch dataset into three distinct sets:</h1>
</section>
<section id="training-set-used-to-fit-the-models-weights-learn-patterns." class="level1">
<h1>- Training set: Used to fit the model’s weights (learn patterns).</h1>
</section>
<section id="validation-set-used-for-intermediate-evaluation-to-tune-hyperparameters-and-select-the-best-model-preventing-overfitting." class="level1">
<h1>- Validation set: Used for intermediate evaluation to tune hyperparameters and select the best model, preventing overfitting.</h1>
</section>
<section id="test-set-held-out-entirely-until-final-evaluation-to-assess-model-generalization-on-unseen-data." class="level1">
<h1>- Test set: Held out entirely until final evaluation to assess model generalization on unseen data.</h1>
</section>
<section id="typical-allocation-ratios-are" class="level1">
<h1>Typical allocation ratios are:</h1>
</section>
<section id="for-training" class="level1">
<h1>70% for training,</h1>
</section>
<section id="for-validation" class="level1">
<h1>15% for validation,</h1>
</section>
<section id="for-testing." class="level1">
<h1>15% for testing.</h1>
</section>
<section id="below-we-compute-indices-for-these-splits-and-create-dataset-objects-accordingly." class="level1">
<h1>Below, we compute indices for these splits and create dataset objects accordingly.</h1>
<div id="be54fd21" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>n_train <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.7</span> <span class="op">*</span> <span class="bu">len</span>(patches))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>n_val <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.15</span> <span class="op">*</span> <span class="bu">len</span>(patches))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> PatchDataset(patches[:n_train], labels[:n_train])</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>val_dataset <span class="op">=</span> PatchDataset(patches[n_train:n_train<span class="op">+</span>n_val], labels[n_train:n_train<span class="op">+</span>n_val])</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> PatchDataset(patches[n_train<span class="op">+</span>n_val:], labels[n_train<span class="op">+</span>n_val:])</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Train: </span><span class="sc">{</span><span class="bu">len</span>(train_dataset)<span class="sc">}</span><span class="ss">, Val: </span><span class="sc">{</span><span class="bu">len</span>(val_dataset)<span class="sc">}</span><span class="ss">, Test: </span><span class="sc">{</span><span class="bu">len</span>(test_dataset)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="using-terratorch-models" class="level2">
<h2 class="anchored" data-anchor-id="using-terratorch-models">Using TerraTorch Models</h2>
<section id="load-a-pretrained-model" class="level3">
<h3 class="anchored" data-anchor-id="load-a-pretrained-model">Load a Pretrained Model</h3>
<p>The <code>EncoderDecoderFactory</code> is a utility in TerraTorch that streamlines the creation of deep learning models based on the encoder-decoder architecture. This object abstracts away boilerplate and provides a simple interface for constructing models suited for a variety of earth observation tasks, such as classification or segmentation.</p>
<p>When calling <code>build_model()</code>, you specify several important arguments to configure the model:</p>
<ul>
<li><code>task</code>: The type of problem you are solving (e.g., <code>"classification"</code> for assigning a label to an image patch, or <code>"segmentation"</code> for pixel-wise classification).</li>
<li><code>backbone</code>: The encoder neural network that extracts features from the input data. Common options include pretrained vision transformers like <code>"prithvi_eo_v1_100"</code> (Prithvi-100M), <code>"resnet18"</code>, <code>"resnet50"</code>, etc.</li>
<li><code>decoder</code>: The decoder determines how extracted features are transformed for the target task. Options include <code>"FCNDecoder"</code> for simple classification, <code>"UNetDecoder"</code>, etc.</li>
<li><code>num_classes</code>: The number of output classes for your problem (for example, 3 land cover types in our current classification task).</li>
</ul>
<p>These parameters allow you to flexibly adapt powerful pretrained models to your specific remote sensing task.</p>
<p><strong>Example usage:</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_factory.build_model(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    task<span class="op">=</span><span class="st">"classification"</span>,            <span class="co"># classification or segmentation</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">"prithvi_eo_v1_100"</span>,     <span class="co"># encoder/feature extractor</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    decoder<span class="op">=</span><span class="st">"FCNDecoder"</span>,             <span class="co"># type of decoder/classification head</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="dv">3</span>                     <span class="co"># number of output classes</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Other parameters (see the <a href="https://terra-torch.readthedocs.io/en/latest/">TerraTorch documentation</a> for more options) can control things like input channels, dropout, and patch size, enabling further customization.</p>
<div id="d2cdebdd" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> terratorch.models <span class="im">import</span> EncoderDecoderFactory</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create model factory</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    model_factory <span class="op">=</span> EncoderDecoderFactory()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build classification model with Prithvi backbone</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_factory.build_model(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        task<span class="op">=</span><span class="st">"classification"</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        backbone<span class="op">=</span><span class="st">"prithvi_eo_v1_100"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        decoder<span class="op">=</span><span class="st">"FCNDecoder"</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span><span class="dv">3</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"Loaded Prithvi-100M model"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f"Parameters: </span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"TerraTorch not installed. Install with: pip install terratorch"</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="task-1-classification" class="level2">
<h2 class="anchored" data-anchor-id="task-1-classification">Task 1: Classification</h2>
<section id="train-the-model" class="level3">
<h3 class="anchored" data-anchor-id="train-the-model">Train the Model</h3>
<p>Model training and validation loops are fundamental routines in deep learning workflows.</p>
<ul>
<li>The <strong>training loop</strong> iterates over batches of data, computes predictions using the model, evaluates a loss function, performs backpropagation, and updates model parameters with an optimizer.</li>
<li>The <strong>validation loop</strong> evaluates the model on unseen data without updating parameters (i.e., in <code>eval</code> mode and without gradient computation). It is used to track performance and detect overfitting.</li>
</ul>
<p>In the code below, the <code>train_model</code> function implements both loops:</p>
<ul>
<li>During training, it sets the model to training mode (<code>model.train()</code>), zeroes gradients, computes loss and accuracy, backpropagates, and steps the optimizer for each batch.</li>
<li>During validation, it switches to evaluation mode (<code>model.eval()</code>), disables gradient computation (<code>with torch.no_grad()</code>), and calculates loss and accuracy.</li>
<li>Losses and accuracies are accumulated and averaged over all batches for both sets.</li>
<li>Training and validation history is collected in a dictionary for analysis.</li>
</ul>
<p><strong>Limitations and assumptions:</strong></p>
<ul>
<li>The code assumes a simple classification task with standard <code>CrossEntropyLoss</code> and that labels are properly formatted for it.</li>
<li>There’s no support for advanced features like data augmentation, learning rate scheduling, early stopping, or mixed-precision training.</li>
<li>No checkpointing or logging of model weights is implemented.</li>
<li>The function globally assumes the device (CPU or GPU) context is handled outside (for both model and batches).</li>
<li>It does not handle distributed/multi-GPU training or non-image data modalities.</li>
<li>Batch sizes and data shuffling are expected to be handled by the user in DataLoader construction.</li>
<li>For production, you’d want explicit error handling, flexibility for other tasks/losses, and possibly hooks for callbacks or custom metrics.</li>
</ul>
<p>This simple structure works well for prototyping and educational purposes, but for robust, scalable applications, more initialization, error resistance, and configurability are needed.</p>
<div id="ccf4f2e1" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, train_loader, val_loader, epochs<span class="op">=</span><span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-4</span>):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains a classification model using a simple training and validation loop.</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function optimizes the model's parameters based on the training dataset and evaluates </span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    performance on the validation set at the end of each epoch. It supports standard image </span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    classification tasks with models returning logits, such as those from TerraTorch or PyTorch.</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">    model : torch.nn.Module</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">        The neural network model to train. Should output logits when given images.</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">    train_loader : torch.utils.data.DataLoader</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">        DataLoader instance providing the training data batches (images, labels).</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">    val_loader : torch.utils.data.DataLoader</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">        DataLoader instance providing the validation data batches (images, labels).</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">    epochs : int, optional</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of times to iterate over the training dataset (default is 10).</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">    lr : float, optional</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Learning rate for the Adam optimizer (default is 1e-4).</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co">    history : dict</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co">        A dictionary containing lists of loss and accuracy values per epoch for training and validation.</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Keys are: 'train_loss', 'train_acc', 'val_loss', 'val_acc'.</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; model = model_factory.build_model(task="classification", backbone="prithvi_eo_v1_100", decoder="FCNDecoder", num_classes=3)</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; model = model.to(device)</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=64, shuffle=True)</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; val_loader = torch.utils.data.DataLoader(val_dataset, batch_size=64)</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; history = train_model(model, train_loader, val_loader, epochs=5, lr=1e-4)</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; print(history["train_acc"])</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co">    [0.70, 0.84, 0.89, 0.91, 0.93]</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The optimizer updates model parameters to minimize the loss during training.</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here we use Adam, a popular optimizer for deep learning that adapts learning rates.</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span>lr)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The criterion defines the loss function, which measures how far the model's predictions</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># are from the correct labels. CrossEntropyLoss is standard for multiclass classification.</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> {<span class="st">'train_loss'</span>: [], <span class="st">'train_acc'</span>: [],</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>               <span class="st">'val_loss'</span>: [], <span class="st">'val_acc'</span>: []}</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">=</span> <span class="dv">0</span>    <span class="co"># Sum of losses for the epoch</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">=</span> <span class="dv">0</span>      <span class="co"># Number of correctly predicted samples</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span>        <span class="co"># Total number of samples processed</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, targets <span class="kw">in</span> train_loader:</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>            images, targets <span class="op">=</span> images.to(device), targets.to(device)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> outputs.output</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(outputs, targets)</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>            train_loss <span class="op">+=</span> loss.item()</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>            _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> targets.size(<span class="dv">0</span>)</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> predicted.eq(targets).<span class="bu">sum</span>().item()</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">/=</span> <span class="bu">len</span>(train_loader)</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>        train_acc <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validate</span></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>        model.<span class="bu">eval</span>()</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> images, targets <span class="kw">in</span> val_loader:</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>                images, targets <span class="op">=</span> images.to(device), targets.to(device)</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> model(images)</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>                    outputs <span class="op">=</span> outputs.output</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> criterion(outputs, targets)</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>                val_loss <span class="op">+=</span> loss.item()</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>                _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>                total <span class="op">+=</span> targets.size(<span class="dv">0</span>)</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>                correct <span class="op">+=</span> predicted.eq(targets).<span class="bu">sum</span>().item()</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">/=</span> <span class="bu">len</span>(val_loader)</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>        val_acc <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>        history[<span class="st">'train_loss'</span>].append(train_loss)</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>        history[<span class="st">'train_acc'</span>].append(train_acc)</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>        history[<span class="st">'val_loss'</span>].append(val_loss)</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>        history[<span class="st">'val_acc'</span>].append(val_acc)</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>            logger.info(</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: Train Acc=</span><span class="sc">{</span>train_acc<span class="sc">:.3f}</span><span class="ss">, Val Acc=</span><span class="sc">{</span>val_acc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="117c7318" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create loaders</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> DataLoader(train_dataset, batch_size<span class="op">=</span><span class="dv">32</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>val_loader <span class="op">=</span> DataLoader(val_dataset, batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>test_loader <span class="op">=</span> DataLoader(test_dataset, batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Train</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="st">"Training classification model..."</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> train_model(model, train_loader, val_loader, epochs<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluate" class="level3">
<h3 class="anchored" data-anchor-id="evaluate">Evaluate</h3>
<div id="4f3c0993" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">eval</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> images, targets <span class="kw">in</span> test_loader:</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        images, targets <span class="op">=</span> images.to(device), targets.to(device)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(images)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> outputs.output</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        total <span class="op">+=</span> targets.size(<span class="dv">0</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">+=</span> predicted.eq(targets).<span class="bu">sum</span>().item()</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>test_acc <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Test accuracy: </span><span class="sc">{</span>test_acc<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-results" class="level3">
<h3 class="anchored" data-anchor-id="visualize-results">Visualize Results</h3>
<div id="71a29754" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(history[<span class="st">'train_loss'</span>]) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>ax1.plot(epochs, history[<span class="st">'train_loss'</span>], label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>ax1.plot(epochs, history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'Val'</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Training Loss'</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>ax1.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>ax2.plot(epochs, history[<span class="st">'train_acc'</span>], label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>ax2.plot(epochs, history[<span class="st">'val_acc'</span>], label<span class="op">=</span><span class="st">'Val'</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Training Accuracy'</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>ax2.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="task-2-segmentation" class="level2">
<h2 class="anchored" data-anchor-id="task-2-segmentation">Task 2: Segmentation</h2>
<p>Using the same data for a different task.</p>
<div id="6369ad87" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create segmentation model with same backbone</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    seg_model <span class="op">=</span> model_factory.build_model(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        task<span class="op">=</span><span class="st">"segmentation"</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        backbone<span class="op">=</span><span class="st">"prithvi_eo_v1_100"</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        decoder<span class="op">=</span><span class="st">"UperNetDecoder"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span><span class="dv">3</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"Loaded Prithvi segmentation model"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f"Parameters: </span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> seg_model.parameters())<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> (<span class="pp">ImportError</span>, <span class="pp">NameError</span>):</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Demo segmentation model</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> DemoSegModel(nn.Module):</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.conv1 <span class="op">=</span> nn.Conv2d(<span class="dv">6</span>, <span class="dv">64</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)  <span class="co"># 6 channels for HLS bands</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.conv2 <span class="op">=</span> nn.Conv2d(<span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.conv3 <span class="op">=</span> nn.Conv2d(<span class="dv">128</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> torch.relu(<span class="va">self</span>.conv1(x))</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> torch.relu(<span class="va">self</span>.conv2(x))</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.conv3(x)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    seg_model <span class="op">=</span> DemoSegModel()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    logger.warning(<span class="st">"Demo segmentation model"</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>seg_model <span class="op">=</span> seg_model.to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="create-segmentation-targets" class="level3">
<h3 class="anchored" data-anchor-id="create-segmentation-targets">Create Segmentation Targets</h3>
<div id="734d3eeb" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_seg_masks(patches):</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Create pixel-wise segmentation masks based on spectral signatures for each pixel.</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Labels are assigned per-pixel as follows:</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">        - 0: Vegetation (NDVI &gt; 0.5)</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">        - 1: Water (NDVI &lt; 0)</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">        - 2: Other (otherwise)</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">    patches : torch.Tensor</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Tensor of patches with shape (N, C, H, W) where C=6 bands.</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">    masks : torch.Tensor</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Tensor of masks with shape (N, H, W) containing class labels for each pixel.</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    masks <span class="op">=</span> []</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> patch <span class="kw">in</span> patches:</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract bands: Blue, Green, Red, NIR, SWIR1, SWIR2</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        blue, green, red, nir, swir1, swir2 <span class="op">=</span> patch</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate NDVI for each pixel</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        ndvi <span class="op">=</span> (nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize mask with "Other" class (2)</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> torch.ones_like(ndvi, dtype<span class="op">=</span>torch.<span class="bu">long</span>) <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign vegetation (0) where NDVI &gt; 0.5</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>        mask[ndvi <span class="op">&gt;</span> <span class="fl">0.5</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign water (1) where NDVI &lt; 0</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        mask[ndvi <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        masks.append(mask)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.stack(masks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="97d5deca" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SegDataset(Dataset):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, patches, masks):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.patches <span class="op">=</span> patches</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.masks <span class="op">=</span> masks</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.patches)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.patches[idx], <span class="va">self</span>.masks[idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="91673831" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create masks</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>train_masks <span class="op">=</span> create_seg_masks(patches[:n_train])</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>val_masks <span class="op">=</span> create_seg_masks(patches[n_train:n_train<span class="op">+</span>n_val])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="85c6c1f0" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>seg_train_loader <span class="op">=</span> DataLoader(SegDataset(patches[:n_train], train_masks), batch_size<span class="op">=</span><span class="dv">16</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>seg_val_loader <span class="op">=</span> DataLoader(SegDataset(patches[n_train:n_train<span class="op">+</span>n_val], val_masks), batch_size<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Segmentation datasets ready"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="train-segmentation" class="level3">
<h3 class="anchored" data-anchor-id="train-segmentation">Train Segmentation</h3>
<div id="ee41bee2" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_segmentation(model, train_loader, val_loader, epochs<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train segmentation model."""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, masks <span class="kw">in</span> train_loader:</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>            images, masks <span class="op">=</span> images.to(device), masks.to(device)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> outputs.output</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(outputs, masks)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            train_loss <span class="op">+=</span> loss.item()</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">/=</span> <span class="bu">len</span>(train_loader)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validate</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        model.<span class="bu">eval</span>()</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> images, masks <span class="kw">in</span> val_loader:</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>                images, masks <span class="op">=</span> images.to(device), masks.to(device)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> model(images)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>                    outputs <span class="op">=</span> outputs.output</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> criterion(outputs, masks)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>                val_loss <span class="op">+=</span> loss.item()</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">/=</span> <span class="bu">len</span>(val_loader)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: Train Loss=</span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss">, Val Loss=</span><span class="sc">{</span>val_loss<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="02354428" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training segmentation model..."</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>train_segmentation(seg_model, seg_train_loader, seg_val_loader, epochs<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="visualize-output-and-accuracy" class="level4">
<h4 class="anchored" data-anchor-id="visualize-output-and-accuracy">Visualize output and accuracy</h4>
<div id="ac7c55e6" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_accuracy(model, data_loader, device_name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute pixelwise accuracy for segmentation"""</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> device_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        device_name <span class="op">=</span> device</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    correct, total <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, masks <span class="kw">in</span> data_loader:</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>            images, masks <span class="op">=</span> images.to(device_name), masks.to(device_name)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> outputs.output</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>            preds <span class="op">=</span> torch.argmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> (preds <span class="op">==</span> masks).<span class="bu">sum</span>().item()</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> masks.numel()</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> accuracy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bf5d81cf" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute accuracy on validation data</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> get_accuracy(seg_model, seg_val_loader)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>logger.info(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Segmentation Model Pixel Accuracy on Validation Data: </span><span class="sc">{</span>accuracy<span class="sc">:.3%}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="27edf0ef" class="cell" data-tangle="geogfm/c03.py" data-mode="append">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_predictions(model, data_loader, device_name<span class="op">=</span><span class="va">None</span>, n<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> device_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        device_name <span class="op">=</span> device</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    images, masks <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(data_loader))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    images, masks <span class="op">=</span> images.to(device_name), masks.to(device_name)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(images)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> outputs.output</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> torch.argmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose up to n samples to show</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    num_show <span class="op">=</span> <span class="bu">min</span>(n, images.shape[<span class="dv">0</span>])</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_show):</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Display RGB composite from the image</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        img_np <span class="op">=</span> images[i].cpu()</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> img_np.shape[<span class="dv">0</span>] <span class="op">&gt;=</span> <span class="dv">3</span>:</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For 6-band Sentinel-2: bands are [Blue, Green, Red, NIR, SWIR1, SWIR2]</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Select first 3 bands (Blue, Green, Red) and reorder to RGB</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>            rgb <span class="op">=</span> torch.stack([img_np[<span class="dv">2</span>], img_np[<span class="dv">1</span>], img_np[<span class="dv">0</span>]], dim<span class="op">=</span><span class="dv">0</span>)  <span class="co"># R, G, B</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>            rgb <span class="op">=</span> rgb.permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)  <span class="co"># (H, W, C)</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>            axs[<span class="dv">0</span>].imshow(rgb)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Single band image - show as grayscale</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>            axs[<span class="dv">0</span>].imshow(img_np[<span class="dv">0</span>], cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">0</span>].set_title(<span class="st">'Input Image'</span>)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">1</span>].imshow(masks[i].cpu(), cmap<span class="op">=</span><span class="st">'tab20'</span>)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">1</span>].set_title(<span class="st">'Ground Truth Mask'</span>)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">2</span>].imshow(preds[i].cpu(), cmap<span class="op">=</span><span class="st">'tab20'</span>)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">2</span>].set_title(<span class="st">'Predicted Mask'</span>)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>        plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="73649eaf" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>visualize_predictions(seg_model, seg_val_loader, n<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="comparing-backbones" class="level2">
<h2 class="anchored" data-anchor-id="comparing-backbones">Comparing Backbones</h2>
<p>TerraTorch makes it easy to compare different foundation models.</p>
<p><strong>Available backbones in TerraTorch (examples):</strong></p>
<ul>
<li><code>prithvi_eo_v1_100</code> — Prithvi 100M parameter model<br>
</li>
<li><code>prithvi_eo_v1_300</code> — Prithvi 300M parameter model<br>
</li>
<li><code>prithvi_eo_v2_300</code> — Prithvi V2 300M model<br>
</li>
<li><code>timm_resnet50</code> — ResNet-50 from timm</li>
</ul>
<hr>
<p><strong>To use a different backbone, you can build your model like this:</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_factory.build_model(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    task<span class="op">=</span><span class="st">'classification'</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">'prithvi_eo_v2_300'</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    decoder<span class="op">=</span><span class="st">'FCNDecoder'</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="dv">3</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="key-takeaways" class="level3">
<h3 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h3>
<ol type="1">
<li><strong>TerraTorch simplifies model loading</strong>: One API for multiple foundation models</li>
<li><strong>Task flexibility</strong>: Same backbone for classification, segmentation, etc.</li>
<li><strong>Model comparison</strong>: Easy to swap backbones</li>
<li><strong>Production ready</strong>: Built for real-world geospatial applications</li>
</ol>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ul>
<li><a href="https://github.com/IBM/terratorch">TerraTorch GitHub</a></li>
<li><a href="https://huggingface.co/ibm-nasa-geospatial">Prithvi Models</a></li>
<li><a href="https://github.com/IBM/terratorch/blob/main/MODEL_ZOO.md">Model Zoo</a></li>
</ul>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kcaylor\.github\.io\/GEOG-288KC-geospatial-foundation-models");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb29" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Week 3: TerraTorch Foundation Models"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Using pretrained models for geospatial tasks"</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> geoai</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>TerraTorch is a library for working with pretrained geospatial foundation models. This session shows how to use it for practical tasks with real satellite data.</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Goals</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Load pretrained foundation models using TerraTorch</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Apply models to classification tasks</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Apply models to segmentation tasks</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compare different model backbones</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understand TerraTorch's composable workflow</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="fu">### Installation</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="co"># If not already installed</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install terratorch</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="fu">### Imports</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="co"># | tangle: geogfm/c03.py</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c01 <span class="im">import</span> load_sentinel2_bands</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.ndimage <span class="im">import</span> zoom</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c02 <span class="im">import</span> load_scene_with_cloudmask</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c01 <span class="im">import</span> setup_planetary_computer_auth, search_sentinel2_scenes</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup authentication</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>setup_planetary_computer_auth()</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure GDAL/PROJ environment before importing rasterio</span></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>proj_path <span class="op">=</span> os.path.join(sys.prefix, <span class="st">'share'</span>, <span class="st">'proj'</span>)</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(proj_path):</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>    os.environ[<span class="st">'PROJ_LIB'</span>] <span class="op">=</span> proj_path</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>    os.environ[<span class="st">'PROJ_DATA'</span>] <span class="op">=</span> proj_path</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>logger.debug(<span class="ss">f"PyTorch: </span><span class="sc">{</span>torch<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>logger.debug(<span class="ss">f"CUDA available: </span><span class="sc">{</span>torch<span class="sc">.</span>cuda<span class="sc">.</span>is_available()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Select best available device: CUDA (NVIDIA GPU) &gt; CPU</span></span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: MPS has compatibility issues with some operations (adaptive pooling)</span></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a><span class="co"># See: https://github.com/pytorch/pytorch/issues/96056</span></span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> torch.device(<span class="st">'cuda'</span>)</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"Using CUDA for acceleration"</span>)</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> torch.device(<span class="st">'cpu'</span>)</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.backends.mps.is_available():</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="st">"Using CPU (MPS available but has compatibility issues with TerraTorch)"</span>)</span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="st">"Using CPU (no GPU acceleration available)"</span>)</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extract Patches</span></span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>We use the <span class="in">`extract_patches`</span> function to efficiently sample many small, square patches (sub-images) from a larger Sentinel-2 satellite scene. This step is important for deep learning workflows such as our TerraTorch foundation model demo, where a model expects numerous fixed-size training samples rather than huge, unwieldy satellite images.</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>Specifically, this function:</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Loads six key Sentinel-2 bands (blue, green, red, NIR, SWIR1, SWIR2).</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Resamples 20m bands to 10m to create a consistent resolution stack.</span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Randomly extracts small, square regions from the AOI, skipping patches that are heavily masked by clouds or contain mostly invalid data.</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Normalizes patch data (per band) based on within-patch percentiles.</span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>**How we're using it:**  </span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>In the TerraTorch demo, this function provides ready-to-use data patches for model training and experimentation, abstracting away preprocessing and making it easy to sample imagery data batches directly from a STAC/scene object.</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>**Key limitations and assumptions:**</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Only a fixed set of six bands is extracted. If other bands or other sensors are needed, this will require code changes.</span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The function assumes Sentinel-2 naming and band layout, and will not generalize to other satellite products.</span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Patch validity is assessed using a simple cloud/nodata mask, with a hardcoded 80% threshold.</span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The <span class="co">[</span><span class="ot">normalization</span><span class="co">](extras/examples/normalization_comparison.qmd)</span> (2nd–98th percentile scaling) is done per patch, not globally, which may harm consistency across patches.</span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The function operates on a single scene at a time and does not support multi-temporal or multi-scene sampling.</span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sampling within the AOI does not ensure spatial uniformity or class balance.</span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>Generalization to other dataset shapes, larger patches, different patch selection rules, or global normalization would require further refactoring.</span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/c03.py</span></span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a><span class="co">#| mode: append</span></span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_patches(scene, bbox, patch_size<span class="op">=</span><span class="dv">64</span>, n_patches<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract square patches of Sentinel-2 band data from a scene within a specified bounding box.</span></span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a><span class="co">    This function loads six selected Sentinel-2 bands (B02, B03, B04, B08, B11, B12),</span></span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a><span class="co">    resamples 20m bands to 10m resolution, and extracts random patches of a given size,</span></span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a><span class="co">    ensuring that at least 80% of the pixels in each patch are valid (not cloud-masked or nodata).</span></span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a><span class="co">    scene : pystac.Item or similar</span></span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a><span class="co">        The STAC item or scene object representing the Sentinel-2 scene.</span></span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a><span class="co">    bbox : list[float] or tuple[float, float, float, float]</span></span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a><span class="co">        Bounding box in [min lon, min lat, max lon, max lat] format specifying the area to extract patches from.</span></span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a><span class="co">    patch_size : int, optional</span></span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a><span class="co">        The height and width of the square patches to extract. Default is 64.</span></span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a><span class="co">    n_patches : int, optional</span></span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a><span class="co">        The number of valid patches to extract. May attempt to extract more to satisfy mask requirements. Default is 100.</span></span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a><span class="co">    patches : list of ndarray</span></span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a><span class="co">        List of 3D NumPy arrays of shape (n_bands, patch_size, patch_size), containing normalized patch data.</span></span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a><span class="co">    Notes</span></span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a><span class="co">    - Bands B02, B03, B04, and B08 are at 10m native resolution; B11 and B12 are at 20m and will be resampled.</span></span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a><span class="co">    - Only patches with at least 80% valid (unmasked) pixels are retained.</span></span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a><span class="co">    - Bands are normalized per-patch using the 2nd and 98th percentiles of valid pixels.</span></span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; from geogfm.c01 import search_sentinel2_scenes</span></span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; scenes = search_sentinel2_scenes(bbox=[-119.85, 34.40, -119.75, 34.48], limit=1)</span></span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; scene = scenes[0]</span></span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; patches = extract_patches(scene, [-119.85, 34.40, -119.75, 34.48], patch_size=64, n_patches=10)</span></span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; print(patches[0].shape)</span></span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a><span class="co">    (6, 64, 64)</span></span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load 6 bands to match Prithvi's expected input</span></span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a>    band_data <span class="op">=</span> load_sentinel2_bands(</span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a>        scene,</span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a>        bands<span class="op">=</span>[<span class="st">'B02'</span>, <span class="st">'B03'</span>, <span class="st">'B04'</span>, <span class="st">'B08'</span>, <span class="st">'B11'</span>, <span class="st">'B12'</span>],</span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a>        subset_bbox<span class="op">=</span>bbox,</span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a>        max_retries<span class="op">=</span><span class="dv">3</span></span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a>    logger.info(</span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>([k <span class="cf">for</span> k <span class="kw">in</span> band_data.keys() <span class="cf">if</span> k.startswith(<span class="st">'B'</span>)])<span class="sc">}</span><span class="ss"> bands"</span>)</span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get target shape from 10m bands</span></span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a>    target_shape <span class="op">=</span> band_data[<span class="st">'B02'</span>].shape</span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resample 20m bands (B11, B12) to 10m resolution</span></span>
<span id="cb29-181"><a href="#cb29-181" aria-hidden="true" tabindex="-1"></a>    bands_list <span class="op">=</span> []</span>
<span id="cb29-182"><a href="#cb29-182" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band_name <span class="kw">in</span> [<span class="st">'B02'</span>, <span class="st">'B03'</span>, <span class="st">'B04'</span>, <span class="st">'B08'</span>, <span class="st">'B11'</span>, <span class="st">'B12'</span>]:</span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a>        band <span class="op">=</span> band_data[band_name]</span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> band.shape <span class="op">!=</span> target_shape:</span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Resample to target shape</span></span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a>            zoom_factors <span class="op">=</span> (</span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a>                target_shape[<span class="dv">0</span>] <span class="op">/</span> band.shape[<span class="dv">0</span>], target_shape[<span class="dv">1</span>] <span class="op">/</span> band.shape[<span class="dv">1</span>])</span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a>            band <span class="op">=</span> zoom(band, zoom_factors, order<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a>        bands_list.append(band)</span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stack bands</span></span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> np.stack(bands_list)</span>
<span id="cb29-193"><a href="#cb29-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-194"><a href="#cb29-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create cloud mask</span></span>
<span id="cb29-195"><a href="#cb29-195" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> <span class="op">~</span>np.isnan(bands[<span class="dv">0</span>])</span>
<span id="cb29-196"><a href="#cb29-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-197"><a href="#cb29-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract random patches</span></span>
<span id="cb29-198"><a href="#cb29-198" aria-hidden="true" tabindex="-1"></a>    _, H, W <span class="op">=</span> bands.shape</span>
<span id="cb29-199"><a href="#cb29-199" aria-hidden="true" tabindex="-1"></a>    patches <span class="op">=</span> []</span>
<span id="cb29-200"><a href="#cb29-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-201"><a href="#cb29-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_patches <span class="op">*</span> <span class="dv">2</span>):  <span class="co"># Try more to ensure enough valid</span></span>
<span id="cb29-202"><a href="#cb29-202" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> np.random.randint(<span class="dv">0</span>, H <span class="op">-</span> patch_size)</span>
<span id="cb29-203"><a href="#cb29-203" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> np.random.randint(<span class="dv">0</span>, W <span class="op">-</span> patch_size)</span>
<span id="cb29-204"><a href="#cb29-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-205"><a href="#cb29-205" aria-hidden="true" tabindex="-1"></a>            patch <span class="op">=</span> bands[:, y:y<span class="op">+</span>patch_size, x:x<span class="op">+</span>patch_size]</span>
<span id="cb29-206"><a href="#cb29-206" aria-hidden="true" tabindex="-1"></a>            patch_mask <span class="op">=</span> mask[y:y<span class="op">+</span>patch_size, x:x<span class="op">+</span>patch_size]</span>
<span id="cb29-207"><a href="#cb29-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-208"><a href="#cb29-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> np.mean(patch_mask) <span class="op">&gt;</span> <span class="fl">0.8</span>:  <span class="co"># 80% valid</span></span>
<span id="cb29-209"><a href="#cb29-209" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Normalize</span></span>
<span id="cb29-210"><a href="#cb29-210" aria-hidden="true" tabindex="-1"></a>                patch_norm <span class="op">=</span> np.zeros_like(patch)</span>
<span id="cb29-211"><a href="#cb29-211" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(patch.shape[<span class="dv">0</span>]):</span>
<span id="cb29-212"><a href="#cb29-212" aria-hidden="true" tabindex="-1"></a>                    valid <span class="op">=</span> patch[c][<span class="op">~</span>np.isnan(patch[c])]</span>
<span id="cb29-213"><a href="#cb29-213" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb29-214"><a href="#cb29-214" aria-hidden="true" tabindex="-1"></a>                        p2, p98 <span class="op">=</span> np.percentile(valid, [<span class="dv">2</span>, <span class="dv">98</span>])</span>
<span id="cb29-215"><a href="#cb29-215" aria-hidden="true" tabindex="-1"></a>                        patch_norm[c] <span class="op">=</span> np.clip(</span>
<span id="cb29-216"><a href="#cb29-216" aria-hidden="true" tabindex="-1"></a>                            (patch[c] <span class="op">-</span> p2) <span class="op">/</span> (p98 <span class="op">-</span> p2 <span class="op">+</span> <span class="fl">1e-8</span>), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-217"><a href="#cb29-217" aria-hidden="true" tabindex="-1"></a>                        patch_norm[c] <span class="op">=</span> np.nan_to_num(patch_norm[c], <span class="dv">0</span>)</span>
<span id="cb29-218"><a href="#cb29-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-219"><a href="#cb29-219" aria-hidden="true" tabindex="-1"></a>                patches.append(patch_norm)</span>
<span id="cb29-220"><a href="#cb29-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-221"><a href="#cb29-221" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(patches) <span class="op">&gt;=</span> n_patches:</span>
<span id="cb29-222"><a href="#cb29-222" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb29-223"><a href="#cb29-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-224"><a href="#cb29-224" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.from_numpy(np.stack(patches)).<span class="bu">float</span>()</span>
<span id="cb29-225"><a href="#cb29-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-226"><a href="#cb29-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-227"><a href="#cb29-227" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Labels</span></span>
<span id="cb29-228"><a href="#cb29-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-229"><a href="#cb29-229" aria-hidden="true" tabindex="-1"></a>The <span class="in">`create_labels`</span> function generates simple, automatically assigned labels for satellite image patches based on their spectral characteristics, such as NDVI. These pseudo-labels (e.g., marking high NDVI areas as vegetation) serve as a basic example to help demonstrate and test the TerraTorch workflow. This label generation approach is not intended to be scientifically robust or production-ready—it is included here to showcase key TerraTorch features using a straightforward and easily understood process.</span>
<span id="cb29-230"><a href="#cb29-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-233"><a href="#cb29-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-234"><a href="#cb29-234" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/c03.py</span></span>
<span id="cb29-235"><a href="#cb29-235" aria-hidden="true" tabindex="-1"></a><span class="co">#| mode: append</span></span>
<span id="cb29-236"><a href="#cb29-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-237"><a href="#cb29-237" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_labels(patches):</span>
<span id="cb29-238"><a href="#cb29-238" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-239"><a href="#cb29-239" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate pseudo-labels for input patches based on their spectral signatures.</span></span>
<span id="cb29-240"><a href="#cb29-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-241"><a href="#cb29-241" aria-hidden="true" tabindex="-1"></a><span class="co">    Labels are assigned as follows:</span></span>
<span id="cb29-242"><a href="#cb29-242" aria-hidden="true" tabindex="-1"></a><span class="co">        - 0: Vegetation (NDVI mean &gt; 0.5)</span></span>
<span id="cb29-243"><a href="#cb29-243" aria-hidden="true" tabindex="-1"></a><span class="co">        - 1: Water      (NDVI mean &lt; 0)</span></span>
<span id="cb29-244"><a href="#cb29-244" aria-hidden="true" tabindex="-1"></a><span class="co">        - 2: Other      (otherwise)</span></span>
<span id="cb29-245"><a href="#cb29-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-246"><a href="#cb29-246" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb29-247"><a href="#cb29-247" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb29-248"><a href="#cb29-248" aria-hidden="true" tabindex="-1"></a><span class="co">    patches : list or array-like</span></span>
<span id="cb29-249"><a href="#cb29-249" aria-hidden="true" tabindex="-1"></a><span class="co">        Sequence of image patches as numpy arrays or tensors, each with shape (bands, height, width).</span></span>
<span id="cb29-250"><a href="#cb29-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-251"><a href="#cb29-251" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb29-252"><a href="#cb29-252" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb29-253"><a href="#cb29-253" aria-hidden="true" tabindex="-1"></a><span class="co">    labels : torch.Tensor</span></span>
<span id="cb29-254"><a href="#cb29-254" aria-hidden="true" tabindex="-1"></a><span class="co">        1D tensor of integer labels with length equal to number of patches.</span></span>
<span id="cb29-255"><a href="#cb29-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-256"><a href="#cb29-256" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb29-257"><a href="#cb29-257" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb29-258"><a href="#cb29-258" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; patches = [np.random.rand(6, 64, 64) for _ in range(10)]</span></span>
<span id="cb29-259"><a href="#cb29-259" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; labels = create_labels(patches)</span></span>
<span id="cb29-260"><a href="#cb29-260" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; print(labels)</span></span>
<span id="cb29-261"><a href="#cb29-261" aria-hidden="true" tabindex="-1"></a><span class="co">    tensor([2, 0, 2, 1, 0, 2, 0, 2, 1, 0])</span></span>
<span id="cb29-262"><a href="#cb29-262" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-263"><a href="#cb29-263" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> []</span>
<span id="cb29-264"><a href="#cb29-264" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> patch <span class="kw">in</span> patches:</span>
<span id="cb29-265"><a href="#cb29-265" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prithvi bands: Blue, Green, Red, NIR, SWIR1, SWIR2</span></span>
<span id="cb29-266"><a href="#cb29-266" aria-hidden="true" tabindex="-1"></a>        blue, green, red, nir, swir1, swir2 <span class="op">=</span> patch</span>
<span id="cb29-267"><a href="#cb29-267" aria-hidden="true" tabindex="-1"></a>        ndvi <span class="op">=</span> (nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb29-268"><a href="#cb29-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-269"><a href="#cb29-269" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Simple classification</span></span>
<span id="cb29-270"><a href="#cb29-270" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ndvi.mean() <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb29-271"><a href="#cb29-271" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="dv">0</span>)  <span class="co"># Vegetation</span></span>
<span id="cb29-272"><a href="#cb29-272" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> ndvi.mean() <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb29-273"><a href="#cb29-273" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="dv">1</span>)  <span class="co"># Water</span></span>
<span id="cb29-274"><a href="#cb29-274" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb29-275"><a href="#cb29-275" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="dv">2</span>)  <span class="co"># Other</span></span>
<span id="cb29-276"><a href="#cb29-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-277"><a href="#cb29-277" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.tensor(labels)</span>
<span id="cb29-278"><a href="#cb29-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-279"><a href="#cb29-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-280"><a href="#cb29-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-281"><a href="#cb29-281" aria-hidden="true" tabindex="-1"></a><span class="fu">### `PatchDataset` Object Definition</span></span>
<span id="cb29-282"><a href="#cb29-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-283"><a href="#cb29-283" aria-hidden="true" tabindex="-1"></a>PatchDataset is a custom dataset class that inherits from PyTorch's <span class="in">`Dataset`</span> object. By extending <span class="in">`Dataset`</span>, <span class="in">`PatchDataset`</span> can be used seamlessly with PyTorch's data loading utilities, such as <span class="in">`DataLoader`</span>. In this class, we store our patch tensors and their corresponding labels, and implement the <span class="in">`__len__`</span> and <span class="in">`__getitem__`</span> methods required for efficient data batching and shuffling during training and evaluation. In our workflow, <span class="in">`PatchDataset`</span> enables structured, efficient access to labeled image patches for training, validation, and testing deep learning models.</span>
<span id="cb29-284"><a href="#cb29-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-285"><a href="#cb29-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-288"><a href="#cb29-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-289"><a href="#cb29-289" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/c03.py</span></span>
<span id="cb29-290"><a href="#cb29-290" aria-hidden="true" tabindex="-1"></a><span class="co">#| mode: append</span></span>
<span id="cb29-291"><a href="#cb29-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-292"><a href="#cb29-292" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PatchDataset(Dataset):</span>
<span id="cb29-293"><a href="#cb29-293" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, patches, labels):</span>
<span id="cb29-294"><a href="#cb29-294" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.patches <span class="op">=</span> patches</span>
<span id="cb29-295"><a href="#cb29-295" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.labels <span class="op">=</span> labels</span>
<span id="cb29-296"><a href="#cb29-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-297"><a href="#cb29-297" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb29-298"><a href="#cb29-298" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.patches)</span>
<span id="cb29-299"><a href="#cb29-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-300"><a href="#cb29-300" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb29-301"><a href="#cb29-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.patches[idx], <span class="va">self</span>.labels[idx]</span>
<span id="cb29-302"><a href="#cb29-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-303"><a href="#cb29-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-304"><a href="#cb29-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-305"><a href="#cb29-305" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Sample Datasets</span></span>
<span id="cb29-306"><a href="#cb29-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-307"><a href="#cb29-307" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load Satellite Data</span></span>
<span id="cb29-308"><a href="#cb29-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-309"><a href="#cb29-309" aria-hidden="true" tabindex="-1"></a>We'll load a small Sentinel-2 scene and extract patches for our examples using our existing library code.</span>
<span id="cb29-310"><a href="#cb29-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-313"><a href="#cb29-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-314"><a href="#cb29-314" aria-hidden="true" tabindex="-1"></a><span class="co"># Small AOI in Santa Barbara (5km x 5km)</span></span>
<span id="cb29-315"><a href="#cb29-315" aria-hidden="true" tabindex="-1"></a>aoi <span class="op">=</span> [<span class="op">-</span><span class="fl">119.85</span>, <span class="fl">34.40</span>, <span class="op">-</span><span class="fl">119.75</span>, <span class="fl">34.48</span>]</span>
<span id="cb29-316"><a href="#cb29-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-317"><a href="#cb29-317" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for clear scene</span></span>
<span id="cb29-318"><a href="#cb29-318" aria-hidden="true" tabindex="-1"></a>scenes <span class="op">=</span> search_sentinel2_scenes(</span>
<span id="cb29-319"><a href="#cb29-319" aria-hidden="true" tabindex="-1"></a>    bbox<span class="op">=</span>aoi, </span>
<span id="cb29-320"><a href="#cb29-320" aria-hidden="true" tabindex="-1"></a>    date_range<span class="op">=</span><span class="st">"2023-06-01/2023-08-31"</span>,</span>
<span id="cb29-321"><a href="#cb29-321" aria-hidden="true" tabindex="-1"></a>    cloud_cover_max<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb29-322"><a href="#cb29-322" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span><span class="dv">1</span></span>
<span id="cb29-323"><a href="#cb29-323" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-324"><a href="#cb29-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-325"><a href="#cb29-325" aria-hidden="true" tabindex="-1"></a>scene <span class="op">=</span> scenes[<span class="dv">0</span>]</span>
<span id="cb29-326"><a href="#cb29-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-327"><a href="#cb29-327" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Using scene: </span><span class="sc">{</span>scene<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">30</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb29-328"><a href="#cb29-328" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Date: </span><span class="sc">{</span>scene<span class="sc">.</span>properties[<span class="st">'datetime'</span>][:<span class="dv">10</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-329"><a href="#cb29-329" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Cloud cover: </span><span class="sc">{</span>scene<span class="sc">.</span>properties[<span class="st">'eo:cloud_cover'</span>]<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb29-330"><a href="#cb29-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-331"><a href="#cb29-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-332"><a href="#cb29-332" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extract Patches</span></span>
<span id="cb29-335"><a href="#cb29-335" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-336"><a href="#cb29-336" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract patches</span></span>
<span id="cb29-337"><a href="#cb29-337" aria-hidden="true" tabindex="-1"></a>patches <span class="op">=</span> extract_patches(scene, aoi, patch_size<span class="op">=</span><span class="dv">64</span>, n_patches<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb29-338"><a href="#cb29-338" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Extracted </span><span class="sc">{</span><span class="bu">len</span>(patches)<span class="sc">}</span><span class="ss"> patches of shape </span><span class="sc">{</span>patches[<span class="dv">0</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-339"><a href="#cb29-339" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-340"><a href="#cb29-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-341"><a href="#cb29-341" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Labels:</span></span>
<span id="cb29-344"><a href="#cb29-344" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-345"><a href="#cb29-345" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> create_labels(patches)</span>
<span id="cb29-346"><a href="#cb29-346" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Label distribution: </span><span class="sc">{</span>torch<span class="sc">.</span>bincount(labels)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-347"><a href="#cb29-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-348"><a href="#cb29-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-349"><a href="#cb29-349" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualize some example patches and labels:</span></span>
<span id="cb29-350"><a href="#cb29-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-353"><a href="#cb29-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-354"><a href="#cb29-354" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb29-355"><a href="#cb29-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-356"><a href="#cb29-356" aria-hidden="true" tabindex="-1"></a><span class="co"># Map label integers to class names</span></span>
<span id="cb29-357"><a href="#cb29-357" aria-hidden="true" tabindex="-1"></a>class_names <span class="op">=</span> {<span class="dv">0</span>: <span class="st">'Vegetation'</span>, <span class="dv">1</span>: <span class="st">'Water'</span>, <span class="dv">2</span>: <span class="st">'Other'</span>}</span>
<span id="cb29-358"><a href="#cb29-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-359"><a href="#cb29-359" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a few (e.g., 6) random patches to visualize</span></span>
<span id="cb29-360"><a href="#cb29-360" aria-hidden="true" tabindex="-1"></a>num_examples <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb29-361"><a href="#cb29-361" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> torch.randperm(<span class="bu">len</span>(patches))[:num_examples]</span>
<span id="cb29-362"><a href="#cb29-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-363"><a href="#cb29-363" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, num_examples, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">3</span>))</span>
<span id="cb29-364"><a href="#cb29-364" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, idx <span class="kw">in</span> <span class="bu">zip</span>(axes, indices):</span>
<span id="cb29-365"><a href="#cb29-365" aria-hidden="true" tabindex="-1"></a>    patch <span class="op">=</span> patches[idx]</span>
<span id="cb29-366"><a href="#cb29-366" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HLS: bands are typically in (C, H, W) format; show an RGB composite</span></span>
<span id="cb29-367"><a href="#cb29-367" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here, assume RGB = bands 2,1,0 (if patch shape[0]&gt;=3)</span></span>
<span id="cb29-368"><a href="#cb29-368" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> patch.shape[<span class="dv">0</span>] <span class="op">&gt;=</span> <span class="dv">3</span>:</span>
<span id="cb29-369"><a href="#cb29-369" aria-hidden="true" tabindex="-1"></a>        rgb <span class="op">=</span> patch[:<span class="dv">3</span>].permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb29-370"><a href="#cb29-370" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Scale for visualization</span></span>
<span id="cb29-371"><a href="#cb29-371" aria-hidden="true" tabindex="-1"></a>        rgb_min <span class="op">=</span> rgb.<span class="bu">min</span>().item()</span>
<span id="cb29-372"><a href="#cb29-372" aria-hidden="true" tabindex="-1"></a>        rgb_max <span class="op">=</span> rgb.<span class="bu">max</span>().item()</span>
<span id="cb29-373"><a href="#cb29-373" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rgb_max <span class="op">&gt;</span> rgb_min:</span>
<span id="cb29-374"><a href="#cb29-374" aria-hidden="true" tabindex="-1"></a>            rgb_vis <span class="op">=</span> (rgb <span class="op">-</span> rgb_min) <span class="op">/</span> (rgb_max <span class="op">-</span> rgb_min)</span>
<span id="cb29-375"><a href="#cb29-375" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb29-376"><a href="#cb29-376" aria-hidden="true" tabindex="-1"></a>            rgb_vis <span class="op">=</span> rgb</span>
<span id="cb29-377"><a href="#cb29-377" aria-hidden="true" tabindex="-1"></a>        ax.imshow(rgb_vis)</span>
<span id="cb29-378"><a href="#cb29-378" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb29-379"><a href="#cb29-379" aria-hidden="true" tabindex="-1"></a>        ax.imshow(patch[<span class="dv">0</span>].cpu(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb29-380"><a href="#cb29-380" aria-hidden="true" tabindex="-1"></a>    label <span class="op">=</span> labels[idx].item() <span class="cf">if</span> <span class="bu">hasattr</span>(labels[idx], <span class="st">'item'</span>) <span class="cf">else</span> labels[idx]</span>
<span id="cb29-381"><a href="#cb29-381" aria-hidden="true" tabindex="-1"></a>    ax.set_title(class_names[label])</span>
<span id="cb29-382"><a href="#cb29-382" aria-hidden="true" tabindex="-1"></a>    ax.axis(<span class="st">'off'</span>)</span>
<span id="cb29-383"><a href="#cb29-383" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb29-384"><a href="#cb29-384" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb29-385"><a href="#cb29-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-386"><a href="#cb29-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-387"><a href="#cb29-387" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Training/Validation/Testing Datasets:</span></span>
<span id="cb29-388"><a href="#cb29-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-389"><a href="#cb29-389" aria-hidden="true" tabindex="-1"></a><span class="fu"># We split our patch dataset into three distinct sets:</span></span>
<span id="cb29-390"><a href="#cb29-390" aria-hidden="true" tabindex="-1"></a><span class="fu"># - Training set: Used to fit the model's weights (learn patterns).</span></span>
<span id="cb29-391"><a href="#cb29-391" aria-hidden="true" tabindex="-1"></a><span class="fu"># - Validation set: Used for intermediate evaluation to tune hyperparameters and select the best model, preventing overfitting.</span></span>
<span id="cb29-392"><a href="#cb29-392" aria-hidden="true" tabindex="-1"></a><span class="fu"># - Test set: Held out entirely until final evaluation to assess model generalization on unseen data.</span></span>
<span id="cb29-393"><a href="#cb29-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-394"><a href="#cb29-394" aria-hidden="true" tabindex="-1"></a><span class="fu"># Typical allocation ratios are:</span></span>
<span id="cb29-395"><a href="#cb29-395" aria-hidden="true" tabindex="-1"></a><span class="fu">#   70% for training,</span></span>
<span id="cb29-396"><a href="#cb29-396" aria-hidden="true" tabindex="-1"></a><span class="fu">#   15% for validation,</span></span>
<span id="cb29-397"><a href="#cb29-397" aria-hidden="true" tabindex="-1"></a><span class="fu">#   15% for testing.</span></span>
<span id="cb29-398"><a href="#cb29-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-399"><a href="#cb29-399" aria-hidden="true" tabindex="-1"></a><span class="fu"># Below, we compute indices for these splits and create dataset objects accordingly.</span></span>
<span id="cb29-400"><a href="#cb29-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-403"><a href="#cb29-403" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-404"><a href="#cb29-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data</span></span>
<span id="cb29-405"><a href="#cb29-405" aria-hidden="true" tabindex="-1"></a>n_train <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.7</span> <span class="op">*</span> <span class="bu">len</span>(patches))</span>
<span id="cb29-406"><a href="#cb29-406" aria-hidden="true" tabindex="-1"></a>n_val <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.15</span> <span class="op">*</span> <span class="bu">len</span>(patches))</span>
<span id="cb29-407"><a href="#cb29-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-408"><a href="#cb29-408" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> PatchDataset(patches[:n_train], labels[:n_train])</span>
<span id="cb29-409"><a href="#cb29-409" aria-hidden="true" tabindex="-1"></a>val_dataset <span class="op">=</span> PatchDataset(patches[n_train:n_train<span class="op">+</span>n_val], labels[n_train:n_train<span class="op">+</span>n_val])</span>
<span id="cb29-410"><a href="#cb29-410" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> PatchDataset(patches[n_train<span class="op">+</span>n_val:], labels[n_train<span class="op">+</span>n_val:])</span>
<span id="cb29-411"><a href="#cb29-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-412"><a href="#cb29-412" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Train: </span><span class="sc">{</span><span class="bu">len</span>(train_dataset)<span class="sc">}</span><span class="ss">, Val: </span><span class="sc">{</span><span class="bu">len</span>(val_dataset)<span class="sc">}</span><span class="ss">, Test: </span><span class="sc">{</span><span class="bu">len</span>(test_dataset)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-413"><a href="#cb29-413" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-414"><a href="#cb29-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-415"><a href="#cb29-415" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using TerraTorch Models</span></span>
<span id="cb29-416"><a href="#cb29-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-417"><a href="#cb29-417" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load a Pretrained Model</span></span>
<span id="cb29-418"><a href="#cb29-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-419"><a href="#cb29-419" aria-hidden="true" tabindex="-1"></a>The <span class="in">`EncoderDecoderFactory`</span> is a utility in TerraTorch that streamlines the creation of deep learning models based on the encoder-decoder architecture. This object abstracts away boilerplate and provides a simple interface for constructing models suited for a variety of earth observation tasks, such as classification or segmentation.</span>
<span id="cb29-420"><a href="#cb29-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-421"><a href="#cb29-421" aria-hidden="true" tabindex="-1"></a>When calling <span class="in">`build_model()`</span>, you specify several important arguments to configure the model:</span>
<span id="cb29-422"><a href="#cb29-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-423"><a href="#cb29-423" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`task`</span>: The type of problem you are solving (e.g., <span class="in">`"classification"`</span> for assigning a label to an image patch, or <span class="in">`"segmentation"`</span> for pixel-wise classification).</span>
<span id="cb29-424"><a href="#cb29-424" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`backbone`</span>: The encoder neural network that extracts features from the input data. Common options include pretrained vision transformers like <span class="in">`"prithvi_eo_v1_100"`</span> (Prithvi-100M), <span class="in">`"resnet18"`</span>, <span class="in">`"resnet50"`</span>, etc.</span>
<span id="cb29-425"><a href="#cb29-425" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`decoder`</span>: The decoder determines how extracted features are transformed for the target task. Options include <span class="in">`"FCNDecoder"`</span> for simple classification, <span class="in">`"UNetDecoder"`</span>, etc.</span>
<span id="cb29-426"><a href="#cb29-426" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`num_classes`</span>: The number of output classes for your problem (for example, 3 land cover types in our current classification task).</span>
<span id="cb29-427"><a href="#cb29-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-428"><a href="#cb29-428" aria-hidden="true" tabindex="-1"></a>These parameters allow you to flexibly adapt powerful pretrained models to your specific remote sensing task.</span>
<span id="cb29-429"><a href="#cb29-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-430"><a href="#cb29-430" aria-hidden="true" tabindex="-1"></a>**Example usage:**</span>
<span id="cb29-431"><a href="#cb29-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-432"><a href="#cb29-432" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb29-433"><a href="#cb29-433" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_factory.build_model(</span>
<span id="cb29-434"><a href="#cb29-434" aria-hidden="true" tabindex="-1"></a>    task<span class="op">=</span><span class="st">"classification"</span>,            <span class="co"># classification or segmentation</span></span>
<span id="cb29-435"><a href="#cb29-435" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">"prithvi_eo_v1_100"</span>,     <span class="co"># encoder/feature extractor</span></span>
<span id="cb29-436"><a href="#cb29-436" aria-hidden="true" tabindex="-1"></a>    decoder<span class="op">=</span><span class="st">"FCNDecoder"</span>,             <span class="co"># type of decoder/classification head</span></span>
<span id="cb29-437"><a href="#cb29-437" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="dv">3</span>                     <span class="co"># number of output classes</span></span>
<span id="cb29-438"><a href="#cb29-438" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-439"><a href="#cb29-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-440"><a href="#cb29-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-441"><a href="#cb29-441" aria-hidden="true" tabindex="-1"></a>Other parameters (see the <span class="co">[</span><span class="ot">TerraTorch documentation</span><span class="co">](https://terra-torch.readthedocs.io/en/latest/)</span> for more options) can control things like input channels, dropout, and patch size, enabling further customization.</span>
<span id="cb29-442"><a href="#cb29-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-443"><a href="#cb29-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-446"><a href="#cb29-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-447"><a href="#cb29-447" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb29-448"><a href="#cb29-448" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> terratorch.models <span class="im">import</span> EncoderDecoderFactory</span>
<span id="cb29-449"><a href="#cb29-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-450"><a href="#cb29-450" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create model factory</span></span>
<span id="cb29-451"><a href="#cb29-451" aria-hidden="true" tabindex="-1"></a>    model_factory <span class="op">=</span> EncoderDecoderFactory()</span>
<span id="cb29-452"><a href="#cb29-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-453"><a href="#cb29-453" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build classification model with Prithvi backbone</span></span>
<span id="cb29-454"><a href="#cb29-454" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_factory.build_model(</span>
<span id="cb29-455"><a href="#cb29-455" aria-hidden="true" tabindex="-1"></a>        task<span class="op">=</span><span class="st">"classification"</span>,</span>
<span id="cb29-456"><a href="#cb29-456" aria-hidden="true" tabindex="-1"></a>        backbone<span class="op">=</span><span class="st">"prithvi_eo_v1_100"</span>,</span>
<span id="cb29-457"><a href="#cb29-457" aria-hidden="true" tabindex="-1"></a>        decoder<span class="op">=</span><span class="st">"FCNDecoder"</span>,</span>
<span id="cb29-458"><a href="#cb29-458" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span><span class="dv">3</span></span>
<span id="cb29-459"><a href="#cb29-459" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-460"><a href="#cb29-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-461"><a href="#cb29-461" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"Loaded Prithvi-100M model"</span>)</span>
<span id="cb29-462"><a href="#cb29-462" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f"Parameters: </span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb29-463"><a href="#cb29-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-464"><a href="#cb29-464" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb29-465"><a href="#cb29-465" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"TerraTorch not installed. Install with: pip install terratorch"</span>)</span>
<span id="cb29-466"><a href="#cb29-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-467"><a href="#cb29-467" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span>
<span id="cb29-468"><a href="#cb29-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-469"><a href="#cb29-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-470"><a href="#cb29-470" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 1: Classification</span></span>
<span id="cb29-471"><a href="#cb29-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-472"><a href="#cb29-472" aria-hidden="true" tabindex="-1"></a><span class="fu">### Train the Model</span></span>
<span id="cb29-473"><a href="#cb29-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-474"><a href="#cb29-474" aria-hidden="true" tabindex="-1"></a>Model training and validation loops are fundamental routines in deep learning workflows. </span>
<span id="cb29-475"><a href="#cb29-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-476"><a href="#cb29-476" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The **training loop** iterates over batches of data, computes predictions using the model, evaluates a loss function, performs backpropagation, and updates model parameters with an optimizer. </span>
<span id="cb29-477"><a href="#cb29-477" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The **validation loop** evaluates the model on unseen data without updating parameters (i.e., in <span class="in">`eval`</span> mode and without gradient computation). It is used to track performance and detect overfitting.</span>
<span id="cb29-478"><a href="#cb29-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-479"><a href="#cb29-479" aria-hidden="true" tabindex="-1"></a>In the code below, the <span class="in">`train_model`</span> function implements both loops:</span>
<span id="cb29-480"><a href="#cb29-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-481"><a href="#cb29-481" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>During training, it sets the model to training mode (<span class="in">`model.train()`</span>), zeroes gradients, computes loss and accuracy, backpropagates, and steps the optimizer for each batch.</span>
<span id="cb29-482"><a href="#cb29-482" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>During validation, it switches to evaluation mode (<span class="in">`model.eval()`</span>), disables gradient computation (<span class="in">`with torch.no_grad()`</span>), and calculates loss and accuracy.</span>
<span id="cb29-483"><a href="#cb29-483" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Losses and accuracies are accumulated and averaged over all batches for both sets.</span>
<span id="cb29-484"><a href="#cb29-484" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Training and validation history is collected in a dictionary for analysis.</span>
<span id="cb29-485"><a href="#cb29-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-486"><a href="#cb29-486" aria-hidden="true" tabindex="-1"></a>**Limitations and assumptions:**</span>
<span id="cb29-487"><a href="#cb29-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-488"><a href="#cb29-488" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The code assumes a simple classification task with standard <span class="in">`CrossEntropyLoss`</span> and that labels are properly formatted for it.</span>
<span id="cb29-489"><a href="#cb29-489" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>There's no support for advanced features like data augmentation, learning rate scheduling, early stopping, or mixed-precision training.</span>
<span id="cb29-490"><a href="#cb29-490" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No checkpointing or logging of model weights is implemented.</span>
<span id="cb29-491"><a href="#cb29-491" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The function globally assumes the device (CPU or GPU) context is handled outside (for both model and batches).</span>
<span id="cb29-492"><a href="#cb29-492" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It does not handle distributed/multi-GPU training or non-image data modalities.</span>
<span id="cb29-493"><a href="#cb29-493" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Batch sizes and data shuffling are expected to be handled by the user in DataLoader construction.</span>
<span id="cb29-494"><a href="#cb29-494" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For production, you'd want explicit error handling, flexibility for other tasks/losses, and possibly hooks for callbacks or custom metrics.</span>
<span id="cb29-495"><a href="#cb29-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-496"><a href="#cb29-496" aria-hidden="true" tabindex="-1"></a>This simple structure works well for prototyping and educational purposes, but for robust, scalable applications, more initialization, error resistance, and configurability are needed.</span>
<span id="cb29-497"><a href="#cb29-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-498"><a href="#cb29-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-501"><a href="#cb29-501" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-502"><a href="#cb29-502" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/c03.py</span></span>
<span id="cb29-503"><a href="#cb29-503" aria-hidden="true" tabindex="-1"></a><span class="co">#| mode: append</span></span>
<span id="cb29-504"><a href="#cb29-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-505"><a href="#cb29-505" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, train_loader, val_loader, epochs<span class="op">=</span><span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-4</span>):</span>
<span id="cb29-506"><a href="#cb29-506" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-507"><a href="#cb29-507" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains a classification model using a simple training and validation loop.</span></span>
<span id="cb29-508"><a href="#cb29-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-509"><a href="#cb29-509" aria-hidden="true" tabindex="-1"></a><span class="co">    This function optimizes the model's parameters based on the training dataset and evaluates </span></span>
<span id="cb29-510"><a href="#cb29-510" aria-hidden="true" tabindex="-1"></a><span class="co">    performance on the validation set at the end of each epoch. It supports standard image </span></span>
<span id="cb29-511"><a href="#cb29-511" aria-hidden="true" tabindex="-1"></a><span class="co">    classification tasks with models returning logits, such as those from TerraTorch or PyTorch.</span></span>
<span id="cb29-512"><a href="#cb29-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-513"><a href="#cb29-513" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb29-514"><a href="#cb29-514" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb29-515"><a href="#cb29-515" aria-hidden="true" tabindex="-1"></a><span class="co">    model : torch.nn.Module</span></span>
<span id="cb29-516"><a href="#cb29-516" aria-hidden="true" tabindex="-1"></a><span class="co">        The neural network model to train. Should output logits when given images.</span></span>
<span id="cb29-517"><a href="#cb29-517" aria-hidden="true" tabindex="-1"></a><span class="co">    train_loader : torch.utils.data.DataLoader</span></span>
<span id="cb29-518"><a href="#cb29-518" aria-hidden="true" tabindex="-1"></a><span class="co">        DataLoader instance providing the training data batches (images, labels).</span></span>
<span id="cb29-519"><a href="#cb29-519" aria-hidden="true" tabindex="-1"></a><span class="co">    val_loader : torch.utils.data.DataLoader</span></span>
<span id="cb29-520"><a href="#cb29-520" aria-hidden="true" tabindex="-1"></a><span class="co">        DataLoader instance providing the validation data batches (images, labels).</span></span>
<span id="cb29-521"><a href="#cb29-521" aria-hidden="true" tabindex="-1"></a><span class="co">    epochs : int, optional</span></span>
<span id="cb29-522"><a href="#cb29-522" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of times to iterate over the training dataset (default is 10).</span></span>
<span id="cb29-523"><a href="#cb29-523" aria-hidden="true" tabindex="-1"></a><span class="co">    lr : float, optional</span></span>
<span id="cb29-524"><a href="#cb29-524" aria-hidden="true" tabindex="-1"></a><span class="co">        Learning rate for the Adam optimizer (default is 1e-4).</span></span>
<span id="cb29-525"><a href="#cb29-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-526"><a href="#cb29-526" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb29-527"><a href="#cb29-527" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb29-528"><a href="#cb29-528" aria-hidden="true" tabindex="-1"></a><span class="co">    history : dict</span></span>
<span id="cb29-529"><a href="#cb29-529" aria-hidden="true" tabindex="-1"></a><span class="co">        A dictionary containing lists of loss and accuracy values per epoch for training and validation.</span></span>
<span id="cb29-530"><a href="#cb29-530" aria-hidden="true" tabindex="-1"></a><span class="co">        Keys are: 'train_loss', 'train_acc', 'val_loss', 'val_acc'.</span></span>
<span id="cb29-531"><a href="#cb29-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-532"><a href="#cb29-532" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb29-533"><a href="#cb29-533" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb29-534"><a href="#cb29-534" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; model = model_factory.build_model(task="classification", backbone="prithvi_eo_v1_100", decoder="FCNDecoder", num_classes=3)</span></span>
<span id="cb29-535"><a href="#cb29-535" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; model = model.to(device)</span></span>
<span id="cb29-536"><a href="#cb29-536" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=64, shuffle=True)</span></span>
<span id="cb29-537"><a href="#cb29-537" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; val_loader = torch.utils.data.DataLoader(val_dataset, batch_size=64)</span></span>
<span id="cb29-538"><a href="#cb29-538" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; history = train_model(model, train_loader, val_loader, epochs=5, lr=1e-4)</span></span>
<span id="cb29-539"><a href="#cb29-539" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; print(history["train_acc"])</span></span>
<span id="cb29-540"><a href="#cb29-540" aria-hidden="true" tabindex="-1"></a><span class="co">    [0.70, 0.84, 0.89, 0.91, 0.93]</span></span>
<span id="cb29-541"><a href="#cb29-541" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-542"><a href="#cb29-542" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The optimizer updates model parameters to minimize the loss during training.</span></span>
<span id="cb29-543"><a href="#cb29-543" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here we use Adam, a popular optimizer for deep learning that adapts learning rates.</span></span>
<span id="cb29-544"><a href="#cb29-544" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span>lr)</span>
<span id="cb29-545"><a href="#cb29-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-546"><a href="#cb29-546" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The criterion defines the loss function, which measures how far the model's predictions</span></span>
<span id="cb29-547"><a href="#cb29-547" aria-hidden="true" tabindex="-1"></a>    <span class="co"># are from the correct labels. CrossEntropyLoss is standard for multiclass classification.</span></span>
<span id="cb29-548"><a href="#cb29-548" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb29-549"><a href="#cb29-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-550"><a href="#cb29-550" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> {<span class="st">'train_loss'</span>: [], <span class="st">'train_acc'</span>: [],</span>
<span id="cb29-551"><a href="#cb29-551" aria-hidden="true" tabindex="-1"></a>               <span class="st">'val_loss'</span>: [], <span class="st">'val_acc'</span>: []}</span>
<span id="cb29-552"><a href="#cb29-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-553"><a href="#cb29-553" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb29-554"><a href="#cb29-554" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train</span></span>
<span id="cb29-555"><a href="#cb29-555" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb29-556"><a href="#cb29-556" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">=</span> <span class="dv">0</span>    <span class="co"># Sum of losses for the epoch</span></span>
<span id="cb29-557"><a href="#cb29-557" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">=</span> <span class="dv">0</span>      <span class="co"># Number of correctly predicted samples</span></span>
<span id="cb29-558"><a href="#cb29-558" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span>        <span class="co"># Total number of samples processed</span></span>
<span id="cb29-559"><a href="#cb29-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-560"><a href="#cb29-560" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, targets <span class="kw">in</span> train_loader:</span>
<span id="cb29-561"><a href="#cb29-561" aria-hidden="true" tabindex="-1"></a>            images, targets <span class="op">=</span> images.to(device), targets.to(device)</span>
<span id="cb29-562"><a href="#cb29-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-563"><a href="#cb29-563" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb29-564"><a href="#cb29-564" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb29-565"><a href="#cb29-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-566"><a href="#cb29-566" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb29-567"><a href="#cb29-567" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb29-568"><a href="#cb29-568" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> outputs.output</span>
<span id="cb29-569"><a href="#cb29-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-570"><a href="#cb29-570" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(outputs, targets)</span>
<span id="cb29-571"><a href="#cb29-571" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb29-572"><a href="#cb29-572" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb29-573"><a href="#cb29-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-574"><a href="#cb29-574" aria-hidden="true" tabindex="-1"></a>            train_loss <span class="op">+=</span> loss.item()</span>
<span id="cb29-575"><a href="#cb29-575" aria-hidden="true" tabindex="-1"></a>            _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb29-576"><a href="#cb29-576" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> targets.size(<span class="dv">0</span>)</span>
<span id="cb29-577"><a href="#cb29-577" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> predicted.eq(targets).<span class="bu">sum</span>().item()</span>
<span id="cb29-578"><a href="#cb29-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-579"><a href="#cb29-579" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">/=</span> <span class="bu">len</span>(train_loader)</span>
<span id="cb29-580"><a href="#cb29-580" aria-hidden="true" tabindex="-1"></a>        train_acc <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb29-581"><a href="#cb29-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-582"><a href="#cb29-582" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validate</span></span>
<span id="cb29-583"><a href="#cb29-583" aria-hidden="true" tabindex="-1"></a>        model.<span class="bu">eval</span>()</span>
<span id="cb29-584"><a href="#cb29-584" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-585"><a href="#cb29-585" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-586"><a href="#cb29-586" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-587"><a href="#cb29-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-588"><a href="#cb29-588" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-589"><a href="#cb29-589" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> images, targets <span class="kw">in</span> val_loader:</span>
<span id="cb29-590"><a href="#cb29-590" aria-hidden="true" tabindex="-1"></a>                images, targets <span class="op">=</span> images.to(device), targets.to(device)</span>
<span id="cb29-591"><a href="#cb29-591" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> model(images)</span>
<span id="cb29-592"><a href="#cb29-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-593"><a href="#cb29-593" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb29-594"><a href="#cb29-594" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb29-595"><a href="#cb29-595" aria-hidden="true" tabindex="-1"></a>                    outputs <span class="op">=</span> outputs.output</span>
<span id="cb29-596"><a href="#cb29-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-597"><a href="#cb29-597" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> criterion(outputs, targets)</span>
<span id="cb29-598"><a href="#cb29-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-599"><a href="#cb29-599" aria-hidden="true" tabindex="-1"></a>                val_loss <span class="op">+=</span> loss.item()</span>
<span id="cb29-600"><a href="#cb29-600" aria-hidden="true" tabindex="-1"></a>                _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb29-601"><a href="#cb29-601" aria-hidden="true" tabindex="-1"></a>                total <span class="op">+=</span> targets.size(<span class="dv">0</span>)</span>
<span id="cb29-602"><a href="#cb29-602" aria-hidden="true" tabindex="-1"></a>                correct <span class="op">+=</span> predicted.eq(targets).<span class="bu">sum</span>().item()</span>
<span id="cb29-603"><a href="#cb29-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-604"><a href="#cb29-604" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">/=</span> <span class="bu">len</span>(val_loader)</span>
<span id="cb29-605"><a href="#cb29-605" aria-hidden="true" tabindex="-1"></a>        val_acc <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb29-606"><a href="#cb29-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-607"><a href="#cb29-607" aria-hidden="true" tabindex="-1"></a>        history[<span class="st">'train_loss'</span>].append(train_loss)</span>
<span id="cb29-608"><a href="#cb29-608" aria-hidden="true" tabindex="-1"></a>        history[<span class="st">'train_acc'</span>].append(train_acc)</span>
<span id="cb29-609"><a href="#cb29-609" aria-hidden="true" tabindex="-1"></a>        history[<span class="st">'val_loss'</span>].append(val_loss)</span>
<span id="cb29-610"><a href="#cb29-610" aria-hidden="true" tabindex="-1"></a>        history[<span class="st">'val_acc'</span>].append(val_acc)</span>
<span id="cb29-611"><a href="#cb29-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-612"><a href="#cb29-612" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb29-613"><a href="#cb29-613" aria-hidden="true" tabindex="-1"></a>            logger.info(</span>
<span id="cb29-614"><a href="#cb29-614" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: Train Acc=</span><span class="sc">{</span>train_acc<span class="sc">:.3f}</span><span class="ss">, Val Acc=</span><span class="sc">{</span>val_acc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb29-615"><a href="#cb29-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-616"><a href="#cb29-616" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> history</span>
<span id="cb29-617"><a href="#cb29-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-618"><a href="#cb29-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-621"><a href="#cb29-621" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-622"><a href="#cb29-622" aria-hidden="true" tabindex="-1"></a><span class="co"># Create loaders</span></span>
<span id="cb29-623"><a href="#cb29-623" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> DataLoader(train_dataset, batch_size<span class="op">=</span><span class="dv">32</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-624"><a href="#cb29-624" aria-hidden="true" tabindex="-1"></a>val_loader <span class="op">=</span> DataLoader(val_dataset, batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb29-625"><a href="#cb29-625" aria-hidden="true" tabindex="-1"></a>test_loader <span class="op">=</span> DataLoader(test_dataset, batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb29-626"><a href="#cb29-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-627"><a href="#cb29-627" aria-hidden="true" tabindex="-1"></a><span class="co"># Train</span></span>
<span id="cb29-628"><a href="#cb29-628" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="st">"Training classification model..."</span>)</span>
<span id="cb29-629"><a href="#cb29-629" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> train_model(model, train_loader, val_loader, epochs<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb29-630"><a href="#cb29-630" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-631"><a href="#cb29-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-632"><a href="#cb29-632" aria-hidden="true" tabindex="-1"></a><span class="fu">### Evaluate</span></span>
<span id="cb29-633"><a href="#cb29-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-636"><a href="#cb29-636" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-637"><a href="#cb29-637" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">eval</span>()</span>
<span id="cb29-638"><a href="#cb29-638" aria-hidden="true" tabindex="-1"></a>correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-639"><a href="#cb29-639" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-640"><a href="#cb29-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-641"><a href="#cb29-641" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-642"><a href="#cb29-642" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> images, targets <span class="kw">in</span> test_loader:</span>
<span id="cb29-643"><a href="#cb29-643" aria-hidden="true" tabindex="-1"></a>        images, targets <span class="op">=</span> images.to(device), targets.to(device)</span>
<span id="cb29-644"><a href="#cb29-644" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(images)</span>
<span id="cb29-645"><a href="#cb29-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-646"><a href="#cb29-646" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb29-647"><a href="#cb29-647" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb29-648"><a href="#cb29-648" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> outputs.output</span>
<span id="cb29-649"><a href="#cb29-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-650"><a href="#cb29-650" aria-hidden="true" tabindex="-1"></a>        _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb29-651"><a href="#cb29-651" aria-hidden="true" tabindex="-1"></a>        total <span class="op">+=</span> targets.size(<span class="dv">0</span>)</span>
<span id="cb29-652"><a href="#cb29-652" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">+=</span> predicted.eq(targets).<span class="bu">sum</span>().item()</span>
<span id="cb29-653"><a href="#cb29-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-654"><a href="#cb29-654" aria-hidden="true" tabindex="-1"></a>test_acc <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb29-655"><a href="#cb29-655" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Test accuracy: </span><span class="sc">{</span>test_acc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb29-656"><a href="#cb29-656" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-657"><a href="#cb29-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-658"><a href="#cb29-658" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualize Results</span></span>
<span id="cb29-659"><a href="#cb29-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-662"><a href="#cb29-662" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-663"><a href="#cb29-663" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb29-664"><a href="#cb29-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-665"><a href="#cb29-665" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(history[<span class="st">'train_loss'</span>]) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb29-666"><a href="#cb29-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-667"><a href="#cb29-667" aria-hidden="true" tabindex="-1"></a>ax1.plot(epochs, history[<span class="st">'train_loss'</span>], label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb29-668"><a href="#cb29-668" aria-hidden="true" tabindex="-1"></a>ax1.plot(epochs, history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'Val'</span>)</span>
<span id="cb29-669"><a href="#cb29-669" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb29-670"><a href="#cb29-670" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb29-671"><a href="#cb29-671" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Training Loss'</span>)</span>
<span id="cb29-672"><a href="#cb29-672" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb29-673"><a href="#cb29-673" aria-hidden="true" tabindex="-1"></a>ax1.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb29-674"><a href="#cb29-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-675"><a href="#cb29-675" aria-hidden="true" tabindex="-1"></a>ax2.plot(epochs, history[<span class="st">'train_acc'</span>], label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb29-676"><a href="#cb29-676" aria-hidden="true" tabindex="-1"></a>ax2.plot(epochs, history[<span class="st">'val_acc'</span>], label<span class="op">=</span><span class="st">'Val'</span>)</span>
<span id="cb29-677"><a href="#cb29-677" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb29-678"><a href="#cb29-678" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb29-679"><a href="#cb29-679" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Training Accuracy'</span>)</span>
<span id="cb29-680"><a href="#cb29-680" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="cb29-681"><a href="#cb29-681" aria-hidden="true" tabindex="-1"></a>ax2.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb29-682"><a href="#cb29-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-683"><a href="#cb29-683" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb29-684"><a href="#cb29-684" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb29-685"><a href="#cb29-685" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-686"><a href="#cb29-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-687"><a href="#cb29-687" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 2: Segmentation</span></span>
<span id="cb29-688"><a href="#cb29-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-689"><a href="#cb29-689" aria-hidden="true" tabindex="-1"></a>Using the same data for a different task.</span>
<span id="cb29-690"><a href="#cb29-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-693"><a href="#cb29-693" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-694"><a href="#cb29-694" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb29-695"><a href="#cb29-695" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create segmentation model with same backbone</span></span>
<span id="cb29-696"><a href="#cb29-696" aria-hidden="true" tabindex="-1"></a>    seg_model <span class="op">=</span> model_factory.build_model(</span>
<span id="cb29-697"><a href="#cb29-697" aria-hidden="true" tabindex="-1"></a>        task<span class="op">=</span><span class="st">"segmentation"</span>,</span>
<span id="cb29-698"><a href="#cb29-698" aria-hidden="true" tabindex="-1"></a>        backbone<span class="op">=</span><span class="st">"prithvi_eo_v1_100"</span>,</span>
<span id="cb29-699"><a href="#cb29-699" aria-hidden="true" tabindex="-1"></a>        decoder<span class="op">=</span><span class="st">"UperNetDecoder"</span>,</span>
<span id="cb29-700"><a href="#cb29-700" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span><span class="dv">3</span></span>
<span id="cb29-701"><a href="#cb29-701" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-702"><a href="#cb29-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-703"><a href="#cb29-703" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"Loaded Prithvi segmentation model"</span>)</span>
<span id="cb29-704"><a href="#cb29-704" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f"Parameters: </span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> seg_model.parameters())<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb29-705"><a href="#cb29-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-706"><a href="#cb29-706" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> (<span class="pp">ImportError</span>, <span class="pp">NameError</span>):</span>
<span id="cb29-707"><a href="#cb29-707" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Demo segmentation model</span></span>
<span id="cb29-708"><a href="#cb29-708" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> DemoSegModel(nn.Module):</span>
<span id="cb29-709"><a href="#cb29-709" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb29-710"><a href="#cb29-710" aria-hidden="true" tabindex="-1"></a>            <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb29-711"><a href="#cb29-711" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.conv1 <span class="op">=</span> nn.Conv2d(<span class="dv">6</span>, <span class="dv">64</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)  <span class="co"># 6 channels for HLS bands</span></span>
<span id="cb29-712"><a href="#cb29-712" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.conv2 <span class="op">=</span> nn.Conv2d(<span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-713"><a href="#cb29-713" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.conv3 <span class="op">=</span> nn.Conv2d(<span class="dv">128</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb29-714"><a href="#cb29-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-715"><a href="#cb29-715" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-716"><a href="#cb29-716" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> torch.relu(<span class="va">self</span>.conv1(x))</span>
<span id="cb29-717"><a href="#cb29-717" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> torch.relu(<span class="va">self</span>.conv2(x))</span>
<span id="cb29-718"><a href="#cb29-718" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.conv3(x)</span>
<span id="cb29-719"><a href="#cb29-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-720"><a href="#cb29-720" aria-hidden="true" tabindex="-1"></a>    seg_model <span class="op">=</span> DemoSegModel()</span>
<span id="cb29-721"><a href="#cb29-721" aria-hidden="true" tabindex="-1"></a>    logger.warning(<span class="st">"Demo segmentation model"</span>)</span>
<span id="cb29-722"><a href="#cb29-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-723"><a href="#cb29-723" aria-hidden="true" tabindex="-1"></a>seg_model <span class="op">=</span> seg_model.to(device)</span>
<span id="cb29-724"><a href="#cb29-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-725"><a href="#cb29-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-726"><a href="#cb29-726" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Segmentation Targets</span></span>
<span id="cb29-727"><a href="#cb29-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-730"><a href="#cb29-730" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-731"><a href="#cb29-731" aria-hidden="true" tabindex="-1"></a><span class="co"># | tangle: geogfm/c03.py</span></span>
<span id="cb29-732"><a href="#cb29-732" aria-hidden="true" tabindex="-1"></a><span class="co"># | mode: append</span></span>
<span id="cb29-733"><a href="#cb29-733" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb29-734"><a href="#cb29-734" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb29-735"><a href="#cb29-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-736"><a href="#cb29-736" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_seg_masks(patches):</span>
<span id="cb29-737"><a href="#cb29-737" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-738"><a href="#cb29-738" aria-hidden="true" tabindex="-1"></a><span class="co">    Create pixel-wise segmentation masks based on spectral signatures for each pixel.</span></span>
<span id="cb29-739"><a href="#cb29-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-740"><a href="#cb29-740" aria-hidden="true" tabindex="-1"></a><span class="co">    Labels are assigned per-pixel as follows:</span></span>
<span id="cb29-741"><a href="#cb29-741" aria-hidden="true" tabindex="-1"></a><span class="co">        - 0: Vegetation (NDVI &gt; 0.5)</span></span>
<span id="cb29-742"><a href="#cb29-742" aria-hidden="true" tabindex="-1"></a><span class="co">        - 1: Water (NDVI &lt; 0)</span></span>
<span id="cb29-743"><a href="#cb29-743" aria-hidden="true" tabindex="-1"></a><span class="co">        - 2: Other (otherwise)</span></span>
<span id="cb29-744"><a href="#cb29-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-745"><a href="#cb29-745" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb29-746"><a href="#cb29-746" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb29-747"><a href="#cb29-747" aria-hidden="true" tabindex="-1"></a><span class="co">    patches : torch.Tensor</span></span>
<span id="cb29-748"><a href="#cb29-748" aria-hidden="true" tabindex="-1"></a><span class="co">        Tensor of patches with shape (N, C, H, W) where C=6 bands.</span></span>
<span id="cb29-749"><a href="#cb29-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-750"><a href="#cb29-750" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb29-751"><a href="#cb29-751" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb29-752"><a href="#cb29-752" aria-hidden="true" tabindex="-1"></a><span class="co">    masks : torch.Tensor</span></span>
<span id="cb29-753"><a href="#cb29-753" aria-hidden="true" tabindex="-1"></a><span class="co">        Tensor of masks with shape (N, H, W) containing class labels for each pixel.</span></span>
<span id="cb29-754"><a href="#cb29-754" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-755"><a href="#cb29-755" aria-hidden="true" tabindex="-1"></a>    masks <span class="op">=</span> []</span>
<span id="cb29-756"><a href="#cb29-756" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> patch <span class="kw">in</span> patches:</span>
<span id="cb29-757"><a href="#cb29-757" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract bands: Blue, Green, Red, NIR, SWIR1, SWIR2</span></span>
<span id="cb29-758"><a href="#cb29-758" aria-hidden="true" tabindex="-1"></a>        blue, green, red, nir, swir1, swir2 <span class="op">=</span> patch</span>
<span id="cb29-759"><a href="#cb29-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-760"><a href="#cb29-760" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate NDVI for each pixel</span></span>
<span id="cb29-761"><a href="#cb29-761" aria-hidden="true" tabindex="-1"></a>        ndvi <span class="op">=</span> (nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb29-762"><a href="#cb29-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-763"><a href="#cb29-763" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize mask with "Other" class (2)</span></span>
<span id="cb29-764"><a href="#cb29-764" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> torch.ones_like(ndvi, dtype<span class="op">=</span>torch.<span class="bu">long</span>) <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb29-765"><a href="#cb29-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-766"><a href="#cb29-766" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign vegetation (0) where NDVI &gt; 0.5</span></span>
<span id="cb29-767"><a href="#cb29-767" aria-hidden="true" tabindex="-1"></a>        mask[ndvi <span class="op">&gt;</span> <span class="fl">0.5</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-768"><a href="#cb29-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-769"><a href="#cb29-769" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign water (1) where NDVI &lt; 0</span></span>
<span id="cb29-770"><a href="#cb29-770" aria-hidden="true" tabindex="-1"></a>        mask[ndvi <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb29-771"><a href="#cb29-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-772"><a href="#cb29-772" aria-hidden="true" tabindex="-1"></a>        masks.append(mask)</span>
<span id="cb29-773"><a href="#cb29-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-774"><a href="#cb29-774" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.stack(masks)</span>
<span id="cb29-775"><a href="#cb29-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-776"><a href="#cb29-776" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-777"><a href="#cb29-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-780"><a href="#cb29-780" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-781"><a href="#cb29-781" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/c03.py</span></span>
<span id="cb29-782"><a href="#cb29-782" aria-hidden="true" tabindex="-1"></a><span class="co">#| mode: append</span></span>
<span id="cb29-783"><a href="#cb29-783" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SegDataset(Dataset):</span>
<span id="cb29-784"><a href="#cb29-784" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, patches, masks):</span>
<span id="cb29-785"><a href="#cb29-785" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.patches <span class="op">=</span> patches</span>
<span id="cb29-786"><a href="#cb29-786" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.masks <span class="op">=</span> masks</span>
<span id="cb29-787"><a href="#cb29-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-788"><a href="#cb29-788" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb29-789"><a href="#cb29-789" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.patches)</span>
<span id="cb29-790"><a href="#cb29-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-791"><a href="#cb29-791" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb29-792"><a href="#cb29-792" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.patches[idx], <span class="va">self</span>.masks[idx]</span>
<span id="cb29-793"><a href="#cb29-793" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-794"><a href="#cb29-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-797"><a href="#cb29-797" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-798"><a href="#cb29-798" aria-hidden="true" tabindex="-1"></a><span class="co"># Create masks</span></span>
<span id="cb29-799"><a href="#cb29-799" aria-hidden="true" tabindex="-1"></a>train_masks <span class="op">=</span> create_seg_masks(patches[:n_train])</span>
<span id="cb29-800"><a href="#cb29-800" aria-hidden="true" tabindex="-1"></a>val_masks <span class="op">=</span> create_seg_masks(patches[n_train:n_train<span class="op">+</span>n_val])</span>
<span id="cb29-801"><a href="#cb29-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-802"><a href="#cb29-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-805"><a href="#cb29-805" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-806"><a href="#cb29-806" aria-hidden="true" tabindex="-1"></a>seg_train_loader <span class="op">=</span> DataLoader(SegDataset(patches[:n_train], train_masks), batch_size<span class="op">=</span><span class="dv">16</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-807"><a href="#cb29-807" aria-hidden="true" tabindex="-1"></a>seg_val_loader <span class="op">=</span> DataLoader(SegDataset(patches[n_train:n_train<span class="op">+</span>n_val], val_masks), batch_size<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb29-808"><a href="#cb29-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-809"><a href="#cb29-809" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="ss">f"Segmentation datasets ready"</span>)</span>
<span id="cb29-810"><a href="#cb29-810" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-811"><a href="#cb29-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-812"><a href="#cb29-812" aria-hidden="true" tabindex="-1"></a><span class="fu">### Train Segmentation</span></span>
<span id="cb29-813"><a href="#cb29-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-816"><a href="#cb29-816" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-817"><a href="#cb29-817" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/c03.py</span></span>
<span id="cb29-818"><a href="#cb29-818" aria-hidden="true" tabindex="-1"></a><span class="co">#| mode: append</span></span>
<span id="cb29-819"><a href="#cb29-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-820"><a href="#cb29-820" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_segmentation(model, train_loader, val_loader, epochs<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb29-821"><a href="#cb29-821" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train segmentation model."""</span></span>
<span id="cb29-822"><a href="#cb29-822" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="cb29-823"><a href="#cb29-823" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb29-824"><a href="#cb29-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-825"><a href="#cb29-825" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb29-826"><a href="#cb29-826" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb29-827"><a href="#cb29-827" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-828"><a href="#cb29-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-829"><a href="#cb29-829" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, masks <span class="kw">in</span> train_loader:</span>
<span id="cb29-830"><a href="#cb29-830" aria-hidden="true" tabindex="-1"></a>            images, masks <span class="op">=</span> images.to(device), masks.to(device)</span>
<span id="cb29-831"><a href="#cb29-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-832"><a href="#cb29-832" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb29-833"><a href="#cb29-833" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb29-834"><a href="#cb29-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-835"><a href="#cb29-835" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb29-836"><a href="#cb29-836" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb29-837"><a href="#cb29-837" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> outputs.output</span>
<span id="cb29-838"><a href="#cb29-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-839"><a href="#cb29-839" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(outputs, masks)</span>
<span id="cb29-840"><a href="#cb29-840" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb29-841"><a href="#cb29-841" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb29-842"><a href="#cb29-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-843"><a href="#cb29-843" aria-hidden="true" tabindex="-1"></a>            train_loss <span class="op">+=</span> loss.item()</span>
<span id="cb29-844"><a href="#cb29-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-845"><a href="#cb29-845" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">/=</span> <span class="bu">len</span>(train_loader)</span>
<span id="cb29-846"><a href="#cb29-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-847"><a href="#cb29-847" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validate</span></span>
<span id="cb29-848"><a href="#cb29-848" aria-hidden="true" tabindex="-1"></a>        model.<span class="bu">eval</span>()</span>
<span id="cb29-849"><a href="#cb29-849" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-850"><a href="#cb29-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-851"><a href="#cb29-851" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-852"><a href="#cb29-852" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> images, masks <span class="kw">in</span> val_loader:</span>
<span id="cb29-853"><a href="#cb29-853" aria-hidden="true" tabindex="-1"></a>                images, masks <span class="op">=</span> images.to(device), masks.to(device)</span>
<span id="cb29-854"><a href="#cb29-854" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> model(images)</span>
<span id="cb29-855"><a href="#cb29-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-856"><a href="#cb29-856" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb29-857"><a href="#cb29-857" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb29-858"><a href="#cb29-858" aria-hidden="true" tabindex="-1"></a>                    outputs <span class="op">=</span> outputs.output</span>
<span id="cb29-859"><a href="#cb29-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-860"><a href="#cb29-860" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> criterion(outputs, masks)</span>
<span id="cb29-861"><a href="#cb29-861" aria-hidden="true" tabindex="-1"></a>                val_loss <span class="op">+=</span> loss.item()</span>
<span id="cb29-862"><a href="#cb29-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-863"><a href="#cb29-863" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">/=</span> <span class="bu">len</span>(val_loader)</span>
<span id="cb29-864"><a href="#cb29-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-865"><a href="#cb29-865" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb29-866"><a href="#cb29-866" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: Train Loss=</span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss">, Val Loss=</span><span class="sc">{</span>val_loss<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb29-867"><a href="#cb29-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-868"><a href="#cb29-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-869"><a href="#cb29-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-870"><a href="#cb29-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-873"><a href="#cb29-873" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-874"><a href="#cb29-874" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training segmentation model..."</span>)</span>
<span id="cb29-875"><a href="#cb29-875" aria-hidden="true" tabindex="-1"></a>train_segmentation(seg_model, seg_train_loader, seg_val_loader, epochs<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb29-876"><a href="#cb29-876" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-877"><a href="#cb29-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-878"><a href="#cb29-878" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize output and accuracy</span></span>
<span id="cb29-879"><a href="#cb29-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-882"><a href="#cb29-882" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-883"><a href="#cb29-883" aria-hidden="true" tabindex="-1"></a><span class="co"># | tangle: geogfm/c03.py</span></span>
<span id="cb29-884"><a href="#cb29-884" aria-hidden="true" tabindex="-1"></a><span class="co"># | mode: append</span></span>
<span id="cb29-885"><a href="#cb29-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-886"><a href="#cb29-886" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_accuracy(model, data_loader, device_name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb29-887"><a href="#cb29-887" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute pixelwise accuracy for segmentation"""</span></span>
<span id="cb29-888"><a href="#cb29-888" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> device_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb29-889"><a href="#cb29-889" aria-hidden="true" tabindex="-1"></a>        device_name <span class="op">=</span> device</span>
<span id="cb29-890"><a href="#cb29-890" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb29-891"><a href="#cb29-891" aria-hidden="true" tabindex="-1"></a>    correct, total <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb29-892"><a href="#cb29-892" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-893"><a href="#cb29-893" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, masks <span class="kw">in</span> data_loader:</span>
<span id="cb29-894"><a href="#cb29-894" aria-hidden="true" tabindex="-1"></a>            images, masks <span class="op">=</span> images.to(device_name), masks.to(device_name)</span>
<span id="cb29-895"><a href="#cb29-895" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb29-896"><a href="#cb29-896" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract tensor from ModelOutput if needed</span></span>
<span id="cb29-897"><a href="#cb29-897" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb29-898"><a href="#cb29-898" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> outputs.output</span>
<span id="cb29-899"><a href="#cb29-899" aria-hidden="true" tabindex="-1"></a>            preds <span class="op">=</span> torch.argmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-900"><a href="#cb29-900" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> (preds <span class="op">==</span> masks).<span class="bu">sum</span>().item()</span>
<span id="cb29-901"><a href="#cb29-901" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> masks.numel()</span>
<span id="cb29-902"><a href="#cb29-902" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb29-903"><a href="#cb29-903" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> accuracy</span>
<span id="cb29-904"><a href="#cb29-904" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-905"><a href="#cb29-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-908"><a href="#cb29-908" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-909"><a href="#cb29-909" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute accuracy on validation data</span></span>
<span id="cb29-910"><a href="#cb29-910" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> get_accuracy(seg_model, seg_val_loader)</span>
<span id="cb29-911"><a href="#cb29-911" aria-hidden="true" tabindex="-1"></a>logger.info(</span>
<span id="cb29-912"><a href="#cb29-912" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Segmentation Model Pixel Accuracy on Validation Data: </span><span class="sc">{</span>accuracy<span class="sc">:.3%}</span><span class="ss">"</span>)</span>
<span id="cb29-913"><a href="#cb29-913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-914"><a href="#cb29-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-917"><a href="#cb29-917" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-918"><a href="#cb29-918" aria-hidden="true" tabindex="-1"></a><span class="co"># | tangle: geogfm/c03.py</span></span>
<span id="cb29-919"><a href="#cb29-919" aria-hidden="true" tabindex="-1"></a><span class="co"># | mode: append</span></span>
<span id="cb29-920"><a href="#cb29-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-921"><a href="#cb29-921" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_predictions(model, data_loader, device_name<span class="op">=</span><span class="va">None</span>, n<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb29-922"><a href="#cb29-922" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> device_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb29-923"><a href="#cb29-923" aria-hidden="true" tabindex="-1"></a>        device_name <span class="op">=</span> device</span>
<span id="cb29-924"><a href="#cb29-924" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb29-925"><a href="#cb29-925" aria-hidden="true" tabindex="-1"></a>    images, masks <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(data_loader))</span>
<span id="cb29-926"><a href="#cb29-926" aria-hidden="true" tabindex="-1"></a>    images, masks <span class="op">=</span> images.to(device_name), masks.to(device_name)</span>
<span id="cb29-927"><a href="#cb29-927" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb29-928"><a href="#cb29-928" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(images)</span>
<span id="cb29-929"><a href="#cb29-929" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(outputs, <span class="st">'output'</span>):</span>
<span id="cb29-930"><a href="#cb29-930" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> outputs.output</span>
<span id="cb29-931"><a href="#cb29-931" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> torch.argmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-932"><a href="#cb29-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-933"><a href="#cb29-933" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose up to n samples to show</span></span>
<span id="cb29-934"><a href="#cb29-934" aria-hidden="true" tabindex="-1"></a>    num_show <span class="op">=</span> <span class="bu">min</span>(n, images.shape[<span class="dv">0</span>])</span>
<span id="cb29-935"><a href="#cb29-935" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_show):</span>
<span id="cb29-936"><a href="#cb29-936" aria-hidden="true" tabindex="-1"></a>        fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb29-937"><a href="#cb29-937" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Display RGB composite from the image</span></span>
<span id="cb29-938"><a href="#cb29-938" aria-hidden="true" tabindex="-1"></a>        img_np <span class="op">=</span> images[i].cpu()</span>
<span id="cb29-939"><a href="#cb29-939" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> img_np.shape[<span class="dv">0</span>] <span class="op">&gt;=</span> <span class="dv">3</span>:</span>
<span id="cb29-940"><a href="#cb29-940" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For 6-band Sentinel-2: bands are [Blue, Green, Red, NIR, SWIR1, SWIR2]</span></span>
<span id="cb29-941"><a href="#cb29-941" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Select first 3 bands (Blue, Green, Red) and reorder to RGB</span></span>
<span id="cb29-942"><a href="#cb29-942" aria-hidden="true" tabindex="-1"></a>            rgb <span class="op">=</span> torch.stack([img_np[<span class="dv">2</span>], img_np[<span class="dv">1</span>], img_np[<span class="dv">0</span>]], dim<span class="op">=</span><span class="dv">0</span>)  <span class="co"># R, G, B</span></span>
<span id="cb29-943"><a href="#cb29-943" aria-hidden="true" tabindex="-1"></a>            rgb <span class="op">=</span> rgb.permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)  <span class="co"># (H, W, C)</span></span>
<span id="cb29-944"><a href="#cb29-944" aria-hidden="true" tabindex="-1"></a>            axs[<span class="dv">0</span>].imshow(rgb)</span>
<span id="cb29-945"><a href="#cb29-945" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb29-946"><a href="#cb29-946" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Single band image - show as grayscale</span></span>
<span id="cb29-947"><a href="#cb29-947" aria-hidden="true" tabindex="-1"></a>            axs[<span class="dv">0</span>].imshow(img_np[<span class="dv">0</span>], cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb29-948"><a href="#cb29-948" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">0</span>].set_title(<span class="st">'Input Image'</span>)</span>
<span id="cb29-949"><a href="#cb29-949" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb29-950"><a href="#cb29-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-951"><a href="#cb29-951" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">1</span>].imshow(masks[i].cpu(), cmap<span class="op">=</span><span class="st">'tab20'</span>)</span>
<span id="cb29-952"><a href="#cb29-952" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">1</span>].set_title(<span class="st">'Ground Truth Mask'</span>)</span>
<span id="cb29-953"><a href="#cb29-953" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb29-954"><a href="#cb29-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-955"><a href="#cb29-955" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">2</span>].imshow(preds[i].cpu(), cmap<span class="op">=</span><span class="st">'tab20'</span>)</span>
<span id="cb29-956"><a href="#cb29-956" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">2</span>].set_title(<span class="st">'Predicted Mask'</span>)</span>
<span id="cb29-957"><a href="#cb29-957" aria-hidden="true" tabindex="-1"></a>        axs[<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb29-958"><a href="#cb29-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-959"><a href="#cb29-959" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb29-960"><a href="#cb29-960" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb29-961"><a href="#cb29-961" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-962"><a href="#cb29-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-965"><a href="#cb29-965" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb29-966"><a href="#cb29-966" aria-hidden="true" tabindex="-1"></a>visualize_predictions(seg_model, seg_val_loader, n<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb29-967"><a href="#cb29-967" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-968"><a href="#cb29-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-969"><a href="#cb29-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-970"><a href="#cb29-970" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparing Backbones</span></span>
<span id="cb29-971"><a href="#cb29-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-972"><a href="#cb29-972" aria-hidden="true" tabindex="-1"></a>TerraTorch makes it easy to compare different foundation models.</span>
<span id="cb29-973"><a href="#cb29-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-974"><a href="#cb29-974" aria-hidden="true" tabindex="-1"></a>**Available backbones in TerraTorch (examples):**</span>
<span id="cb29-975"><a href="#cb29-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-976"><a href="#cb29-976" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`prithvi_eo_v1_100`</span> <span class="dv">&amp;mdash;</span> Prithvi 100M parameter model  </span>
<span id="cb29-977"><a href="#cb29-977" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`prithvi_eo_v1_300`</span> <span class="dv">&amp;mdash;</span> Prithvi 300M parameter model  </span>
<span id="cb29-978"><a href="#cb29-978" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`prithvi_eo_v2_300`</span> <span class="dv">&amp;mdash;</span> Prithvi V2 300M model  </span>
<span id="cb29-979"><a href="#cb29-979" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`timm_resnet50`</span> <span class="dv">&amp;mdash;</span> ResNet-50 from timm  </span>
<span id="cb29-980"><a href="#cb29-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-981"><a href="#cb29-981" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb29-982"><a href="#cb29-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-983"><a href="#cb29-983" aria-hidden="true" tabindex="-1"></a>**To use a different backbone, you can build your model like this:**</span>
<span id="cb29-984"><a href="#cb29-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-985"><a href="#cb29-985" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb29-986"><a href="#cb29-986" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_factory.build_model(</span>
<span id="cb29-987"><a href="#cb29-987" aria-hidden="true" tabindex="-1"></a>    task<span class="op">=</span><span class="st">'classification'</span>,</span>
<span id="cb29-988"><a href="#cb29-988" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">'prithvi_eo_v2_300'</span>,</span>
<span id="cb29-989"><a href="#cb29-989" aria-hidden="true" tabindex="-1"></a>    decoder<span class="op">=</span><span class="st">'FCNDecoder'</span>,</span>
<span id="cb29-990"><a href="#cb29-990" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="dv">3</span></span>
<span id="cb29-991"><a href="#cb29-991" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-992"><a href="#cb29-992" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-993"><a href="#cb29-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-994"><a href="#cb29-994" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Takeaways</span></span>
<span id="cb29-995"><a href="#cb29-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-996"><a href="#cb29-996" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**TerraTorch simplifies model loading**: One API for multiple foundation models</span>
<span id="cb29-997"><a href="#cb29-997" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Task flexibility**: Same backbone for classification, segmentation, etc.</span>
<span id="cb29-998"><a href="#cb29-998" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Model comparison**: Easy to swap backbones</span>
<span id="cb29-999"><a href="#cb29-999" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Production ready**: Built for real-world geospatial applications</span>
<span id="cb29-1000"><a href="#cb29-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-1001"><a href="#cb29-1001" aria-hidden="true" tabindex="-1"></a><span class="fu">## Resources</span></span>
<span id="cb29-1002"><a href="#cb29-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-1003"><a href="#cb29-1003" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">TerraTorch GitHub</span><span class="co">](https://github.com/IBM/terratorch)</span></span>
<span id="cb29-1004"><a href="#cb29-1004" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Prithvi Models</span><span class="co">](https://huggingface.co/ibm-nasa-geospatial)</span></span>
<span id="cb29-1005"><a href="#cb29-1005" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Model Zoo</span><span class="co">](https://github.com/IBM/terratorch/blob/main/MODEL_ZOO.md)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/geog-logo.png" class="img-fluid figure-img" width="250"></p>
<figcaption>Department of Geography logo</figcaption>
</figure>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This website is built with <a href="https://github.com/kcaylor/GEOG-288KC-geospatial-foundation-models"><i class="fa-brands fa-github" title="the github octocat logo" aria-label="github"></i></a> and <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>